<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –ø–µ—Ä–∏–æ–¥–∞ | Mos-GSM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --yellow: #F3C04D;
            --yellow-light: #f8d77e;
            --yellow-dark: #d4a63d;
            --black: #1A1A1A;
            --gray-dark: #4D4D4D;
            --gray: #D9D9D9;
            --gray-light: #F5F5F5;
            --white: #FFFFFF;
            --green: #2E7D32;
            --green-light: #4CAF50;
            --orange: #F57C00;
            --red: #D32F2F;
            --blue: #1565C0;
            --shadow-soft: 0 8px 32px rgba(26, 26, 26, 0.08);
            --shadow-medium: 0 12px 48px rgba(26, 26, 26, 0.12);
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 28px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--gray-light);
            color: var(--black);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 16px 32px;
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 32px;
        }

        .logo-bar {
            width: 6px;
            background: var(--yellow);
            border-radius: 3px;
        }

        .logo-bar:nth-child(1) { height: 8px; }
        .logo-bar:nth-child(2) { height: 14px; }
        .logo-bar:nth-child(3) { height: 20px; }
        .logo-bar:nth-child(4) { height: 26px; }
        .logo-bar:nth-child(5) { height: 32px; }

        .logo-text {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: var(--black);
        }

        .nav { display: flex; gap: 8px; }

        .nav-link {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 500;
            font-size: 15px;
            color: var(--gray-dark);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-link:hover { background: var(--gray-light); color: var(--black); }
        .nav-link.active { background: var(--yellow); color: var(--black); }

        /* Main */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 32px;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title-section h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            color: var(--black);
            line-height: 1;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--gray-dark);
            margin-top: 8px;
        }

        .page-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        /* Buttons */
        .btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 14px;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            color: var(--black);
            box-shadow: 0 6px 20px rgba(243, 192, 77, 0.4);
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(243, 192, 77, 0.5); }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--gray);
        }

        .btn-secondary:hover { border-color: var(--yellow); background: rgba(243, 192, 77, 0.1); }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: var(--white);
        }

        .btn-download {
            background: linear-gradient(135deg, var(--green-light) 0%, var(--green) 100%);
            color: var(--white);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-download:hover { transform: translateY(-2px); }

        /* Version Tabs */
        .version-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .version-tab {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 500;
            font-size: 14px;
            padding: 12px 20px;
            border-radius: 24px;
            background: var(--white);
            border: 2px solid var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .version-tab:hover { border-color: var(--yellow); }
        .version-tab.active { background: var(--yellow); border-color: var(--yellow); }
        .version-tab .date { font-size: 11px; opacity: 0.7; margin-top: 2px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stats-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            text-align: center;
        }

        .stats-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            color: var(--black);
            line-height: 1;
        }

        .stats-value.green { color: var(--green); }
        .stats-value.orange { color: var(--orange); }

        .stats-label {
            font-size: 12px;
            color: var(--gray-dark);
            margin-top: 8px;
            text-transform: uppercase;
        }

        /* Card */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 28px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
        }

        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--black);
        }

        .card-body { padding: 28px; }

        /* Download Section */
        .download-section {
            background: linear-gradient(135deg, var(--gray-light) 0%, #E8E8E8 100%);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 24px;
        }

        .download-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 16px;
            color: var(--black);
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        .download-buttons { display: flex; gap: 16px; flex-wrap: wrap; }

        /* Workers Grid */
        .workers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .worker-card {
            background: var(--gray-light);
            border-radius: var(--radius-md);
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .worker-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
            border-color: var(--yellow);
        }

        .worker-name {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: var(--black);
            margin-bottom: 16px;
        }

        .worker-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .worker-amount {
            padding: 14px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .worker-amount.company { background: #E8F5E9; }
        .worker-amount.client { background: #FFF3E0; }

        .worker-amount-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            line-height: 1;
        }

        .worker-amount.company .worker-amount-value { color: var(--green); }
        .worker-amount.client .worker-amount-value { color: var(--orange); }

        .worker-amount-label {
            font-size: 11px;
            color: var(--gray-dark);
            margin-top: 4px;
            text-transform: uppercase;
        }

        .worker-total-row {
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            padding-top: 16px;
            border-top: 2px solid var(--gray);
        }

        .worker-total-label { font-size: 14px; color: var(--gray-dark); }

        .worker-total-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--black);
        }

        /* Grand Totals */
        .grand-totals {
            margin-top: 32px;
            padding: 24px;
            background: linear-gradient(135deg, var(--black) 0%, var(--gray-dark) 100%);
            border-radius: var(--radius-md);
        }

        .grand-totals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .grand-total-item { text-align: center; }

        .grand-total-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--white);
            line-height: 1;
        }

        .grand-total-item.company .grand-total-value { color: #81C784; }
        .grand-total-item.client .grand-total-value { color: #FFB74D; }

        .grand-total-label {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            margin-top: 8px;
        }

        /* Changes */
        .changes-list { display: flex; flex-direction: column; gap: 12px; }

        .change-item {
            padding: 16px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .change-item.added { background: #E8F5E9; border-left: 4px solid var(--green); }
        .change-item.deleted { background: #FFEBEE; border-left: 4px solid var(--red); }
        .change-item.modified { background: #FFF8E1; border-left: 4px solid var(--yellow); }

        .change-icon { font-size: 20px; }
        .change-text { flex: 1; }
        .change-header { font-weight: 600; color: var(--black); }
        .change-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }
        .change-field { font-size: 13px; color: var(--gray-dark); margin-top: 6px; }

        .change-details { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

        .detail-tag {
            background: rgba(0,0,0,0.08);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Manual Edits */
        .manual-edit-item {
            background: #E3F2FD;
            border-left: 4px solid var(--blue);
            padding: 16px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .edit-icon { font-size: 20px; }
        .edit-content { flex: 1; }
        .edit-header { font-weight: 600; color: var(--black); }
        .edit-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }

        .edit-change {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .edit-change.fuel { background: #FFF8E1; color: #F57F17; }
        .edit-change.transport { background: #E8F5E9; color: var(--green); }
        .edit-change.total { background: #E3F2FD; color: var(--blue); }

        .edit-time { font-size: 11px; color: var(--gray-dark); margin-top: 6px; }

        /* No Changes */
        .no-changes {
            background: #E8F5E9;
            color: var(--green);
            padding: 20px;
            border-radius: var(--radius-sm);
            text-align: center;
            font-weight: 500;
        }

        /* Loading */
        .loading { text-align: center; padding: 60px; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grand-totals-grid { grid-template-columns: 1fr; gap: 16px; }
        }

        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .main { padding: 24px 16px; }
            .page-title-section h1 { font-size: 36px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .workers-grid { grid-template-columns: 1fr; }
            .nav { display: none; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link active">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
        </nav>
    </header>

    <!-- Main -->
    <main class="main">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title-section">
                <h1 id="pageTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p class="page-subtitle" id="pageSubtitle"></p>
            </div>
            <div class="page-actions">
                <a href="/history" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    –ò—Å—Ç–æ—Ä–∏—è
                </a>
                <a href="/" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç
                </a>
            </div>
        </div>

        <!-- Content -->
        <div id="content">
            <div class="card">
                <div class="card-body">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const periodId = {{ period_id }};
        let currentUploadId = null;
        let uploadsData = [];

        async function loadPeriod() {
            try {
                const response = await fetch(`/api/period/${periodId}`);
                const data = await response.json();

                if (!data.success) throw new Error(data.error || 'Failed to load');

                document.getElementById('pageTitle').textContent = data.data.period.name;
                document.getElementById('pageSubtitle').textContent = `–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã`;
                uploadsData = data.data.uploads;

                if (uploadsData.length > 0) {
                    currentUploadId = uploadsData[0].id;
                    renderContent();
                } else {
                    document.getElementById('content').innerHTML = `
                        <div class="card"><div class="card-body"><p>–ù–µ—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞</p></div></div>
                    `;
                }
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="card"><div class="card-body"><p>‚ùå –û—à–∏–±–∫–∞: ${error.message}</p></div></div>
                `;
            }
        }

        async function renderContent() {
            // Version tabs
            let tabsHtml = '<div class="version-tabs">';
            uploadsData.forEach(upload => {
                const isActive = upload.id === currentUploadId ? 'active' : '';
                const date = upload.created_at ? new Date(upload.created_at).toLocaleString('ru-RU') : '';
                tabsHtml += `
                    <div class="version-tab ${isActive}" onclick="selectUpload(${upload.id})">
                        –í–µ—Ä—Å–∏—è ${upload.version}
                        <div class="date">${date}</div>
                    </div>
                `;
            });
            tabsHtml += '</div>';

            // Load upload details
            const response = await fetch(`/api/upload/${currentUploadId}`);
            const data = await response.json();

            if (!data.success) {
                document.getElementById('content').innerHTML = tabsHtml + `<div class="card"><div class="card-body"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div></div>`;
                return;
            }

            const upload = data.data;
            const workerTotals = upload.worker_totals || [];
            const changes = upload.changes || [];
            const manualEdits = upload.manual_edits || [];

            // Calculate totals
            const grandTotal = workerTotals.reduce((sum, w) => sum + (w.total_amount || 0), 0);
            const grandCompany = workerTotals.reduce((sum, w) => sum + (w.company_amount || 0), 0);
            const grandClient = workerTotals.reduce((sum, w) => sum + (w.client_amount || 0), 0);
            const totalOrders = workerTotals.reduce((sum, w) => sum + (w.orders_count || 0), 0);
            const companyOrders = workerTotals.reduce((sum, w) => sum + (w.company_orders_count || 0), 0);
            const clientOrders = workerTotals.reduce((sum, w) => sum + (w.client_orders_count || 0), 0);

            // Stats grid
            let statsHtml = `
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-value">${workerTotals.length}</div>
                        <div class="stats-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value green">${formatCurrency(grandCompany)}</div>
                        <div class="stats-label">–ö–æ–º–ø–∞–Ω–∏—è (${companyOrders})</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value orange">${formatCurrency(grandClient)}</div>
                        <div class="stats-label">–ö–ª–∏–µ–Ω—Ç (${clientOrders})</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">${formatCurrency(grandTotal)}</div>
                        <div class="stats-label">–ò—Ç–æ–≥–æ (${totalOrders})</div>
                    </div>
                </div>
            `;

            // Download section
            let downloadHtml = `
                <div class="download-section">
                    <div class="download-title">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</div>
                    <div class="download-buttons">
                        <a href="/api/period/${periodId}/download/full" class="btn btn-download">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç
                        </a>
                        <a href="/api/period/${periodId}/download/workers" class="btn btn-secondary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            –î–ª—è –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤
                        </a>
                    </div>
                </div>
            `;

            // Workers grid
            let workersHtml = '<div class="workers-grid">';
            workerTotals.forEach(wt => {
                const companyAmt = wt.company_amount || 0;
                const clientAmt = wt.client_amount || 0;
                const totalAmt = wt.total_amount || 0;
                const companyOrd = wt.company_orders_count || 0;
                const clientOrd = wt.client_orders_count || 0;

                workersHtml += `
                    <div class="worker-card" onclick="viewWorker('${encodeURIComponent(wt.worker)}')">
                        <div class="worker-name">üë∑ ${wt.worker}</div>
                        <div class="worker-amounts">
                            <div class="worker-amount company">
                                <div class="worker-amount-value">${Math.round(companyAmt).toLocaleString('ru-RU')}</div>
                                <div class="worker-amount-label">–ö–æ–º–ø–∞–Ω–∏—è (${companyOrd})</div>
                            </div>
                            <div class="worker-amount client">
                                <div class="worker-amount-value">${Math.round(clientAmt).toLocaleString('ru-RU')}</div>
                                <div class="worker-amount-label">–ö–ª–∏–µ–Ω—Ç (${clientOrd})</div>
                            </div>
                        </div>
                        <div class="worker-total-row">
                            <span class="worker-total-label">–ò—Ç–æ–≥–æ:</span>
                            <span class="worker-total-value">${Math.round(totalAmt).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    </div>
                `;
            });
            workersHtml += '</div>';

            // Grand totals
            workersHtml += `
                <div class="grand-totals">
                    <div class="grand-totals-grid">
                        <div class="grand-total-item company">
                            <div class="grand-total-value">${Math.round(grandCompany).toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="grand-total-label">üè¢ –ö–æ–º–ø–∞–Ω–∏—è (${companyOrders} –∑–∞–∫–∞–∑–æ–≤)</div>
                        </div>
                        <div class="grand-total-item client">
                            <div class="grand-total-value">${Math.round(grandClient).toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="grand-total-label">üë§ –ö–ª–∏–µ–Ω—Ç (${clientOrders} –∑–∞–∫–∞–∑–æ–≤)</div>
                        </div>
                        <div class="grand-total-item total">
                            <div class="grand-total-value">${Math.round(grandTotal).toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="grand-total-label">üí∞ –û–±—â–∏–π –∏—Ç–æ–≥ (${totalOrders} –∑–∞–∫–∞–∑–æ–≤)</div>
                        </div>
                    </div>
                </div>
            `;

            // Changes
            let changesHtml = '';
            if (changes.length > 0) {
                changesHtml = '<div class="card"><div class="card-header"><h3 class="card-title">üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è</h3></div><div class="card-body"><div class="changes-list">';
                
                const formatNum = (n) => n ? Math.round(n).toLocaleString('ru-RU') : '';

                changes.forEach(change => {
                    const icons = { added: '‚ûï', deleted: '‚ûñ', modified: '‚úèÔ∏è' };
                    const icon = icons[change.change_type] || '‚Ä¢';

                    let addressHtml = change.address ? `<div class="change-address">üìç ${change.address}</div>` : '';

                    let details = [];
                    if (change.revenue_total > 0) details.push(`–í—ã—Ä—É—á–∫–∞: ${formatNum(change.revenue_total)}`);
                    if (change.revenue_services) details.push(`–û—Ç —É—Å–ª—É–≥: ${formatNum(change.revenue_services)}`);
                    if (change.service_payment) details.push(`–û–ø–ª–∞—Ç–∞: ${formatNum(change.service_payment)}`);
                    if (change.percent) details.push(`${Math.round(parseFloat(change.percent) || 0)}%`);
                    
                    let detailsHtml = details.length > 0 ? 
                        `<div class="change-details">${details.map(d => `<span class="detail-tag">${d}</span>`).join('')}</div>` : '';

                    let fieldInfo = change.change_type === 'modified' && change.field_name ?
                        `<div class="change-field">${change.field_name}: ${change.old_value} ‚Üí ${change.new_value}</div>` : '';

                    changesHtml += `
                        <div class="change-item ${change.change_type}">
                            <span class="change-icon">${icon}</span>
                            <div class="change-text">
                                <div class="change-header">${change.order_code} - ${change.worker}</div>
                                ${addressHtml}
                                ${detailsHtml}
                                ${fieldInfo}
                            </div>
                        </div>
                    `;
                });
                changesHtml += '</div></div></div>';
            } else if (uploadsData.length > 1) {
                changesHtml = '<div class="card"><div class="card-body"><div class="no-changes">‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç</div></div></div>';
            }

            // Manual edits
            let editsHtml = '';
            if (manualEdits.length > 0) {
                editsHtml = '<div class="card"><div class="card-header"><h3 class="card-title">‚úèÔ∏è –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h3></div><div class="card-body"><div class="changes-list">';

                const fieldLabels = { fuel_payment: '–ë–µ–Ω–∑–∏–Ω', transport: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ', total: '–ò—Ç–æ–≥–æ' };
                const fieldClasses = { fuel_payment: 'fuel', transport: 'transport', total: 'total' };

                manualEdits.forEach(edit => {
                    const fieldLabel = fieldLabels[edit.field_name] || edit.field_name;
                    const fieldClass = fieldClasses[edit.field_name] || '';
                    const worker = edit.worker.replace(' (–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º)', '');
                    const oldVal = Math.round(edit.old_value || 0).toLocaleString('ru-RU');
                    const newVal = Math.round(edit.new_value || 0).toLocaleString('ru-RU');
                    
                    let addressHtml = edit.address ? `<div class="edit-address">üìç ${edit.address}</div>` : '';
                    let timeHtml = edit.created_at ? `<div class="edit-time">${new Date(edit.created_at).toLocaleString('ru-RU')}</div>` : '';

                    editsHtml += `
                        <div class="manual-edit-item">
                            <span class="edit-icon">‚úèÔ∏è</span>
                            <div class="edit-content">
                                <div class="edit-header">${edit.order_code || ''} - ${worker}</div>
                                ${addressHtml}
                                <div class="edit-change ${fieldClass}">${fieldLabel}: ${oldVal} ‚Üí ${newVal} ‚ÇΩ</div>
                                ${timeHtml}
                            </div>
                        </div>
                    `;
                });
                editsHtml += '</div></div></div>';
            }

            document.getElementById('content').innerHTML = `
                ${tabsHtml}
                ${statsHtml}
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üë• –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏</h3></div>
                    <div class="card-body">
                        ${downloadHtml}
                        ${workersHtml}
                    </div>
                </div>
                ${changesHtml}
                ${editsHtml}
            `;
        }

        function selectUpload(uploadId) {
            currentUploadId = uploadId;
            renderContent();
        }

        function viewWorker(workerEncoded) {
            window.location.href = `/upload/${currentUploadId}?worker=${workerEncoded}`;
        }

        function formatCurrency(value) {
            if (value >= 1000000) return (value / 1000000).toFixed(1) + '–ú';
            if (value >= 1000) return Math.round(value / 1000) + '–ö';
            return Math.round(value).toString();
        }

        window.addEventListener('focus', loadPeriod);
        window.addEventListener('pageshow', (e) => { if (e.persisted) loadPeriod(); });

        loadPeriod();
    </script>
</body>
</html>
