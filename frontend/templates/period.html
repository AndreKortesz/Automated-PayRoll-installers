<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>–î–µ—Ç–∞–ª–∏ –ø–µ—Ä–∏–æ–¥–∞ | Mos-GSM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/security.js"></script>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 20px; }
        .page-title-section h1 { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--black); line-height: 1; }
        .page-subtitle { font-size: 16px; color: var(--gray-dark); margin-top: 8px; }
        .page-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        
        /* Status badge */
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 14px; text-transform: uppercase; }
        .status-badge.draft { background: #E3F2FD; color: #1565C0; }
        .status-badge.sent { background: #FFF3E0; color: #EF6C00; }
        .status-badge.paid { background: #E8F5E9; color: #2E7D32; }
        .status-badge.locked { background: #FFEBEE; color: #C62828; }
        
        /* Action buttons */
        .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; margin-bottom: 24px; }
        .btn-send { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; }
        .btn-send:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
        .btn-accountant { background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; }
        .btn-accountant:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .btn-unlock { background: linear-gradient(135deg, #9E9E9E 0%, #616161 100%); color: white; }
        .btn-unlock:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        
        /* Permission notice */
        .permission-notice { background: #FFF3E0; border-left: 4px solid #FF9800; padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 20px; font-size: 14px; color: #E65100; }
        .permission-notice.error { background: #FFEBEE; border-color: #F44336; color: #C62828; }
        
        .version-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .version-tab { font-family: 'Roboto Condensed', sans-serif; font-weight: 500; font-size: 14px; padding: 12px 20px; border-radius: 24px; background: var(--white); border: 2px solid var(--gray); cursor: pointer; transition: all 0.2s; }
        .version-tab:hover { border-color: var(--yellow); }
        .version-tab.active { background: var(--yellow); border-color: var(--yellow); }
        .version-tab .date { font-size: 11px; opacity: 0.7; margin-top: 2px; }
        .download-section { background: linear-gradient(135deg, var(--gray-light) 0%, #E8E8E8 100%); border-radius: var(--radius-md); padding: 24px; margin-bottom: 24px; }
        .download-title { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 16px; color: var(--black); margin-bottom: 16px; text-transform: uppercase; }
        .download-buttons { display: flex; gap: 16px; flex-wrap: wrap; }
        .btn-download { background: linear-gradient(135deg, var(--green-light) 0%, var(--green) 100%); color: var(--white); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3); }
        .btn-download:hover { transform: translateY(-2px); }
        .workers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .worker-card { background: var(--gray-light); border-radius: var(--radius-md); padding: 24px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .worker-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); border-color: var(--yellow); }
        .worker-name { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--black); margin-bottom: 16px; }
        .worker-amounts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .worker-amount { padding: 14px; border-radius: var(--radius-sm); text-align: center; }
        .worker-amount.company { background: #E8F5E9; }
        .worker-amount.client { background: #FFF3E0; }
        .worker-amount-value { font-family: 'Bebas Neue', sans-serif; font-size: 24px; line-height: 1; }
        .worker-amount.company .worker-amount-value { color: var(--green); }
        .worker-amount.client .worker-amount-value { color: var(--orange); }
        .worker-amount-label { font-size: 11px; color: var(--gray-dark); margin-top: 4px; text-transform: uppercase; }
        .worker-total-row { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 2px solid var(--gray); }
        .worker-total-label { font-size: 14px; color: var(--gray-dark); }
        .worker-total-value { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--black); }
        .grand-totals { margin-top: 32px; padding: 24px; background: linear-gradient(135deg, var(--black) 0%, var(--gray-dark) 100%); border-radius: var(--radius-md); }
        .grand-totals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grand-total-item { text-align: center; }
        .grand-total-value { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--white); line-height: 1; }
        .grand-total-item.company .grand-total-value { color: #81C784; }
        .grand-total-item.client .grand-total-value { color: #FFB74D; }
        .grand-total-label { font-size: 13px; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .changes-list { display: flex; flex-direction: column; gap: 12px; }
        .change-item { padding: 16px; border-radius: var(--radius-sm); display: flex; align-items: flex-start; gap: 12px; }
        .change-item.added { background: #E8F5E9; border-left: 4px solid var(--green); }
        .change-item.deleted { background: #FFEBEE; border-left: 4px solid var(--red); }
        .change-item.modified { background: #FFF8E1; border-left: 4px solid var(--yellow); }
        .change-icon { font-size: 20px; }
        .change-text { flex: 1; }
        .change-header { font-weight: 600; color: var(--black); }
        .change-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }
        .change-field { font-size: 13px; color: var(--gray-dark); margin-top: 6px; }
        .change-details { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .detail-tag { background: rgba(0,0,0,0.08); padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .manual-edit-item { background: #E3F2FD; border-left: 4px solid var(--blue); padding: 16px; border-radius: var(--radius-sm); display: flex; align-items: flex-start; gap: 12px; }
        .edit-content { flex: 1; }
        .edit-header { font-weight: 600; color: var(--black); }
        .edit-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }
        .edit-change { display: inline-block; margin-top: 8px; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; }
        .edit-change.fuel { background: #FFF8E1; color: #F57F17; }
        .edit-change.transport { background: #E8F5E9; color: var(--green); }
        .edit-change.total { background: #E3F2FD; color: var(--blue); }
        .edit-time { font-size: 11px; color: var(--gray-dark); margin-top: 6px; }
        .no-changes { background: #E8F5E9; color: var(--green); padding: 20px; border-radius: var(--radius-sm); text-align: center; font-weight: 500; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 16px; }
        .modal-content { margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .worker-checkbox { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-light); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .worker-checkbox:hover { background: var(--gray); }
        .worker-checkbox input { width: 20px; height: 20px; }
        .worker-checkbox-info { flex: 1; }
        .worker-checkbox-name { font-weight: 600; }
        .worker-checkbox-amount { font-size: 13px; color: var(--gray-dark); }
        
        @media (max-width: 1024px) { .grand-totals-grid { grid-template-columns: 1fr; gap: 16px; } }
        @media (max-width: 768px) { .page-title-section h1 { font-size: 36px; } .workers-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link active">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
            {% if user and user.role == 'admin' %}<a href="/duplicates" class="nav-link">–î—É–±–ª–∏</a>{% endif %}
        </nav>
        
        <!-- Search Component -->
        <div class="search-wrapper">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤..." autocomplete="off">
            </div>
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        
        {% if user %}
        <div class="user-info">
            <span class="user-name">
                {% if user.role == 'admin' %}üëë{% else %}üë§{% endif %}
                {{ user.name | e }}
            </span>
            <span class="user-role {% if user.role == 'admin' %}role-admin{% else %}role-employee{% endif %}">
                {{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if user.role == 'admin' else '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}
            </span>
            <a href="/auth/logout" class="logout-btn" title="–í—ã–π—Ç–∏">
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </a>
        </div>
        {% endif %}
    </header>

    <main class="main">
        <div class="page-header">
            <div class="page-title-section">
                <h1 id="pageTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p class="page-subtitle" id="pageSubtitle"></p>
                <div id="statusBadge"></div>
            </div>
            <div class="page-actions">
                <a href="/history" class="btn btn-secondary">‚Üê –ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="/" class="btn btn-primary">+ –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</a>
            </div>
        </div>
        
        <!-- Permission notice -->
        <div id="permissionNotice" class="permission-notice" style="display: none;"></div>
        
        <!-- Action buttons -->
        <div id="actionButtons" class="action-buttons" style="display: none;"></div>
        
        <div id="content">
            <div class="card"><div class="card-body"><div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div></div></div>
        </div>
    </main>
    
    <!-- Send to Workers Modal -->
    <div id="sendWorkersModal" class="modal-overlay">
        <div class="modal">
            <h2 class="modal-title">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞–º</h2>
            <div class="modal-content">
                <p style="margin-bottom: 16px; color: var(--gray-dark);">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–æ–≤ –≤ Bitrix24 —á–∞—Ç:</p>
                <div id="workersCheckboxList"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('sendWorkersModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-send" onclick="confirmSendToWorkers()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- Send to Accountant Modal -->
    <div id="sendAccountantModal" class="modal-overlay">
        <div class="modal">
            <h2 class="modal-title">üí∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É</h2>
            <div class="modal-content">
                <p style="margin-bottom: 16px; color: var(--gray-dark);">–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.</p>
                <div id="paymentSummary"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('sendAccountantModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-accountant" onclick="confirmSendToAccountant()">üí∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const periodId = parseInt('{{ period_id }}', 10);
        let currentUploadId = null;
        let uploadsData = [];
        let permissions = {};
        let workerTotalsData = [];

        async function loadPeriod() {
            try {
                // Load permissions first
                const permResponse = await Security.fetch(`/api/period/${periodId}/permissions`);
                const permData = await permResponse.json();
                if (permData.success) {
                    permissions = permData.permissions;
                    renderPermissionNotice();
                    renderActionButtons();
                    renderStatusBadge();
                }
                
                // Load period data
                const response = await Security.fetch(`/api/period/${periodId}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Failed to load');

                // API returns { success: true, data: { name, uploads, ... } }
                const periodData = data.data;
                
                Security.setText(document.getElementById('pageTitle'), periodData.name);
                Security.setText(document.getElementById('pageSubtitle'), '–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã');
                uploadsData = periodData.uploads || [];

                if (uploadsData.length > 0) {
                    currentUploadId = uploadsData[0].id;
                    renderContent();
                } else {
                    document.getElementById('content').innerHTML = '<div class="card"><div class="card-body"><p>–ù–µ—Ç –∑–∞–≥—Ä—É–∑–æ–∫</p></div></div>';
                }
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="card"><div class="card-body"><p>‚ùå ${escapeHtml(error.message)}</p></div></div>`;
            }
        }
        
        function renderStatusBadge() {
            const container = document.getElementById('statusBadge');
            if (!permissions.period_status) {
                container.innerHTML = '';
                return;
            }
            
            const statusClasses = {
                'draft': 'draft',
                'sent': 'sent',
                'paid': 'paid'
            };
            const statusIcons = {
                'draft': 'üìù',
                'sent': 'üì§',
                'paid': '‚úÖ'
            };
            
            const status = permissions.period_status;
            const label = permissions.period_status_label || status;
            const cls = statusClasses[status] || 'draft';
            const icon = statusIcons[status] || 'üìã';
            
            container.innerHTML = `<span class="status-badge ${cls}" style="margin-top: 12px;">${icon} ${escapeHtml(label)}</span>`;
        }
        
        function renderPermissionNotice() {
            const container = document.getElementById('permissionNotice');
            
            if (!permissions.authenticated) {
                container.style.display = 'block';
                container.className = 'permission-notice error';
                container.innerHTML = '‚ö†Ô∏è –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. <a href="/auth/login">–í–æ–π—Ç–∏</a>';
                return;
            }
            
            if (permissions.period_status === 'paid' && !permissions.is_admin) {
                container.style.display = 'block';
                container.className = 'permission-notice error';
                container.innerHTML = 'üîí –ü–µ—Ä–∏–æ–¥ –æ–ø–ª–∞—á–µ–Ω. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.';
                return;
            }
            
            if (!permissions.is_latest && !permissions.is_admin) {
                container.style.display = 'block';
                container.className = 'permission-notice';
                container.innerHTML = '‚ö†Ô∏è –≠—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.';
                return;
            }
            
            container.style.display = 'none';
        }
        
        function renderActionButtons() {
            const container = document.getElementById('actionButtons');
            let html = '';
            
            // Send to workers button
            if (permissions.can_send_to_workers && permissions.period_status !== 'paid') {
                html += `<button class="btn btn-send" onclick="openSendWorkersModal()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞–º</button>`;
            }
            
            // Send to accountant button
            if (permissions.can_send_to_accountant && permissions.period_status !== 'paid') {
                html += `<button class="btn btn-accountant" onclick="openSendAccountantModal()">üí∞ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É</button>`;
            }
            
            // Unlock button (admin only for paid periods)
            if (permissions.can_unlock && permissions.period_status === 'paid') {
                html += `<button class="btn btn-unlock" onclick="unlockPeriod()">üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
            }
            
            container.innerHTML = html;
            container.style.display = html ? 'flex' : 'none';
        }

        async function renderContent() {
            let tabsHtml = '<div class="version-tabs">';
            uploadsData.forEach(upload => {
                const isActive = upload.id === currentUploadId ? 'active' : '';
                const date = upload.created_at ? new Date(upload.created_at).toLocaleString('ru-RU') : '';
                tabsHtml += `<div class="version-tab ${isActive}" onclick="selectUpload(${upload.id})">–í–µ—Ä—Å–∏—è ${upload.version}<div class="date">${escapeHtml(date)}</div></div>`;
            });
            tabsHtml += '</div>';

            const response = await Security.fetch(`/api/upload/${currentUploadId}`);
            const data = await response.json();
            if (!data.success) { document.getElementById('content').innerHTML = tabsHtml + '<div class="card"><div class="card-body"><p>–û—à–∏–±–∫–∞</p></div></div>'; return; }

            const upload = data.data;
            workerTotalsData = upload.worker_totals || [];
            const changes = upload.changes || [];
            const manualEdits = upload.manual_edits || [];

            const grandTotal = workerTotalsData.reduce((s, w) => s + (w.total_amount || 0), 0);
            const grandCompany = workerTotalsData.reduce((s, w) => s + (w.company_amount || 0), 0);
            const grandClient = workerTotalsData.reduce((s, w) => s + (w.client_amount || 0), 0);
            const totalOrders = workerTotalsData.reduce((s, w) => s + (w.orders_count || 0), 0);

            let statsHtml = `<div class="stats-bar" style="grid-template-columns: repeat(4, 1fr);">
                <div class="stats-card"><div class="stats-icon yellow"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg></div><div class="stats-content"><div class="stats-value">${workerTotalsData.length}</div><div class="stats-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div></div></div>
                <div class="stats-card"><div class="stats-icon green"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandCompany)}</div><div class="stats-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div></div>
                <div class="stats-card"><div class="stats-icon orange"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandClient)}</div><div class="stats-label">–ö–ª–∏–µ–Ω—Ç</div></div></div>
                <div class="stats-card"><div class="stats-icon dark"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandTotal)}</div><div class="stats-label">–ò—Ç–æ–≥–æ (${totalOrders})</div></div></div>
            </div>`;

            let downloadHtml = `<div class="download-section"><div class="download-title">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</div><div class="download-buttons">
                <a href="/api/period/${periodId}/download/full" class="btn btn-download">üì• –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç</a>
                <a href="/api/period/${periodId}/download/workers" class="btn btn-secondary">üë∑ –î–ª—è –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</a>
            </div></div>`;

            let workersHtml = '<div class="workers-grid">';
            workerTotalsData.forEach(wt => {
                const companyAmt = wt.company_amount || 0;
                const clientAmt = wt.client_amount || 0;
                const totalAmt = wt.total_amount || 0;
                workersHtml += `<div class="worker-card" onclick="viewWorker('${escapeAttr(encodeURIComponent(wt.worker))}')">
                    <div class="worker-name">üë∑ ${escapeHtml(wt.worker)}</div>
                    <div class="worker-amounts">
                        <div class="worker-amount company"><div class="worker-amount-value">${Math.round(companyAmt).toLocaleString('ru-RU')}</div><div class="worker-amount-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div>
                        <div class="worker-amount client"><div class="worker-amount-value">${Math.round(clientAmt).toLocaleString('ru-RU')}</div><div class="worker-amount-label">–ö–ª–∏–µ–Ω—Ç</div></div>
                    </div>
                    <div class="worker-total-row"><span class="worker-total-label">–ò—Ç–æ–≥–æ:</span><span class="worker-total-value">${Math.round(totalAmt).toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                </div>`;
            });
            workersHtml += '</div>';

            workersHtml += `<div class="grand-totals"><div class="grand-totals-grid">
                <div class="grand-total-item company"><div class="grand-total-value">${Math.round(grandCompany).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üè¢ –ö–æ–º–ø–∞–Ω–∏—è</div></div>
                <div class="grand-total-item client"><div class="grand-total-value">${Math.round(grandClient).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üë§ –ö–ª–∏–µ–Ω—Ç</div></div>
                <div class="grand-total-item total"><div class="grand-total-value">${Math.round(grandTotal).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üí∞ –ò—Ç–æ–≥–æ</div></div>
            </div></div>`;

            let changesHtml = '';
            if (changes.length > 0) {
                // Group changes by type
                const added = changes.filter(c => c.change_type === 'added');
                const deleted = changes.filter(c => c.change_type === 'deleted');
                const modified = changes.filter(c => c.change_type === 'modified');
                
                changesHtml = '<div class="card" style="margin-top:24px"><div class="card-header"><h3 class="card-title">üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏</h3></div><div class="card-body">';
                
                // Summary badges
                changesHtml += '<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">';
                if (added.length > 0) changesHtml += `<span style="background:#d4edda;color:#155724;padding:6px 12px;border-radius:20px;font-size:13px">‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ: ${added.length}</span>`;
                if (deleted.length > 0) changesHtml += `<span style="background:#f8d7da;color:#721c24;padding:6px 12px;border-radius:20px;font-size:13px">‚ûñ –£–¥–∞–ª–µ–Ω–æ: ${deleted.length}</span>`;
                if (modified.length > 0) changesHtml += `<span style="background:#fff3cd;color:#856404;padding:6px 12px;border-radius:20px;font-size:13px">‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ: ${modified.length}</span>`;
                changesHtml += '</div>';
                
                changesHtml += '<div class="changes-list">';
                changes.forEach(change => {
                    const icons = { added: '‚ûï', deleted: '‚ûñ', modified: '‚úèÔ∏è' };
                    const bgColors = { added: '#d4edda', deleted: '#f8d7da', modified: '#fff3cd' };
                    const labels = { added: '–î–æ–±–∞–≤–ª–µ–Ω–æ', deleted: '–£–¥–∞–ª–µ–Ω–æ', modified: '–ò–∑–º–µ–Ω–µ–Ω–æ' };
                    
                    let detailText = '';
                    if (change.change_type === 'modified' && change.field_name) {
                        const fieldLabels = { revenue_total: '–í—ã—Ä—É—á–∫–∞', service_payment: '–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥', fuel_payment: '–ë–µ–Ω–∑–∏–Ω', transport: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ', total: '–ò—Ç–æ–≥–æ' };
                        detailText = `<div style="color:#666;font-size:13px;margin-top:4px">${fieldLabels[change.field_name] || change.field_name}: ${change.old_value || '‚Äî'} ‚Üí ${change.new_value || '‚Äî'}</div>`;
                    }
                    
                    changesHtml += `<div style="display:flex;gap:12px;padding:12px;background:${bgColors[change.change_type]};border-radius:8px;margin-bottom:8px;">
                        <span style="font-size:20px">${icons[change.change_type] || '‚Ä¢'}</span>
                        <div style="flex:1">
                            <div style="font-weight:500">${escapeHtml(change.order_code || '–ó–∞–∫–∞–∑')} ‚Äî ${escapeHtml(change.worker)}</div>
                            ${detailText}
                        </div>
                        <span style="font-size:12px;color:#666">${labels[change.change_type]}</span>
                    </div>`;
                });
                changesHtml += '</div></div></div>';
            }

            let editsHtml = '';
            if (manualEdits.length > 0) {
                editsHtml = '<div class="card" style="margin-top:24px"><div class="card-header"><h3 class="card-title">üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3></div><div class="card-body"><div class="changes-list">';
                manualEdits.forEach(edit => {
                    const fieldLabels = { 
                        fuel_payment: '–ë–µ–Ω–∑–∏–Ω', 
                        transport: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ', 
                        total: '–ò—Ç–æ–≥–æ',
                        DELETED: '–£–¥–∞–ª–µ–Ω–æ',
                        ADDED: '–î–æ–±–∞–≤–ª–µ–Ω–æ'
                    };
                    const statusLabels = {
                        'DRAFT': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
                        'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
                        'SENT': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                        'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                        'PAID': '–û–ø–ª–∞—á–µ–Ω–æ',
                        'paid': '–û–ø–ª–∞—á–µ–Ω–æ'
                    };
                    const statusColors = {
                        'DRAFT': '#6c757d',
                        'draft': '#6c757d',
                        'SENT': '#0d6efd',
                        'sent': '#0d6efd',
                        'PAID': '#198754',
                        'paid': '#198754'
                    };
                    const statusBgColors = {
                        'DRAFT': '#f8f9fa',
                        'draft': '#f8f9fa',
                        'SENT': '#e7f1ff',
                        'sent': '#e7f1ff',
                        'PAID': '#d1e7dd',
                        'paid': '#d1e7dd'
                    };
                    
                    const isDeleted = edit.field_name === 'DELETED';
                    const isAdded = edit.field_name === 'ADDED';
                    const icon = isDeleted ? 'üóëÔ∏è' : (isAdded ? '‚ûï' : '‚úèÔ∏è');
                    const status = edit.period_status || 'DRAFT';
                    const bgColor = statusBgColors[status] || '#f8f9fa';
                    const statusColor = statusColors[status] || '#6c757d';
                    const statusLabel = statusLabels[status] || status;
                    
                    let changeText = '';
                    if (isDeleted) {
                        changeText = `<span style="color: #dc3545; font-weight: 500">–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞ (–±—ã–ª–æ: ${Math.round(edit.old_value || 0).toLocaleString('ru-RU')} ‚ÇΩ)</span>`;
                    } else if (isAdded) {
                        changeText = `<span style="color: #198754; font-weight: 500">–°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${Math.round(edit.new_value || 0).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    } else {
                        changeText = `${escapeHtml(fieldLabels[edit.field_name] || edit.field_name)}: <span style="text-decoration: line-through; color: #999">${Math.round(edit.old_value || 0).toLocaleString('ru-RU')}</span> ‚Üí <span style="font-weight: 500; color: #198754">${Math.round(edit.new_value || 0).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    }
                    
                    const editorName = edit.edited_by_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    editsHtml += `<div class="manual-edit-item" style="display:flex;gap:12px;padding:16px;border-bottom:1px solid #eee;background:${bgColor};border-radius:8px;margin-bottom:8px;">
                        <span style="font-size:24px">${icon}</span>
                        <div class="edit-content" style="flex:1">
                            <div class="edit-header" style="font-weight:600;font-size:15px;margin-bottom:4px">${escapeHtml(edit.order_code || edit.address || '–ó–∞–∫–∞–∑')} ‚Äî ${escapeHtml(edit.worker)}</div>
                            <div class="edit-change" style="margin-bottom:8px">${changeText}</div>
                            <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
                                <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:${statusColor};color:white;border-radius:12px;font-size:12px;font-weight:500">
                                    ${statusLabel}
                                </span>
                                <span style="color:#666;font-size:13px">üë§ ${escapeHtml(editorName)}</span>
                                ${edit.created_at ? `<span style="color:#999;font-size:12px">üïê ${new Date(edit.created_at).toLocaleString('ru-RU')}</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                });
                editsHtml += '</div></div></div>';
            }

            document.getElementById('content').innerHTML = `${tabsHtml}${statsHtml}<div class="card"><div class="card-header"><h3 class="card-title">üë• –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏</h3></div><div class="card-body">${downloadHtml}${workersHtml}</div></div>${changesHtml}${editsHtml}`;
        }
        
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function openSendWorkersModal() {
            // Populate workers list
            let html = '';
            workerTotalsData.forEach((wt, index) => {
                const totalAmt = wt.total_amount || 0;
                html += `<label class="worker-checkbox">
                    <input type="checkbox" checked data-worker="${escapeAttr(wt.worker)}" data-amount="${totalAmt}">
                    <div class="worker-checkbox-info">
                        <div class="worker-checkbox-name">${escapeHtml(wt.worker)}</div>
                        <div class="worker-checkbox-amount">${Math.round(totalAmt).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                </label>`;
            });
            document.getElementById('workersCheckboxList').innerHTML = html;
            openModal('sendWorkersModal');
        }
        
        async function confirmSendToWorkers() {
            const checkboxes = document.querySelectorAll('#workersCheckboxList input:checked');
            const workers = [];
            checkboxes.forEach(cb => {
                workers.push({
                    name: cb.dataset.worker,
                    bitrix_id: null // TODO: map worker name to Bitrix ID
                });
            });
            
            if (workers.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞');
                return;
            }
            
            try {
                const response = await Security.fetch(`/api/period/${periodId}/send-to-workers`, {
                    method: 'POST',
                    body: JSON.stringify({ worker_ids: workers })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${data.sent_count} –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞–º`);
                    closeModal('sendWorkersModal');
                    // Reload to update status
                    loadPeriod();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function openSendAccountantModal() {
            // Build payment summary
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            let total = 0;
            workerTotalsData.forEach(wt => {
                const amt = wt.total_amount || 0;
                total += amt;
                html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span>${escapeHtml(wt.worker)}</span>
                    <strong>${Math.round(amt).toLocaleString('ru-RU')} ‚ÇΩ</strong>
                </div>`;
            });
            html += `</div>
                <div style="display: flex; justify-content: space-between; padding: 16px 0; margin-top: 8px; border-top: 2px solid var(--black); font-size: 18px;">
                    <strong>–ò–¢–û–ì–û:</strong>
                    <strong>${Math.round(total).toLocaleString('ru-RU')} ‚ÇΩ</strong>
                </div>`;
            document.getElementById('paymentSummary').innerHTML = html;
            openModal('sendAccountantModal');
        }
        
        async function confirmSendToAccountant() {
            if (!confirm('‚ö†Ô∏è –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }
            
            const paymentDetails = workerTotalsData.map(wt => ({
                worker: wt.worker,
                amount: wt.total_amount || 0,
                bank: '–¢-–ë–∞–Ω–∫' // TODO: get from worker settings
            }));
            
            try {
                const response = await Security.fetch(`/api/period/${periodId}/send-to-accountant`, {
                    method: 'POST',
                    body: JSON.stringify({
                        accountant_bitrix_id: null, // TODO: get from settings
                        payment_details: paymentDetails
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É. –ü–µ—Ä–∏–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.');
                    closeModal('sendAccountantModal');
                    loadPeriod();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function unlockPeriod() {
            if (!confirm('üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?')) {
                return;
            }
            
            try {
                const response = await Security.fetch(`/api/period/${periodId}/unlock`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –ü–µ—Ä–∏–æ–¥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    loadPeriod();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function selectUpload(uploadId) { currentUploadId = uploadId; renderContent(); }
        function viewWorker(workerEncoded) { window.location.href = `/upload/${currentUploadId}?worker=${workerEncoded}`; }
        function formatCurrency(value) { if (value >= 1000000) return (value / 1000000).toFixed(1) + '–ú'; if (value >= 1000) return Math.round(value / 1000) + '–ö'; return Math.round(value).toString(); }

        loadPeriod();

        // ===== Global Search =====
        (function() {
            const searchInput = document.getElementById('globalSearch');
            const searchDropdown = document.getElementById('searchDropdown');
            if (!searchInput || !searchDropdown) return;

            let searchTimeout = null;
            let currentQuery = '';

            function highlightMatch(text, query) {
                if (!text || !query) return Security.escapeHtml(text);
                const escaped = Security.escapeHtml(text);
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return escaped.replace(regex, '<span class="search-highlight">$1</span>');
            }

            function formatNum(num) { return num ? Math.round(num).toLocaleString('ru-RU') : '0'; }
            function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : (str || ''); }

            async function doSearch(query) {
                if (query.length < 2) { searchDropdown.classList.remove('active'); return; }
                searchDropdown.innerHTML = '<div class="search-loading"><div class="search-loading-spinner"></div></div>';
                searchDropdown.classList.add('active');

                try {
                    const response = await Security.fetch(`/api/search?q=${encodeURIComponent(query)}&limit=6`);
                    const data = await response.json();
                    if (!data.success || currentQuery !== query) return;

                    const results = data.results || [];
                    if (results.length === 0) {
                        searchDropdown.innerHTML = `<div class="search-empty"><div class="search-empty-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>`;
                        return;
                    }

                    let html = '<div class="search-dropdown-header">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>';
                    results.forEach(r => {
                        const typeClass = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'client' : 'company';
                        const icon = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'üë§' : 'üè¢';
                        html += `<a href="/upload/${r.upload_id}?worker=${encodeURIComponent(r.worker)}&highlight=${encodeURIComponent(r.order_code)}" class="search-result-item">
                            <div class="search-result-icon ${typeClass}">${icon}</div>
                            <div class="search-result-content">
                                <div class="search-result-title"><span class="search-result-order">${highlightMatch(r.order_code, query)}</span><span class="search-result-period">${Security.escapeHtml(r.period_name)}</span></div>
                                <div class="search-result-meta"><span class="search-result-worker">${highlightMatch(r.worker, query)}</span><span>‚Ä¢</span><span class="search-result-address">${highlightMatch(truncate(r.address, 40), query)}</span></div>
                            </div>
                            <div class="search-result-right"><div class="search-result-total">${formatNum(r.total)} ‚ÇΩ</div><span class="search-result-type ${typeClass}">${r.type}</span></div>
                        </a>`;
                    });
                    html += `<a href="/search?q=${encodeURIComponent(query)}" class="search-all-link"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>`;
                    searchDropdown.innerHTML = html;
                } catch (error) {
                    searchDropdown.innerHTML = '<div class="search-empty"><div class="search-empty-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div></div>';
                }
            }

            searchInput.addEventListener('input', (e) => {
                currentQuery = e.target.value.trim();
                clearTimeout(searchTimeout);
                if (currentQuery.length < 2) { searchDropdown.classList.remove('active'); return; }
                searchTimeout = setTimeout(() => doSearch(currentQuery), 300);
            });
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && currentQuery.length >= 2) window.location.href = `/search?q=${encodeURIComponent(currentQuery)}`; });
            searchInput.addEventListener('focus', () => { if (currentQuery.length >= 2) searchDropdown.classList.add('active'); });
            document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) searchDropdown.classList.remove('active'); });
        })();
    </script>
</body>
</html>
