<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>–î–µ—Ç–∞–ª–∏ –ø–µ—Ä–∏–æ–¥–∞ | Mos-GSM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/security.js"></script>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 20px; }
        .page-title-section h1 { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--black); line-height: 1; }
        .page-subtitle { font-size: 16px; color: var(--gray-dark); margin-top: 8px; }
        .page-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .version-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .version-tab { font-family: 'Roboto Condensed', sans-serif; font-weight: 500; font-size: 14px; padding: 12px 20px; border-radius: 24px; background: var(--white); border: 2px solid var(--gray); cursor: pointer; transition: all 0.2s; }
        .version-tab:hover { border-color: var(--yellow); }
        .version-tab.active { background: var(--yellow); border-color: var(--yellow); }
        .version-tab .date { font-size: 11px; opacity: 0.7; margin-top: 2px; }
        .download-section { background: linear-gradient(135deg, var(--gray-light) 0%, #E8E8E8 100%); border-radius: var(--radius-md); padding: 24px; margin-bottom: 24px; }
        .download-title { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 16px; color: var(--black); margin-bottom: 16px; text-transform: uppercase; }
        .download-buttons { display: flex; gap: 16px; flex-wrap: wrap; }
        .btn-download { background: linear-gradient(135deg, var(--green-light) 0%, var(--green) 100%); color: var(--white); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3); }
        .btn-download:hover { transform: translateY(-2px); }
        .workers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .worker-card { background: var(--gray-light); border-radius: var(--radius-md); padding: 24px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .worker-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); border-color: var(--yellow); }
        .worker-name { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--black); margin-bottom: 16px; }
        .worker-amounts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .worker-amount { padding: 14px; border-radius: var(--radius-sm); text-align: center; }
        .worker-amount.company { background: #E8F5E9; }
        .worker-amount.client { background: #FFF3E0; }
        .worker-amount-value { font-family: 'Bebas Neue', sans-serif; font-size: 24px; line-height: 1; }
        .worker-amount.company .worker-amount-value { color: var(--green); }
        .worker-amount.client .worker-amount-value { color: var(--orange); }
        .worker-amount-label { font-size: 11px; color: var(--gray-dark); margin-top: 4px; text-transform: uppercase; }
        .worker-total-row { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 2px solid var(--gray); }
        .worker-total-label { font-size: 14px; color: var(--gray-dark); }
        .worker-total-value { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--black); }
        .grand-totals { margin-top: 32px; padding: 24px; background: linear-gradient(135deg, var(--black) 0%, var(--gray-dark) 100%); border-radius: var(--radius-md); }
        .grand-totals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grand-total-item { text-align: center; }
        .grand-total-value { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--white); line-height: 1; }
        .grand-total-item.company .grand-total-value { color: #81C784; }
        .grand-total-item.client .grand-total-value { color: #FFB74D; }
        .grand-total-label { font-size: 13px; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .changes-list { display: flex; flex-direction: column; gap: 12px; }
        .change-item { padding: 16px; border-radius: var(--radius-sm); display: flex; align-items: flex-start; gap: 12px; }
        .change-item.added { background: #E8F5E9; border-left: 4px solid var(--green); }
        .change-item.deleted { background: #FFEBEE; border-left: 4px solid var(--red); }
        .change-item.modified { background: #FFF8E1; border-left: 4px solid var(--yellow); }
        .change-icon { font-size: 20px; }
        .change-text { flex: 1; }
        .change-header { font-weight: 600; color: var(--black); }
        .change-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }
        .change-field { font-size: 13px; color: var(--gray-dark); margin-top: 6px; }
        .change-details { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .detail-tag { background: rgba(0,0,0,0.08); padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .manual-edit-item { background: #E3F2FD; border-left: 4px solid var(--blue); padding: 16px; border-radius: var(--radius-sm); display: flex; align-items: flex-start; gap: 12px; }
        .edit-content { flex: 1; }
        .edit-header { font-weight: 600; color: var(--black); }
        .edit-address { font-size: 12px; color: var(--gray-dark); margin-top: 4px; }
        .edit-change { display: inline-block; margin-top: 8px; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; }
        .edit-change.fuel { background: #FFF8E1; color: #F57F17; }
        .edit-change.transport { background: #E8F5E9; color: var(--green); }
        .edit-change.total { background: #E3F2FD; color: var(--blue); }
        .edit-time { font-size: 11px; color: var(--gray-dark); margin-top: 6px; }
        .no-changes { background: #E8F5E9; color: var(--green); padding: 20px; border-radius: var(--radius-sm); text-align: center; font-weight: 500; }
        @media (max-width: 1024px) { .grand-totals-grid { grid-template-columns: 1fr; gap: 16px; } }
        @media (max-width: 768px) { .page-title-section h1 { font-size: 36px; } .workers-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon"><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div></div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link active">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
        </nav>
    </header>

    <main class="main">
        <div class="page-header">
            <div class="page-title-section">
                <h1 id="pageTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p class="page-subtitle" id="pageSubtitle"></p>
            </div>
            <div class="page-actions">
                <a href="/history" class="btn btn-secondary">‚Üê –ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="/" class="btn btn-primary">+ –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</a>
            </div>
        </div>
        <div id="content">
            <div class="card"><div class="card-body"><div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div></div></div>
        </div>
    </main>

    <script>
        const periodId = parseInt('{{ period_id }}', 10);
        let currentUploadId = null;
        let uploadsData = [];

        async function loadPeriod() {
            try {
                const response = await Security.fetch(`/api/period/${periodId}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Failed to load');

                Security.setText(document.getElementById('pageTitle'), data.data.period.name);
                Security.setText(document.getElementById('pageSubtitle'), '–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã');
                uploadsData = data.data.uploads;

                if (uploadsData.length > 0) {
                    currentUploadId = uploadsData[0].id;
                    renderContent();
                } else {
                    document.getElementById('content').innerHTML = '<div class="card"><div class="card-body"><p>–ù–µ—Ç –∑–∞–≥—Ä—É–∑–æ–∫</p></div></div>';
                }
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="card"><div class="card-body"><p>‚ùå ${escapeHtml(error.message)}</p></div></div>`;
            }
        }

        async function renderContent() {
            let tabsHtml = '<div class="version-tabs">';
            uploadsData.forEach(upload => {
                const isActive = upload.id === currentUploadId ? 'active' : '';
                const date = upload.created_at ? new Date(upload.created_at).toLocaleString('ru-RU') : '';
                tabsHtml += `<div class="version-tab ${isActive}" onclick="selectUpload(${upload.id})">–í–µ—Ä—Å–∏—è ${upload.version}<div class="date">${escapeHtml(date)}</div></div>`;
            });
            tabsHtml += '</div>';

            const response = await Security.fetch(`/api/upload/${currentUploadId}`);
            const data = await response.json();
            if (!data.success) { document.getElementById('content').innerHTML = tabsHtml + '<div class="card"><div class="card-body"><p>–û—à–∏–±–∫–∞</p></div></div>'; return; }

            const upload = data.data;
            const workerTotals = upload.worker_totals || [];
            const changes = upload.changes || [];
            const manualEdits = upload.manual_edits || [];

            const grandTotal = workerTotals.reduce((s, w) => s + (w.total_amount || 0), 0);
            const grandCompany = workerTotals.reduce((s, w) => s + (w.company_amount || 0), 0);
            const grandClient = workerTotals.reduce((s, w) => s + (w.client_amount || 0), 0);
            const totalOrders = workerTotals.reduce((s, w) => s + (w.orders_count || 0), 0);

            let statsHtml = `<div class="stats-bar" style="grid-template-columns: repeat(4, 1fr);">
                <div class="stats-card"><div class="stats-icon yellow"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg></div><div class="stats-content"><div class="stats-value">${workerTotals.length}</div><div class="stats-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div></div></div>
                <div class="stats-card"><div class="stats-icon green"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandCompany)}</div><div class="stats-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div></div>
                <div class="stats-card"><div class="stats-icon orange"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandClient)}</div><div class="stats-label">–ö–ª–∏–µ–Ω—Ç</div></div></div>
                <div class="stats-card"><div class="stats-icon dark"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value">${formatCurrency(grandTotal)}</div><div class="stats-label">–ò—Ç–æ–≥–æ (${totalOrders})</div></div></div>
            </div>`;

            let downloadHtml = `<div class="download-section"><div class="download-title">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</div><div class="download-buttons">
                <a href="/api/period/${periodId}/download/full" class="btn btn-download">üì• –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç</a>
                <a href="/api/period/${periodId}/download/workers" class="btn btn-secondary">üë∑ –î–ª—è –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</a>
            </div></div>`;

            let workersHtml = '<div class="workers-grid">';
            workerTotals.forEach(wt => {
                const companyAmt = wt.company_amount || 0;
                const clientAmt = wt.client_amount || 0;
                const totalAmt = wt.total_amount || 0;
                workersHtml += `<div class="worker-card" onclick="viewWorker('${escapeAttr(encodeURIComponent(wt.worker))}')">
                    <div class="worker-name">üë∑ ${escapeHtml(wt.worker)}</div>
                    <div class="worker-amounts">
                        <div class="worker-amount company"><div class="worker-amount-value">${Math.round(companyAmt).toLocaleString('ru-RU')}</div><div class="worker-amount-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div>
                        <div class="worker-amount client"><div class="worker-amount-value">${Math.round(clientAmt).toLocaleString('ru-RU')}</div><div class="worker-amount-label">–ö–ª–∏–µ–Ω—Ç</div></div>
                    </div>
                    <div class="worker-total-row"><span class="worker-total-label">–ò—Ç–æ–≥–æ:</span><span class="worker-total-value">${Math.round(totalAmt).toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                </div>`;
            });
            workersHtml += '</div>';

            workersHtml += `<div class="grand-totals"><div class="grand-totals-grid">
                <div class="grand-total-item company"><div class="grand-total-value">${Math.round(grandCompany).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üè¢ –ö–æ–º–ø–∞–Ω–∏—è</div></div>
                <div class="grand-total-item client"><div class="grand-total-value">${Math.round(grandClient).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üë§ –ö–ª–∏–µ–Ω—Ç</div></div>
                <div class="grand-total-item total"><div class="grand-total-value">${Math.round(grandTotal).toLocaleString('ru-RU')} ‚ÇΩ</div><div class="grand-total-label">üí∞ –ò—Ç–æ–≥–æ</div></div>
            </div></div>`;

            let changesHtml = '';
            if (changes.length > 0) {
                changesHtml = '<div class="card" style="margin-top:24px"><div class="card-header"><h3 class="card-title">üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è</h3></div><div class="card-body"><div class="changes-list">';
                changes.forEach(change => {
                    const icons = { added: '‚ûï', deleted: '‚ûñ', modified: '‚úèÔ∏è' };
                    changesHtml += `<div class="change-item ${change.change_type}">
                        <span class="change-icon">${icons[change.change_type] || '‚Ä¢'}</span>
                        <div class="change-text">
                            <div class="change-header">${escapeHtml(change.order_code)} - ${escapeHtml(change.worker)}</div>
                            ${change.address ? `<div class="change-address">üìç ${escapeHtml(change.address)}</div>` : ''}
                        </div>
                    </div>`;
                });
                changesHtml += '</div></div></div>';
            }

            let editsHtml = '';
            if (manualEdits.length > 0) {
                editsHtml = '<div class="card" style="margin-top:24px"><div class="card-header"><h3 class="card-title">‚úèÔ∏è –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h3></div><div class="card-body"><div class="changes-list">';
                manualEdits.forEach(edit => {
                    const fieldLabels = { fuel_payment: '–ë–µ–Ω–∑–∏–Ω', transport: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ', total: '–ò—Ç–æ–≥–æ' };
                    const fieldClasses = { fuel_payment: 'fuel', transport: 'transport', total: 'total' };
                    editsHtml += `<div class="manual-edit-item">
                        <span style="font-size:20px">‚úèÔ∏è</span>
                        <div class="edit-content">
                            <div class="edit-header">${escapeHtml(edit.order_code || edit.address)} - ${escapeHtml(edit.worker)}</div>
                            <div class="edit-change ${fieldClasses[edit.field_name] || ''}">${escapeHtml(fieldLabels[edit.field_name] || edit.field_name)}: ${Math.round(edit.old_value || 0).toLocaleString('ru-RU')} ‚Üí ${Math.round(edit.new_value || 0).toLocaleString('ru-RU')} ‚ÇΩ</div>
                        </div>
                    </div>`;
                });
                editsHtml += '</div></div></div>';
            }

            document.getElementById('content').innerHTML = `${tabsHtml}${statsHtml}<div class="card"><div class="card-header"><h3 class="card-title">üë• –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏</h3></div><div class="card-body">${downloadHtml}${workersHtml}</div></div>${changesHtml}${editsHtml}`;
        }

        function selectUpload(uploadId) { currentUploadId = uploadId; renderContent(); }
        function viewWorker(workerEncoded) { window.location.href = `/upload/${currentUploadId}?worker=${workerEncoded}`; }
        function formatCurrency(value) { if (value >= 1000000) return (value / 1000000).toFixed(1) + '–ú'; if (value >= 1000) return Math.round(value / 1000) + '–ö'; return Math.round(value).toString(); }

        loadPeriod();
    </script>
</body>
</html>
