<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Mos-GSM | –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/security.js"></script>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
        .page-title { font-family: 'Bebas Neue', sans-serif; font-size: 42px; color: var(--black); letter-spacing: 1px; }
        .page-actions { display: flex; gap: 12px; }
        .main-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-medium); overflow: hidden; }
        .card-header { padding: 24px 32px; border-bottom: 1px solid var(--gray); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .view-tabs { display: flex; gap: 8px; }
        .view-tab { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 14px; padding: 10px 20px; border-radius: var(--radius-sm); background: var(--gray-light); color: var(--gray-dark); border: none; cursor: pointer; transition: all 0.2s ease; }
        .view-tab:hover { background: var(--gray); }
        .view-tab.active { background: var(--black); color: var(--white); }
        .filter-group { display: flex; align-items: center; gap: 12px; }
        .filter-label { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 13px; color: var(--gray-dark); text-transform: uppercase; }
        .filter-select { font-family: 'Roboto', sans-serif; font-size: 14px; padding: 10px 16px; border: 2px solid var(--gray); border-radius: var(--radius-sm); background: var(--white); cursor: pointer; min-width: 180px; }
        .filter-select:focus { outline: none; border-color: var(--yellow); }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--gray-light); }
        th { background: var(--black); color: var(--white); font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 13px; text-transform: uppercase; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        th.period-col { text-align: center; min-width: 130px; }
        th.total-col { background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%); color: var(--black); }
        tr:hover { background: var(--gray-light); }
        td.worker-name { font-weight: 500; white-space: nowrap; position: sticky; left: 0; background: var(--white); z-index: 5; display: flex; align-items: center; gap: 8px; }
        tr:hover td.worker-name { background: var(--gray-light); }
        .worker-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--yellow-light) 0%, var(--yellow) 100%); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; color: var(--black); }
        td.number { text-align: right; font-family: 'Roboto Condensed', sans-serif; font-size: 14px; font-weight: 500; }
        td.total-number { font-weight: 700; background: rgba(243, 192, 77, 0.1); }
        tr.total-row { background: linear-gradient(135deg, var(--yellow-light) 0%, var(--yellow) 100%); }
        tr.total-row:hover { background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%); }
        tr.total-row td { font-weight: 700; border-bottom: none; }
        tr.total-row td.worker-name { background: transparent; font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link active">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
            {% if user and user.role == 'admin' %}<a href="/duplicates" class="nav-link">–î—É–±–ª–∏</a>{% endif %}
        </nav>
        
        <!-- Search Component -->
        <div class="search-wrapper">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤..." autocomplete="off">
            </div>
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        
        {% if user %}
        <div class="user-info">
            <span class="user-name">
                {% if user.role == 'admin' %}üëë{% else %}üë§{% endif %}
                {{ user.name | e }}
            </span>
            <span class="user-role {% if user.role == 'admin' %}role-admin{% else %}role-employee{% endif %}">
                {{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if user.role == 'admin' else '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}
            </span>
            <a href="/auth/logout" class="logout-btn" title="–í—ã–π—Ç–∏">
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </a>
        </div>
        {% endif %}
    </header>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h1>
            <div class="page-actions">
                <button class="btn btn-success" onclick="exportToExcel()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <a href="/history" class="btn btn-secondary">üìã –ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="/" class="btn btn-primary">+ –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</a>
            </div>
        </div>

        <div class="stats-bar" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stats-card"><div class="stats-icon yellow">üìÖ</div><div class="stats-content"><div class="stats-value" id="totalPeriods">-</div><div class="stats-label">–ü–µ—Ä–∏–æ–¥–æ–≤</div></div></div>
            <div class="stats-card"><div class="stats-icon dark">üë∑</div><div class="stats-content"><div class="stats-value" id="totalWorkers">-</div><div class="stats-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div></div></div>
            <div class="stats-card"><div class="stats-icon green">üè¢</div><div class="stats-content"><div class="stats-value" id="totalCompany">-</div><div class="stats-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div></div>
            <div class="stats-card"><div class="stats-icon orange">üë§</div><div class="stats-content"><div class="stats-value" id="totalClient">-</div><div class="stats-label">–ö–ª–∏–µ–Ω—Ç</div></div></div>
        </div>

        <div class="main-card">
            <div class="card-header">
                <div class="view-tabs">
                    <button class="view-tab active" onclick="setView('periods')">–ü–æ –ø–µ—Ä–∏–æ–¥–∞–º</button>
                    <button class="view-tab" onclick="setView('months')">–ü–æ –º–µ—Å—è—Ü–∞–º</button>
                    <button class="view-tab" onclick="setView('workers')">–ü–æ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞–º</button>
                </div>
                <div class="filter-group">
                    <span class="filter-label">–ü–æ–∫–∞–∑–∞—Ç—å:</span>
                    <select class="filter-select" id="showType" onchange="renderTable()">
                        <option value="total">–û–±—â–∏–π –∏—Ç–æ–≥</option>
                        <option value="company">–û–ø–ª–∞—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–µ–π</option>
                        <option value="client">–û–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º</option>
                    </select>
                </div>
            </div>
            <div class="table-wrapper" id="content"><div class="loading"><div class="spinner"></div><div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div></div>
        </div>
    </main>

    <script>
        let comparisonData = null;
        let currentView = 'periods';
        const monthNames = {'01': '–Ø–Ω–≤–∞—Ä—å', '02': '–§–µ–≤—Ä–∞–ª—å', '03': '–ú–∞—Ä—Ç', '04': '–ê–ø—Ä–µ–ª—å', '05': '–ú–∞–π', '06': '–ò—é–Ω—å', '07': '–ò—é–ª—å', '08': '–ê–≤–≥—É—Å—Ç', '09': '–°–µ–Ω—Ç—è–±—Ä—å', '10': '–û–∫—Ç—è–±—Ä—å', '11': '–ù–æ—è–±—Ä—å', '12': '–î–µ–∫–∞–±—Ä—å'};

        async function loadData() {
            try {
                const response = await Security.fetch('/api/comparison');
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                comparisonData = data.data;
                updateStats();
                renderTable();
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="empty-state"><div class="empty-icon">‚ùå</div><h3 class="empty-title">–û—à–∏–±–∫–∞</h3><p class="empty-text">${escapeHtml(error.message)}</p></div>`;
            }
        }

        function updateStats() {
            if (!comparisonData) return;
            const { periods, workers } = comparisonData;
            let totalCompany = 0, totalClient = 0;
            periods.forEach(p => p.worker_totals.forEach(wt => { totalCompany += wt.company_amount || 0; totalClient += wt.client_amount || 0; }));
            document.getElementById('totalPeriods').textContent = periods.length;
            document.getElementById('totalWorkers').textContent = workers.length;
            document.getElementById('totalCompany').textContent = formatCurrency(totalCompany);
            document.getElementById('totalClient').textContent = formatCurrency(totalClient);
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderTable();
        }

        function formatNumber(n) { if (!n || n === 0) return '‚Äî'; return Math.round(n).toLocaleString('ru-RU'); }
        function formatCurrency(n) { if (!n || n === 0) return '‚Äî'; if (n >= 1000000) return (n / 1000000).toFixed(1) + ' –º–ª–Ω'; if (n >= 1000) return Math.round(n / 1000) + ' —Ç—ã—Å'; return Math.round(n).toLocaleString('ru-RU'); }
        function getInitials(name) { const parts = (name || '').split(' '); return parts.length >= 2 ? parts[0][0] + parts[1][0] : (name || '').substring(0, 2).toUpperCase(); }

        function renderTable() {
            if (!comparisonData) return;
            const showType = document.getElementById('showType').value;
            if (currentView === 'periods') renderPeriodsView(showType);
            else if (currentView === 'months') renderMonthsView(showType);
            else renderWorkersView(showType);
        }

        function renderPeriodsView(showType) {
            const { periods, workers } = comparisonData;
            if (!periods || periods.length === 0) { document.getElementById('content').innerHTML = '<div class="empty-state"><h3 class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3></div>'; return; }

            let html = '<table><thead><tr><th>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</th>';
            periods.forEach(p => { html += `<th class="period-col">${escapeHtml(p.name)}</th>`; });
            html += '<th class="period-col total-col">–í—Å–µ–≥–æ</th></tr></thead><tbody>';

            const getValue = (wt) => showType === 'company' ? (wt.company_amount || 0) : showType === 'client' ? (wt.client_amount || 0) : (wt.total_amount || 0);
            const periodTotals = {}; periods.forEach(p => { periodTotals[p.id] = 0; }); let grandTotal = 0;

            workers.forEach(workerName => {
                let workerTotal = 0;
                html += `<tr><td class="worker-name"><div class="worker-avatar">${escapeHtml(getInitials(workerName))}</div>${escapeHtml(workerName)}</td>`;
                periods.forEach(period => {
                    const wt = period.worker_totals.find(w => w.worker === workerName);
                    const value = wt ? getValue(wt) : 0;
                    workerTotal += value; periodTotals[period.id] += value;
                    html += `<td class="number">${formatNumber(value)}</td>`;
                });
                grandTotal += workerTotal;
                html += `<td class="number total-number">${formatNumber(workerTotal)}</td></tr>`;
            });

            html += '<tr class="total-row"><td class="worker-name">–ò–¢–û–ì–û</td>';
            periods.forEach(p => { html += `<td class="number">${formatNumber(periodTotals[p.id])}</td>`; });
            html += `<td class="number">${formatNumber(grandTotal)}</td></tr></tbody></table>`;
            document.getElementById('content').innerHTML = html;
        }

        function renderMonthsView(showType) {
            const { months, workers } = comparisonData;
            if (!months || months.length === 0) { document.getElementById('content').innerHTML = '<div class="empty-state"><h3 class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3></div>'; return; }

            let html = '<table><thead><tr><th>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</th>';
            months.forEach(m => { const [year, monthNum] = m.month.split('-'); html += `<th class="period-col">${escapeHtml(monthNames[monthNum])} ${escapeHtml(year)}</th>`; });
            html += '<th class="period-col total-col">–í—Å–µ–≥–æ</th></tr></thead><tbody>';

            const getValue = (wt) => showType === 'company' ? (wt.company_amount || 0) : showType === 'client' ? (wt.client_amount || 0) : (wt.total_amount || 0);
            const monthTotals = {}; months.forEach(m => { monthTotals[m.month] = 0; }); let grandTotal = 0;

            workers.forEach(workerName => {
                let workerTotal = 0;
                html += `<tr><td class="worker-name"><div class="worker-avatar">${escapeHtml(getInitials(workerName))}</div>${escapeHtml(workerName)}</td>`;
                months.forEach(month => {
                    const wt = month.worker_totals.find(w => w.worker === workerName);
                    const value = wt ? getValue(wt) : 0;
                    workerTotal += value; monthTotals[month.month] += value;
                    html += `<td class="number">${formatNumber(value)}</td>`;
                });
                grandTotal += workerTotal;
                html += `<td class="number total-number">${formatNumber(workerTotal)}</td></tr>`;
            });

            html += '<tr class="total-row"><td class="worker-name">–ò–¢–û–ì–û</td>';
            months.forEach(m => { html += `<td class="number">${formatNumber(monthTotals[m.month])}</td>`; });
            html += `<td class="number">${formatNumber(grandTotal)}</td></tr></tbody></table>`;
            document.getElementById('content').innerHTML = html;
        }

        function renderWorkersView(showType) {
            const { periods, workers } = comparisonData;
            if (!workers || workers.length === 0) { document.getElementById('content').innerHTML = '<div class="empty-state"><h3 class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3></div>'; return; }

            let html = '<table><thead><tr><th>–ü–µ—Ä–∏–æ–¥</th>';
            workers.forEach(w => { const shortName = w.split(' ').slice(0, 2).join(' '); html += `<th class="period-col">${escapeHtml(shortName)}</th>`; });
            html += '<th class="period-col total-col">–ò—Ç–æ–≥–æ</th></tr></thead><tbody>';

            const getValue = (wt) => showType === 'company' ? (wt.company_amount || 0) : showType === 'client' ? (wt.client_amount || 0) : (wt.total_amount || 0);
            const workerTotals = {}; workers.forEach(w => { workerTotals[w] = 0; }); let grandTotal = 0;

            periods.forEach(period => {
                let periodTotal = 0;
                html += `<tr><td class="worker-name">üìÖ ${escapeHtml(period.name)}</td>`;
                workers.forEach(workerName => {
                    const wt = period.worker_totals.find(w => w.worker === workerName);
                    const value = wt ? getValue(wt) : 0;
                    periodTotal += value; workerTotals[workerName] += value;
                    html += `<td class="number">${formatNumber(value)}</td>`;
                });
                grandTotal += periodTotal;
                html += `<td class="number total-number">${formatNumber(periodTotal)}</td></tr>`;
            });

            html += '<tr class="total-row"><td class="worker-name">–ò–¢–û–ì–û</td>';
            workers.forEach(w => { html += `<td class="number">${formatNumber(workerTotals[w])}</td>`; });
            html += `<td class="number">${formatNumber(grandTotal)}</td></tr></tbody></table>`;
            document.getElementById('content').innerHTML = html;
        }

        function exportToExcel() { window.location.href = '/api/comparison/export'; }
        loadData();

        // ===== Global Search =====
        (function() {
            const searchInput = document.getElementById('globalSearch');
            const searchDropdown = document.getElementById('searchDropdown');
            if (!searchInput || !searchDropdown) return;

            let searchTimeout = null;
            let currentQuery = '';

            function highlightMatch(text, query) {
                if (!text || !query) return Security.escapeHtml(text);
                const escaped = Security.escapeHtml(text);
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return escaped.replace(regex, '<span class="search-highlight">$1</span>');
            }

            function formatNum(num) { return num ? Math.round(num).toLocaleString('ru-RU') : '0'; }
            function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : (str || ''); }

            async function doSearch(query) {
                if (query.length < 2) { searchDropdown.classList.remove('active'); return; }
                searchDropdown.innerHTML = '<div class="search-loading"><div class="search-loading-spinner"></div></div>';
                searchDropdown.classList.add('active');

                try {
                    const response = await Security.fetch(`/api/search?q=${encodeURIComponent(query)}&limit=6`);
                    const data = await response.json();
                    if (!data.success || currentQuery !== query) return;

                    const results = data.results || [];
                    if (results.length === 0) {
                        searchDropdown.innerHTML = `<div class="search-empty"><div class="search-empty-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>`;
                        return;
                    }

                    let html = '<div class="search-dropdown-header">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>';
                    results.forEach(r => {
                        const typeClass = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'client' : 'company';
                        const icon = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'üë§' : 'üè¢';
                        html += `<a href="/upload/${r.upload_id}?worker=${encodeURIComponent(r.worker)}&highlight=${encodeURIComponent(r.order_code)}" class="search-result-item">
                            <div class="search-result-icon ${typeClass}">${icon}</div>
                            <div class="search-result-content">
                                <div class="search-result-title"><span class="search-result-order">${highlightMatch(r.order_code, query)}</span><span class="search-result-period">${Security.escapeHtml(r.period_name)}</span></div>
                                <div class="search-result-meta"><span class="search-result-worker">${highlightMatch(r.worker, query)}</span><span>‚Ä¢</span><span class="search-result-address">${highlightMatch(truncate(r.address, 40), query)}</span></div>
                            </div>
                            <div class="search-result-right"><div class="search-result-total">${formatNum(r.total)} ‚ÇΩ</div><span class="search-result-type ${typeClass}">${r.type}</span></div>
                        </a>`;
                    });
                    html += `<a href="/search?q=${encodeURIComponent(query)}" class="search-all-link"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>`;
                    searchDropdown.innerHTML = html;
                } catch (error) {
                    searchDropdown.innerHTML = '<div class="search-empty"><div class="search-empty-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div></div>';
                }
            }

            searchInput.addEventListener('input', (e) => {
                currentQuery = e.target.value.trim();
                clearTimeout(searchTimeout);
                if (currentQuery.length < 2) { searchDropdown.classList.remove('active'); return; }
                searchTimeout = setTimeout(() => doSearch(currentQuery), 300);
            });
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && currentQuery.length >= 2) window.location.href = `/search?q=${encodeURIComponent(currentQuery)}`; });
            searchInput.addEventListener('focus', () => { if (currentQuery.length >= 2) searchDropdown.classList.add('active'); });
            document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) searchDropdown.classList.remove('active'); });
        })();
    </script>
</body>
</html>
