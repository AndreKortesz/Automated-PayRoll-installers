<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>–î–µ—Ç–∞–ª–∏ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞ | Mos-GSM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --yellow: #F3C04D;
            --yellow-light: #f8d77e;
            --yellow-dark: #d4a63d;
            --black: #1A1A1A;
            --gray-dark: #4D4D4D;
            --gray: #D9D9D9;
            --gray-light: #F5F5F5;
            --white: #FFFFFF;
            --green: #2E7D32;
            --green-light: #4CAF50;
            --orange: #F57C00;
            --red: #D32F2F;
            --blue: #1565C0;
            --shadow-soft: 0 8px 32px rgba(26, 26, 26, 0.08);
            --shadow-medium: 0 12px 48px rgba(26, 26, 26, 0.12);
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 28px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--gray-light);
            color: var(--black);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 16px 32px;
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 32px;
        }

        .logo-bar {
            width: 6px;
            background: var(--yellow);
            border-radius: 3px;
        }

        .logo-bar:nth-child(1) { height: 8px; }
        .logo-bar:nth-child(2) { height: 14px; }
        .logo-bar:nth-child(3) { height: 20px; }
        .logo-bar:nth-child(4) { height: 26px; }
        .logo-bar:nth-child(5) { height: 32px; }

        .logo-text {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: var(--black);
        }

        .nav { display: flex; gap: 8px; }

        .nav-link {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 500;
            font-size: 15px;
            color: var(--gray-dark);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .nav-link:hover { background: var(--gray-light); color: var(--black); }

        /* Main */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--black);
        }

        .page-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        /* Buttons */
        .btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 14px;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            color: var(--black);
            box-shadow: 0 6px 20px rgba(243, 192, 77, 0.4);
        }

        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--gray);
        }

        .btn-secondary:hover { border-color: var(--yellow); }

        .btn-success {
            background: linear-gradient(135deg, var(--green-light) 0%, var(--green) 100%);
            color: var(--white);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-add {
            background: var(--green);
            color: var(--white);
        }

        /* Card */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .card-body { padding: 24px; }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-item {
            background: var(--gray-light);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .summary-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--black);
            line-height: 1;
        }

        .summary-value.green { color: var(--green); }
        .summary-value.orange { color: var(--orange); }

        .summary-label {
            font-size: 11px;
            color: var(--gray-dark);
            margin-top: 6px;
            text-transform: uppercase;
        }

        /* Unsaved Notice */
        .unsaved-notice {
            background: #FFF8E1;
            border: 2px solid var(--yellow);
            color: #F57F17;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .unsaved-notice.show { display: block; }

        /* Edit Hint */
        .edit-hint {
            font-size: 13px;
            color: var(--gray-dark);
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #E3F2FD;
            border-radius: var(--radius-sm);
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            margin: 0 -24px;
            padding: 0 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
        }

        th {
            background: var(--black);
            color: var(--white);
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover { background: var(--gray-light); }

        .order-code {
            font-weight: 600;
            color: var(--yellow-dark);
            min-width: 100px;
        }

        .order-link {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dashed;
        }

        .order-link:hover { text-decoration-style: solid; color: var(--black); }

        .address {
            max-width: 280px;
            min-width: 180px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            font-size: 12px;
        }

        .number {
            text-align: right;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }

        /* Editable Cells */
        .editable {
            cursor: pointer;
            min-width: 70px;
            transition: background 0.2s;
        }

        .editable:hover { background: #E3F2FD; }

        .editable input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid var(--yellow);
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            text-align: right;
        }

        .editable input:focus { outline: none; border-color: var(--yellow-dark); }

        .editable-text {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 100px;
        }

        .editable-text:hover { background: #E8F5E9; }

        .editable-text input {
            width: 100%;
            min-width: 140px;
            padding: 6px 8px;
            border: 2px solid var(--green);
            border-radius: 6px;
            font-size: 13px;
        }

        .cell-modified { background: #FFF8E1 !important; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-client { background: #FFF3E0; color: var(--orange); }
        .badge-over10k { background: var(--gray-light); color: var(--gray-dark); }
        .badge-extra { background: #E8F5E9; color: var(--green); }
        .badge-manager { background: #E3F2FD; color: #1976D2; cursor: help; font-size: 14px; }

        /* Total Row */
        .total-row {
            background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%) !important;
            color: var(--black);
            font-weight: bold;
        }

        .total-row td { border: none; }
        .total-row:hover { background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%) !important; }

        /* New Row */
        .new-row { background: #E8F5E9 !important; }
        .new-row td { border-bottom: 2px solid var(--green); }

        /* Add Row Section */
        .add-row-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed var(--gray);
        }

        /* Loading */
        .loading { text-align: center; padding: 60px; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }

        .modal-header {
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            padding: 20px 24px;
            background: var(--yellow);
        }

        .modal-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--black);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--black);
            opacity: 0.7;
            margin-left: auto;
        }

        .modal-close:hover { opacity: 1; }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }

        .order-info-grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .order-info-label { font-weight: 600; color: var(--gray-dark); }
        .order-info-value { color: var(--black); }

        .amounts-summary {
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 20px;
        }

        .amounts-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray);
        }

        .amounts-row:last-child { border-bottom: none; }
        .amounts-row.total { font-weight: bold; font-size: 16px; }

        .order-status {
            text-align: center;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            margin-bottom: 20px;
        }

        .status-paid { background: #E8F5E9; color: var(--green); }
        .status-partial { background: #FFF8E1; color: var(--orange); }
        .status-unpaid { background: #FFEBEE; color: var(--red); }

        .payment-item {
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border-left: 4px solid var(--green);
        }

        .payment-amount {
            font-weight: 600;
            color: var(--green);
            margin-top: 4px;
        }

        .integration-notice {
            background: #E3F2FD;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-top: 20px;
            font-size: 13px;
            color: var(--blue);
        }

        .modal-error {
            background: #FFEBEE;
            color: var(--red);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .modal-loading {
            text-align: center;
            padding: 40px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .main { padding: 16px; }
            .page-title { font-size: 28px; }
            .nav { display: none; }
            .card-body { padding: 16px; }
        }

        /* Highlight order from search */
        .highlight-order {
            animation: highlightFade 3s ease-out;
        }
        @keyframes highlightFade {
            0% { background: #FFF59D; }
            100% { background: transparent; }
        }
    </style>
    <!-- Security utilities -->
    <script src="/static/security.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link">–ò—Å—Ç–æ—Ä–∏—è</a>
        </nav>
    </header>

    <!-- Main -->
    <main class="main">
        <div class="page-header">
            <h1 class="page-title" id="pageTitle">üë∑ –ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="history.back()">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
                <a href="#" class="btn btn-secondary" id="downloadBtn">
                    üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
                </a>
                <button class="btn btn-success" id="saveBtn" disabled onclick="saveChanges()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>

        <div id="content">
            <div class="card">
                <div class="card-body">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for 1C Order Info -->
    <div class="modal-overlay" id="orderModal" onclick="closeOrderModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalOrderNumber">–ó–∞–∫–∞–∑</h2>
                <button class="modal-close" onclick="closeOrderModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get data from server-rendered template (safely)
        const uploadId = parseInt('{{ upload_id }}', 10);
        const workerName = decodeURIComponent("{{ worker_name | e }}");
        
        let ordersData = [];
        let pendingChanges = {};
        let pendingOrderChanges = {};

        async function loadWorkerData() {
            try {
                const response = await Security.fetch(`/api/upload/${uploadId}/worker/${encodeURIComponent(workerName)}`);
                const data = await response.json();

                if (!data.success) throw new Error(data.error || 'Failed to load');

                ordersData = data.data.orders;
                
                // Safely set page title using textContent (XSS-safe)
                Security.setText(document.getElementById('pageTitle'), `üë∑ ${workerName}`);
                
                // Update download link safely
                document.getElementById('downloadBtn').href = `/api/worker-report/${uploadId}/${encodeURIComponent(workerName)}`;

                renderTable();
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="card"><div class="card-body"><p>‚ùå –û—à–∏–±–∫–∞: ${escapeHtml(error.message)}</p></div></div>
                `;
            }
        }

        function renderTable() {
            // Calculate totals
            let totalRevenue = 0, totalPayment = 0, totalFuel = 0, totalTransport = 0, totalFinal = 0;

            ordersData.forEach(order => {
                // fuel_payment, transport, total now come directly from order (from JOIN)
                const calcId = order.calculation_id;
                totalRevenue += order.revenue_services || 0;
                totalPayment += order.service_payment || 0;
                totalFuel += pendingChanges[calcId]?.fuel_payment ?? order.fuel_payment ?? 0;
                totalTransport += pendingChanges[calcId]?.transport ?? order.transport ?? 0;
                totalFinal += pendingChanges[calcId]?.total ?? order.total ?? 0;
            });

            // Summary HTML (numbers are safe, no user input)
            const summaryHtml = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${ordersData.length}</div>
                        <div class="summary-label">–ó–∞–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalRevenue)}</div>
                        <div class="summary-label">–í—ã—Ä—É—á–∫–∞ —É—Å–ª—É–≥</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalPayment)}</div>
                        <div class="summary-label">–û–ø–ª–∞—Ç–∞</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalFuel)}</div>
                        <div class="summary-label">–ë–µ–Ω–∑–∏–Ω</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalTransport)}</div>
                        <div class="summary-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value green">${formatNumber(totalFinal)}</div>
                        <div class="summary-label">–ò—Ç–æ–≥–æ</div>
                    </div>
                </div>
            `;

            // Check for pending changes
            const hasChanges = Object.keys(pendingChanges).length > 0 || Object.keys(pendingOrderChanges).length > 0;
            const unsavedHtml = `<div class="unsaved-notice ${hasChanges ? 'show' : ''}">‚ö†Ô∏è –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</div>`;

            // Table HTML
            let tableHtml = `
                <div class="edit-hint">üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫—É –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö <strong>–ë–µ–Ω–∑–∏–Ω</strong>, <strong>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ</strong> –∏–ª–∏ <strong>–ò—Ç–æ–≥–æ</strong> –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>–ó–∞–∫–∞–∑</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th class="number">–í—ã—Ä—É—á–∫–∞</th>
                            <th class="number">–û–ø–ª–∞—Ç–∞</th>
                            <th>%</th>
                            <th class="number">–ë–µ–Ω–∑–∏–Ω</th>
                            <th class="number">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</th>
                            <th class="number">–ò—Ç–æ–≥–æ</th>
                            <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                            <th>–¢–∏–ø</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            ordersData.forEach((order, idx) => {
                // fuel_payment, transport, total now come directly from order (from JOIN)
                const calcId = order.calculation_id;
                const orderId = order.id;
                const isNewRow = order.is_extra_row || order._isNew;

                // Get values (pending or original) - now from order directly
                const fuelVal = pendingChanges[calcId]?.fuel_payment ?? order.fuel_payment ?? 0;
                const transportVal = pendingChanges[calcId]?.transport ?? order.transport ?? 0;
                const totalVal = pendingChanges[calcId]?.total ?? order.total ?? 0;

                // Badges (static content, safe)
                let badges = [];
                if (order.is_client_payment) badges.push('<span class="badge badge-client">–ö–ª–∏–µ–Ω—Ç</span>');
                if (order.is_over_10k) badges.push('<span class="badge badge-over10k">&gt;10–ö</span>');
                if (isNewRow) badges.push('<span class="badge badge-extra">–î–æ–ø</span>');

                // Modified classes
                const fuelModified = pendingChanges[calcId]?.fuel_payment !== undefined ? 'cell-modified' : '';
                const transportModified = pendingChanges[calcId]?.transport !== undefined ? 'cell-modified' : '';
                const totalModified = pendingChanges[calcId]?.total !== undefined ? 'cell-modified' : '';

                // Order code cell - ESCAPED for XSS protection
                let orderCodeCell;
                if (isNewRow) {
                    const orderCodeVal = pendingOrderChanges[orderId]?.order_code ?? order.order_code ?? '';
                    const orderCodeModified = pendingOrderChanges[orderId]?.order_code !== undefined ? 'cell-modified' : '';
                    // ‚úÖ XSS FIX: escape user data
                    orderCodeCell = `<td class="order-code editable-text ${orderCodeModified}" onclick="editOrderField(${idx}, 'order_code', ${orderId})" id="cell-ordercode-${idx}">${escapeHtml(orderCodeVal) || '<em style="color:#999">–ö–æ–¥</em>'}</td>`;
                } else {
                    const orderCode = order.order_code || '-';
                    // Validate order code format before making it clickable
                    if (orderCode !== '-' && /^[–ê-–Ø–∞-—èA-Za-z]+-\d+$/.test(orderCode)) {
                        // ‚úÖ XSS FIX: escape and use data attribute
                        orderCodeCell = `<td class="order-code"><span class="order-link" data-order="${escapeAttr(orderCode)}" onclick="showOrderInfo(this.dataset.order)" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ 1–°">${escapeHtml(orderCode)}</span></td>`;
                    } else {
                        // ‚úÖ XSS FIX: escape
                        orderCodeCell = `<td class="order-code">${escapeHtml(orderCode)}</td>`;
                    }
                }

                // Address cell - ESCAPED for XSS protection
                let addressCell;
                if (isNewRow) {
                    const addressVal = pendingOrderChanges[orderId]?.address ?? order.address ?? '';
                    const addressModified = pendingOrderChanges[orderId]?.address !== undefined ? 'cell-modified' : '';
                    // ‚úÖ XSS FIX: escape user data
                    addressCell = `<td class="address editable-text ${addressModified}" onclick="editOrderField(${idx}, 'address', ${orderId})" id="cell-address-${idx}">${escapeHtml(addressVal) || '<em style="color:#999">–ê–¥—Ä–µ—Å</em>'}</td>`;
                } else {
                    // ‚úÖ XSS FIX: escape both display text and title attribute
                    const addressDisplay = order.address || order.order_full || '-';
                    addressCell = `<td class="address" title="${escapeAttr(order.address || '')}">${escapeHtml(addressDisplay)}</td>`;
                }

                const rowClass = order._isNew ? 'new-row' : '';
                const orderCodeAttr = escapeAttr(order.order_code || '');

                tableHtml += `
                    <tr class="${rowClass}" data-idx="${idx}" data-order-code="${orderCodeAttr}">
                        ${orderCodeCell}
                        ${addressCell}
                        <td class="number">${formatNumber(order.revenue_services)}</td>
                        <td class="number">${formatNumber(order.service_payment)}</td>
                        <td>${escapeHtml(order.percent || '-')}</td>
                        <td class="number editable ${fuelModified}" onclick="editCell(${idx}, 'fuel_payment', ${calcId})" id="cell-fuel-${idx}">${formatNumber(fuelVal)}</td>
                        <td class="number editable ${transportModified}" onclick="editCell(${idx}, 'transport', ${calcId})" id="cell-transport-${idx}">${formatNumber(transportVal)}</td>
                        <td class="number editable ${totalModified}" onclick="editCell(${idx}, 'total', ${calcId})" id="cell-total-${idx}"><strong>${formatNumber(totalVal)}</strong></td>
                        <td class="manager-comment" title="${escapeAttr(order.manager_comment || '')}">${order.manager_comment ? '<span class="badge badge-manager" title="' + escapeAttr(order.manager_comment) + '">üí¨</span>' : ''}</td>
                        <td>${badges.join(' ')}</td>
                        <td><button class="btn-danger" onclick="deleteOrder(${orderId}, ${idx})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></td>
                    </tr>
                `;
            });

            // Total row (calculated values, safe)
            tableHtml += `
                <tr class="total-row">
                    <td colspan="2"><strong>–ò–¢–û–ì–û</strong></td>
                    <td class="number">${formatNumber(totalRevenue)}</td>
                    <td class="number">${formatNumber(totalPayment)}</td>
                    <td></td>
                    <td class="number">${formatNumber(totalFuel)}</td>
                    <td class="number">${formatNumber(totalTransport)}</td>
                    <td class="number"><strong>${formatNumber(totalFinal)}</strong></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            `;

            tableHtml += '</tbody></table></div>';

            // Add row section
            tableHtml += `
                <div class="add-row-section">
                    <button class="btn btn-add" onclick="addNewRow()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                    </button>
                </div>
            `;

            document.getElementById('content').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        ${summaryHtml}
                        ${unsavedHtml}
                        ${tableHtml}
                    </div>
                </div>
            `;

            // Update save button
            document.getElementById('saveBtn').disabled = !hasChanges;
        }

        function editCell(idx, field, calcId) {
            const order = ordersData[idx];
            const orderId = order.id;
            
            // Use order_id as fallback key if calcId is missing
            const storageKey = (calcId && calcId !== 'undefined') ? calcId : `order_${orderId}`;
            
            const calc = order.calculation || {};
            const currentVal = pendingChanges[storageKey]?.[field] ?? calc[field] ?? order[field] ?? 0;

            const cellId = field === 'fuel_payment' ? `cell-fuel-${idx}` : 
                           field === 'transport' ? `cell-transport-${idx}` : `cell-total-${idx}`;
            const cell = document.getElementById(cellId);

            // Create input element safely (not using innerHTML with user data)
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentVal;
            input.onblur = function() { saveCell(idx, field, calcId, this); };
            input.onkeypress = function(e) { if (e.key === 'Enter') this.blur(); };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function saveCell(idx, field, calcId, input) {
            const newVal = parseFloat(input.value) || 0;
            const order = ordersData[idx];
            const orderId = order.id;
            
            // Use order_id as fallback key if calcId is missing
            const storageKey = (calcId && calcId !== 'undefined') ? calcId : `order_${orderId}`;
            
            const calc = order.calculation || {};
            const originalVal = calc[field] ?? order[field] ?? 0;

            if (newVal !== originalVal) {
                if (!pendingChanges[storageKey]) pendingChanges[storageKey] = {};
                pendingChanges[storageKey][field] = newVal;
            } else {
                if (pendingChanges[storageKey]) {
                    delete pendingChanges[storageKey][field];
                    if (Object.keys(pendingChanges[storageKey]).length === 0) delete pendingChanges[storageKey];
                }
            }

            // Auto-recalculate total when fuel_payment or transport changes
            if (field === 'fuel_payment' || field === 'transport') {
                const servicePayment = order.service_payment || 0;
                const fuelVal = pendingChanges[storageKey]?.fuel_payment ?? calc.fuel_payment ?? order.fuel_payment ?? 0;
                const transportVal = pendingChanges[storageKey]?.transport ?? calc.transport ?? order.transport ?? 0;
                const newTotal = servicePayment + fuelVal + transportVal;
                
                if (!pendingChanges[storageKey]) pendingChanges[storageKey] = {};
                pendingChanges[storageKey].total = newTotal;
            }

            renderTable();
        }

        function editOrderField(idx, field, orderId) {
            const order = ordersData[idx];
            const currentVal = pendingOrderChanges[orderId]?.[field] ?? order[field] ?? '';

            const cellId = field === 'order_code' ? `cell-ordercode-${idx}` : `cell-address-${idx}`;
            const cell = document.getElementById(cellId);

            // Create input element safely
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentVal;
            input.placeholder = field === 'order_code' ? '–ö–æ–¥' : '–ê–¥—Ä–µ—Å';
            input.onblur = function() { saveOrderField(idx, field, orderId, this); };
            input.onkeypress = function(e) { if (e.key === 'Enter') this.blur(); };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function saveOrderField(idx, field, orderId, input) {
            const newVal = input.value.trim();
            const order = ordersData[idx];
            const originalVal = order[field] ?? '';

            if (newVal !== originalVal) {
                if (!pendingOrderChanges[orderId]) pendingOrderChanges[orderId] = {};
                pendingOrderChanges[orderId][field] = newVal;
            } else {
                if (pendingOrderChanges[orderId]) {
                    delete pendingOrderChanges[orderId][field];
                    if (Object.keys(pendingOrderChanges[orderId]).length === 0) delete pendingOrderChanges[orderId];
                }
            }

            renderTable();
        }

        async function addNewRow() {
            try {
                const response = await Security.fetch(`/api/upload/${uploadId}/worker/${encodeURIComponent(workerName)}/add-row`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ order_code: '', address: '', fuel_payment: 0, transport: 0, total: 0 })
                });

                const data = await response.json();

                if (data.success) {
                    const newOrder = data.order;
                    newOrder._isNew = true;
                    ordersData.push(newOrder);
                    renderTable();

                    setTimeout(() => {
                        const cell = document.getElementById(`cell-ordercode-${ordersData.length - 1}`);
                        if (cell) {
                            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            cell.click();
                        }
                    }, 100);
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deleteOrder(orderId, idx) {
            const order = ordersData[idx];
            const confirmText = order.order_code || order.address || '—Å—Ç—Ä–æ–∫—É';
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${confirmText}?`)) return;

            try {
                const response = await Security.fetch(`/api/order/${orderId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    ordersData.splice(idx, 1);
                    renderTable();
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function saveChanges() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                const promises = [];

                for (const [key, changes] of Object.entries(pendingChanges)) {
                    // Check if this is an order-based key (order_123) or calc-based key (123)
                    if (key.startsWith('order_')) {
                        // Use order endpoint for missing calculation_id
                        const orderId = key.replace('order_', '');
                        promises.push(Security.fetch(`/api/order/${orderId}/calculation`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(changes)
                        }));
                    } else if (key && key !== 'undefined' && key !== 'null') {
                        // Use calculation endpoint
                        promises.push(Security.fetch(`/api/calculation/${key}/update`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(changes)
                        }));
                    } else {
                        console.error('Invalid key, skipping:', key, changes);
                    }
                }

                for (const [orderId, changes] of Object.entries(pendingOrderChanges)) {
                    promises.push(Security.fetch(`/api/order/${orderId}/update`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(changes)
                    }));
                }

                const results = await Promise.all(promises);

                if (results.every(r => r.ok)) {
                    pendingChanges = {};
                    pendingOrderChanges = {};
                    ordersData.forEach(o => delete o._isNew);
                    alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                    await loadWorkerData();
                } else {
                    throw new Error('–ù–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }

            saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            saveBtn.disabled = Object.keys(pendingChanges).length === 0 && Object.keys(pendingOrderChanges).length === 0;
        }

        function formatNumber(val) {
            if (val === null || val === undefined || val === '' || val === 0) return '-';
            return Math.round(val).toLocaleString('ru-RU');
        }

        // 1C Modal - with XSS protection
        function showOrderInfo(orderCode) {
            // Validate order code format
            if (!/^[–ê-–Ø–∞-—èA-Za-z]+-\d+$/.test(orderCode)) {
                alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ –∑–∞–∫–∞–∑–∞');
                return;
            }

            const modal = document.getElementById('orderModal');
            const modalBody = document.getElementById('modalBody');
            
            // ‚úÖ XSS FIX: use textContent
            Security.setText(document.getElementById('modalOrderNumber'), `–ó–∞–∫–∞–∑ ${orderCode}`);
            modal.classList.add('show');

            modalBody.innerHTML = `<div class="modal-loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ 1–°...</p></div>`;

            Security.fetch(`/api/1c/order/${encodeURIComponent(orderCode)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        renderOrderInfo(data.order);
                    } else {
                        // ‚úÖ XSS FIX: escape error message
                        modalBody.innerHTML = `
                            <div class="modal-error">‚ùå ${escapeHtml(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å')}</div>
                            <div class="integration-notice"><strong>‚ÑπÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°</strong><br>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HTTP-—Å–µ—Ä–≤–∏—Å –≤ 1–°.</div>
                        `;
                    }
                })
                .catch(err => {
                    // ‚úÖ XSS FIX: escape error message
                    modalBody.innerHTML = `
                        <div class="modal-error">‚ùå ${escapeHtml(err.message)}</div>
                        <div class="integration-notice"><strong>‚ÑπÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°</strong><br>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HTTP-—Å–µ—Ä–≤–∏—Å –≤ 1–°.</div>
                    `;
                });
        }

        function renderOrderInfo(order) {
            const modalBody = document.getElementById('modalBody');

            let statusClass = 'status-unpaid', statusText = '–ù–µ –æ–ø–ª–∞—á–µ–Ω';
            if (order.amounts.debt <= 0) { statusClass = 'status-paid'; statusText = '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ'; }
            else if (order.amounts.paid > 0) { statusClass = 'status-partial'; statusText = '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ'; }

            // ‚úÖ XSS FIX: escape all order data
            let paymentsHtml = order.payments?.length > 0 
                ? order.payments.map(p => `
                    <div class="payment-item">
                        <div><strong>${escapeHtml(new Date(p.date).toLocaleDateString('ru-RU'))}</strong> ‚Äî ${escapeHtml(p.document || '–û–ø–ª–∞—Ç–∞')}</div>
                        <div class="payment-amount">+${escapeHtml(p.amount.toLocaleString('ru-RU'))} ‚ÇΩ</div>
                    </div>
                `).join('')
                : '<p style="color:#999">–û–ø–ª–∞—Ç –Ω–µ—Ç</p>';

            modalBody.innerHTML = `
                <div class="order-info-grid">
                    <div class="order-info-label">–î–∞—Ç–∞:</div>
                    <div class="order-info-value">${escapeHtml(new Date(order.date).toLocaleDateString('ru-RU'))}</div>
                    <div class="order-info-label">–ö–ª–∏–µ–Ω—Ç:</div>
                    <div class="order-info-value">${escapeHtml(order.client?.name || '-')}</div>
                    <div class="order-info-label">–ò–ù–ù:</div>
                    <div class="order-info-value">${escapeHtml(order.client?.inn || '-')}</div>
                    <div class="order-info-label">–°—Ç–∞—Ç—É—Å:</div>
                    <div class="order-info-value">${escapeHtml(order.status || '-')}</div>
                </div>
                <div class="amounts-summary">
                    <div class="amounts-row"><span>–°—É–º–º–∞:</span><span>${escapeHtml(order.amounts.total.toLocaleString('ru-RU'))} ‚ÇΩ</span></div>
                    <div class="amounts-row"><span>–û–ø–ª–∞—á–µ–Ω–æ:</span><span>${escapeHtml(order.amounts.paid.toLocaleString('ru-RU'))} ‚ÇΩ</span></div>
                    <div class="amounts-row total"><span>–î–æ–ª–≥:</span><span>${escapeHtml(order.amounts.debt.toLocaleString('ru-RU'))} ‚ÇΩ</span></div>
                </div>
                <div class="order-status ${statusClass}">${statusText}</div>
                <h3 style="margin:20px 0 12px">üí∞ –û–ø–ª–∞—Ç—ã</h3>
                ${paymentsHtml}
            `;
        }

        function closeOrderModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('orderModal').classList.remove('show');
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOrderModal(); });

        // Highlight order from search
        function highlightOrderFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const highlight = params.get('highlight');
            if (!highlight) return;
            
            // Wait for table to render
            setTimeout(() => {
                const row = document.querySelector(`tr[data-order-code="${highlight}"]`);
                if (row) {
                    row.classList.add('highlight-order');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }

        loadWorkerData();
        highlightOrderFromUrl();
    </script>
</body>
</html>
