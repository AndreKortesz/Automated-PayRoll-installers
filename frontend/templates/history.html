<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤ | Mos-GSM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/security.js"></script>
    <style>
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .page-title { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--black); }
        .page-actions { display: flex; gap: 12px; }
        .month-card { background: var(--white); border-radius: var(--radius-lg); margin-bottom: 24px; box-shadow: var(--shadow-soft); overflow: hidden; }
        .month-header { background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%); padding: 20px 28px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .month-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--black); }
        .month-badge { background: var(--black); color: var(--white); font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 14px; padding: 8px 16px; border-radius: 20px; }
        .month-content { padding: 24px; }
        .period-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; background: var(--gray-light); border-radius: var(--radius-md); margin-bottom: 12px; transition: all 0.2s ease; }
        .period-item:last-child { margin-bottom: 0; }
        .period-item:hover { transform: translateX(4px); box-shadow: var(--shadow-soft); }
        .period-info { flex: 1; }
        .period-name { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--black); margin-bottom: 4px; }
        .period-meta { font-size: 13px; color: var(--gray-dark); }
        .period-stats { display: flex; gap: 24px; margin-right: 24px; }
        .period-stat { text-align: center; }
        .period-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 22px; line-height: 1; }
        .period-stat-value.green { color: var(--green); }
        .period-stat-value.orange { color: var(--orange); }
        .period-stat-label { font-size: 10px; color: var(--gray-dark); text-transform: uppercase; margin-top: 2px; }
        .period-actions { display: flex; gap: 8px; align-items: center; }
        .icon-btn { width: 40px; height: 40px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; text-decoration: none; }
        .icon-btn.download { background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); }
        .icon-btn.download:hover { transform: scale(1.1); }
        .icon-btn.download svg { width: 20px; height: 20px; fill: white; }
        .icon-btn.workers { background: var(--gray); }
        .icon-btn.workers:hover { background: var(--gray-dark); }
        .icon-btn.workers svg { width: 20px; height: 20px; fill: white; }
        .period-link { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; font-size: 14px; color: var(--yellow-dark); text-decoration: none; padding: 10px 16px; border-radius: var(--radius-sm); transition: all 0.2s; text-transform: uppercase; background: rgba(243, 192, 77, 0.1); }
        .period-link:hover { background: var(--yellow); color: var(--black); }
        .icon-btn.delete { background: rgba(220, 53, 69, 0.1); }
        .icon-btn.delete:hover { background: #dc3545; }
        .icon-btn.delete svg { width: 20px; height: 20px; fill: #dc3545; }
        .icon-btn.delete:hover svg { fill: white; }
        @media (max-width: 1024px) { .period-stats { display: none; } }
        @media (max-width: 768px) { .page-title { font-size: 36px; } .period-item { flex-direction: column; align-items: flex-start; gap: 16px; } .period-actions { width: 100%; justify-content: flex-end; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link active">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
            {% if user and user.role == 'admin' %}<a href="/duplicates" class="nav-link">–î—É–±–ª–∏</a>{% endif %}
        </nav>
        
        <!-- Search Component -->
        <div class="search-wrapper">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤..." autocomplete="off">
            </div>
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        
        {% if user %}
        <div class="user-info">
            <span class="user-name">
                {% if user.role == 'admin' %}üëë{% else %}üë§{% endif %}
                {{ user.name | e }}
            </span>
            <span class="user-role {% if user.role == 'admin' %}role-admin{% else %}role-employee{% endif %}">
                {{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if user.role == 'admin' else '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}
            </span>
            <a href="/auth/logout" class="logout-btn" title="–í—ã–π—Ç–∏">
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </a>
        </div>
        {% endif %}
    </header>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤</h1>
            <div class="page-actions">
                <a href="/comparison" class="btn btn-secondary">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
                <a href="/" class="btn btn-primary">+ –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</a>
            </div>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stats-card"><div class="stats-icon yellow"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg></div><div class="stats-content"><div class="stats-value" id="statMonths">-</div><div class="stats-label">–ú–µ—Å—è—Ü–µ–≤</div></div></div>
            <div class="stats-card"><div class="stats-icon dark"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg></div><div class="stats-content"><div class="stats-value" id="statPeriods">-</div><div class="stats-label">–ü–µ—Ä–∏–æ–¥–æ–≤</div></div></div>
            <div class="stats-card"><div class="stats-icon green"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value" id="statCompany">-</div><div class="stats-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div></div>
            <div class="stats-card"><div class="stats-icon orange"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg></div><div class="stats-content"><div class="stats-value" id="statClient">-</div><div class="stats-label">–ö–ª–∏–µ–Ω—Ç—ã</div></div></div>
        </div>

        <div id="content"><div class="loading" id="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div></div>
    </main>

    <script>
        const monthNames = {'01': '–Ø–Ω–≤–∞—Ä—å', '02': '–§–µ–≤—Ä–∞–ª—å', '03': '–ú–∞—Ä—Ç', '04': '–ê–ø—Ä–µ–ª—å', '05': '–ú–∞–π', '06': '–ò—é–Ω—å', '07': '–ò—é–ª—å', '08': '–ê–≤–≥—É—Å—Ç', '09': '–°–µ–Ω—Ç—è–±—Ä—å', '10': '–û–∫—Ç—è–±—Ä—å', '11': '–ù–æ—è–±—Ä—å', '12': '–î–µ–∫–∞–±—Ä—å'};

        async function loadHistory() {
            try {
                const response = await Security.fetch('/api/periods');
                const data = await response.json();
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';
                if (!data.success) throw new Error(data.error);

                const months = data.months || [];
                if (months.length === 0) {
                    document.getElementById('content').innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg></div><h3 class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3><p class="empty-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</p><a href="/" class="btn btn-primary">–ù–∞—á–∞—Ç—å —Ä–∞—Å—á—ë—Ç</a></div>';
                    return;
                }

                let totalPeriods = 0, totalCompany = 0, totalClient = 0;
                months.forEach(m => { totalPeriods += m.periods.length; m.periods.forEach(p => { totalCompany += p.company_amount || 0; totalClient += p.client_amount || 0; }); });

                document.getElementById('statMonths').textContent = months.length;
                document.getElementById('statPeriods').textContent = totalPeriods;
                document.getElementById('statCompany').textContent = formatCurrency(totalCompany);
                document.getElementById('statClient').textContent = formatCurrency(totalClient);

                let html = '';
                months.forEach(month => {
                    const [year, monthNum] = month.month.split('-');
                    html += `<div class="month-card"><div class="month-header"><span class="month-title">${escapeHtml(monthNames[monthNum] || monthNum)} ${escapeHtml(year)}</span><span class="month-badge">${month.periods.length} –ø–µ—Ä–∏–æ–¥(–æ–≤)</span></div><div class="month-content">`;
                    month.periods.forEach(period => {
                        const createdDate = period.created_at ? new Date(period.created_at).toLocaleDateString('ru-RU') : '';
                        const company = period.company_amount || 0;
                        const client = period.client_amount || 0;
                        const total = period.total_amount || (company + client);
                        html += `<div class="period-item"><div class="period-info"><div class="period-name">üìÖ ${escapeHtml(period.name)}</div><div class="period-meta">–°–æ–∑–¥–∞–Ω: ${escapeHtml(createdDate)} ‚Ä¢ –ò—Ç–æ–≥–æ: ${formatCurrency(total)}</div></div>
                            <div class="period-stats"><div class="period-stat"><div class="period-stat-value green">${formatCurrencyShort(company)}</div><div class="period-stat-label">–ö–æ–º–ø–∞–Ω–∏—è</div></div><div class="period-stat"><div class="period-stat-value orange">${formatCurrencyShort(client)}</div><div class="period-stat-label">–ö–ª–∏–µ–Ω—Ç</div></div></div>
                            <div class="period-actions">${period.latest_upload_id ? `<a href="/api/period/${period.id}/download/full" class="icon-btn download" title="–°–∫–∞—á–∞—Ç—å"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></a>` : ''}<a href="/period/${period.id}" class="period-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a><button class="icon-btn delete" title="–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–∏–æ–¥" onclick="deletePeriod(${period.id}, '${escapeHtml(period.name)}')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div></div>`;
                    });
                    html += '</div></div>';
                });
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="empty-state"><div class="empty-icon">‚ùå</div><h3 class="empty-title">–û—à–∏–±–∫–∞</h3><p class="empty-text">${escapeHtml(error.message)}</p><button class="btn btn-primary" onclick="loadHistory()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
            }
        }

        function formatCurrency(value) { if (value >= 1000000) return (value / 1000000).toFixed(1) + ' –º–ª–Ω ‚ÇΩ'; return Math.round(value).toLocaleString('ru-RU') + ' ‚ÇΩ'; }
        function formatCurrencyShort(value) { if (value >= 1000000) return (value / 1000000).toFixed(1) + '–ú'; if (value >= 1000) return Math.round(value / 1000) + '–ö'; return Math.round(value).toString(); }

        async function deletePeriod(periodId, periodName) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–∏–æ–¥ "${periodName}"?\n\n–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!`)) {
                return;
            }
            try {
                const response = await fetch(`/api/period/${periodId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                const data = await response.json();
                if (data.success) { 
                    alert(data.message || '–ü–µ—Ä–∏–æ–¥ —É–¥–∞–ª—ë–Ω'); 
                    // Redirect to history page or reload
                    if (window.location.pathname === '/history') {
                        loadHistory();
                    } else {
                        window.location.href = '/history';
                    }
                }
                else { alert('–û—à–∏–±–∫–∞: ' + (data.detail || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')); }
            } catch (error) { alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }

        // ===== Global Search =====
        (function() {
            const searchInput = document.getElementById('globalSearch');
            const searchDropdown = document.getElementById('searchDropdown');
            if (!searchInput || !searchDropdown) return;

            let searchTimeout = null;
            let currentQuery = '';

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function highlightMatch(text, query) {
                if (!text || !query) return escapeHtml(text);
                const escaped = escapeHtml(text);
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return escaped.replace(regex, '<span class="search-highlight">$1</span>');
            }

            function formatNum(num) {
                if (!num) return '0';
                return Math.round(num).toLocaleString('ru-RU');
            }

            function truncate(str, len) {
                if (!str) return '';
                return str.length > len ? str.substring(0, len) + '...' : str;
            }

            async function doSearch(query) {
                if (query.length < 2) {
                    searchDropdown.classList.remove('active');
                    return;
                }

                searchDropdown.innerHTML = '<div class="search-loading"><div class="search-loading-spinner"></div></div>';
                searchDropdown.classList.add('active');

                try {
                    const response = await Security.fetch(`/api/search?q=${encodeURIComponent(query)}&limit=6`);
                    const data = await response.json();

                    if (!data.success || currentQuery !== query) return;

                    const results = data.results || [];
                    
                    if (results.length === 0) {
                        searchDropdown.innerHTML = `
                            <div class="search-empty">
                                <svg class="search-empty-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <div class="search-empty-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="search-dropdown-header">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>';
                    results.forEach(r => {
                        const typeClass = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'client' : 'company';
                        const icon = r.type === '–ö–ª–∏–µ–Ω—Ç' ? 'üë§' : 'üè¢';
                        const orderDate = r.order_date ? ` –æ—Ç ${r.order_date}` : '';
                        html += `
                            <a href="/upload/${r.upload_id}?worker=${encodeURIComponent(r.worker)}" class="search-result-item">
                                <div class="search-result-icon ${typeClass}">${icon}</div>
                                <div class="search-result-content">
                                    <div class="search-result-title">
                                        <span class="search-result-order">${highlightMatch(r.order_code, query)}${orderDate}</span>
                                        <span class="search-result-period">${escapeHtml(r.period_name)}</span>
                                    </div>
                                    <div class="search-result-meta">
                                        <span class="search-result-worker">${highlightMatch(r.worker, query)}</span>
                                        <span>‚Ä¢</span>
                                        <span class="search-result-address">${highlightMatch(truncate(r.address, 40), query)}</span>
                                    </div>
                                </div>
                                <div class="search-result-right">
                                    <div class="search-result-total">${formatNum(r.total)} ‚ÇΩ</div>
                                    <span class="search-result-type ${typeClass}">${r.type}</span>
                                </div>
                            </a>
                        `;
                    });

                    html += `
                        <a href="/search?q=${encodeURIComponent(query)}" class="search-all-link">
                            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </a>
                    `;
                    
                    searchDropdown.innerHTML = html;

                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            searchInput.addEventListener('input', (e) => {
                currentQuery = e.target.value.trim();
                clearTimeout(searchTimeout);
                
                if (currentQuery.length < 2) {
                    searchDropdown.classList.remove('active');
                    return;
                }

                searchTimeout = setTimeout(() => doSearch(currentQuery), 300);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && currentQuery.length >= 2) {
                    window.location.href = `/search?q=${encodeURIComponent(currentQuery)}`;
                }
            });

            searchInput.addEventListener('focus', () => {
                if (currentQuery.length >= 2) {
                    searchDropdown.classList.add('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-wrapper')) {
                    searchDropdown.classList.remove('active');
                }
            });
        })();

        loadHistory();
    </script>
</body>
</html>
