<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π | Mos-GSM</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .review-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .review-title {
            font-size: 24px;
            font-weight: 700;
            color: #1A1A1A;
        }
        .review-period {
            font-size: 16px;
            color: #666;
        }
        .section-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .section-icon {
            font-size: 24px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1A1A1A;
        }
        .section-badge {
            background: #F3C04D;
            color: #1A1A1A;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .item-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #ccc;
        }
        .item-card.added { border-left-color: #28a745; background: #f0fff4; }
        .item-card.deleted { border-left-color: #dc3545; background: #fff5f5; }
        .item-card.modified { border-left-color: #ffc107; background: #fffbeb; }
        .item-card.manager { border-left-color: #6f42c1; background: #f8f5ff; }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .item-order {
            font-weight: 600;
            color: #1A1A1A;
        }
        .item-worker {
            color: #666;
            font-size: 14px;
        }
        .item-details {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .item-comment {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-style: italic;
        }
        .manager-comment-text {
            background: #6f42c1;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: 500;
        }
        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-apply {
            background: #28a745;
            color: white;
        }
        .btn-apply:hover { background: #218838; }
        .btn-apply.active {
            background: #218838;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        .btn-reject:hover { background: #c82333; }
        .btn-reject.active {
            background: #c82333;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }
        .btn-skip {
            background: #6c757d;
            color: white;
        }
        .btn-skip:hover { background: #5a6268; }
        
        .bottom-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            bottom: 24px;
        }
        .btn-primary {
            background: #F3C04D;
            color: #1A1A1A;
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover { background: #e5b347; }
        .btn-secondary {
            background: #f8f9fa;
            color: #1A1A1A;
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: #e9ecef; }
        
        .summary-stats {
            display: flex;
            gap: 24px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1A1A1A;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .empty-section {
            text-align: center;
            padding: 32px;
            color: #666;
        }
        
        .calculated-payment {
            margin-top: 8px;
            padding: 8px 12px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        .calculated-payment strong {
            color: #28a745;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F3C04D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <div class="logo-bars">
                        <span></span><span></span><span></span><span></span>
                    </div>
                </div>
                <span class="logo-text">Mos-GSM</span>
            </a>
            <nav class="nav">
                <a href="/" class="nav-link">–ì–õ–ê–í–ù–ê–Ø</a>
            </nav>
        </div>
    </header>

    <main class="review-container" id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    </main>

    <script>
        let sessionId = null;
        let reviewData = null;
        let selections = {
            deleted: [],      // order keys to restore
            added: [],        // order keys to skip (not add)
            modified: [],     // order keys to revert to old values
            manager_comments: {}  // order_key: true/false (apply/reject)
        };

        // Get session_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('session_id');

        if (!sessionId) {
            document.getElementById('content').innerHTML = `
                <div class="section-card">
                    <div class="empty-section">
                        <h2>‚ùå –°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∑–∞–Ω–æ–≤–æ</p>
                        <a href="/" class="btn-primary" style="display: inline-block; margin-top: 16px; text-decoration: none;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                    </div>
                </div>
            `;
        } else {
            loadReviewData();
        }

        async function loadReviewData() {
            try {
                const response = await fetch(`/api/review/${sessionId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
                
                reviewData = data;
                renderReview();
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="section-card">
                        <div class="empty-section">
                            <h2>‚ùå –û—à–∏–±–∫–∞</h2>
                            <p>${error.message}</p>
                            <a href="/" class="btn-primary" style="display: inline-block; margin-top: 16px; text-decoration: none;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                        </div>
                    </div>
                `;
            }
        }

        function formatCurrency(value) {
            return Math.round(value || 0).toLocaleString('ru-RU');
        }

        function extractOrderCode(orderText) {
            const match = orderText.match(/(–ö–ê–£–¢|–ò–ë–£–¢|–¢–î–£–¢)-\d+/);
            return match ? match[0] : '';
        }

        function renderReview() {
            const changes = reviewData.changes || {};
            const managerComments = reviewData.manager_comments || [];
            const parseWarnings = reviewData.parse_warnings || [];
            const period = reviewData.period || '';
            const prevVersion = reviewData.previous_version || 1;
            
            const hasChanges = (changes.added?.length > 0) || 
                              (changes.deleted?.length > 0) || 
                              (changes.modified?.length > 0);
            const hasManagerComments = managerComments.length > 0;
            const hasWarnings = parseWarnings.length > 0;
            
            let html = `
                <div class="review-header">
                    <div>
                        <h1 class="review-title">üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π</h1>
                        <p class="review-period">–ü–µ—Ä–∏–æ–¥: ${period} | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≤–µ—Ä—Å–∏–µ–π ${prevVersion}</p>
                    </div>
                </div>
            `;
            
            // WARNINGS SECTION (show first, most important!)
            if (hasWarnings) {
                html += `
                    <div class="section-card" style="border: 2px solid #dc3545; background: #fff5f5;">
                        <div class="section-header">
                            <span class="section-icon">üö®</span>
                            <span class="section-title" style="color: #dc3545;">–í–ù–ò–ú–ê–ù–ò–ï! –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏</span>
                            <span class="section-badge" style="background: #dc3545; color: white;">${parseWarnings.length}</span>
                        </div>
                        <p style="color: #dc3545; margin-bottom: 16px; font-weight: 500;">
                            –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ 1–°!
                        </p>
                `;
                
                parseWarnings.forEach((warning) => {
                    html += `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">‚õî</span>
                                <div>
                                    <div style="font-weight: 600; color: #721c24; font-size: 16px;">${warning.message}</div>
                                    <div style="color: #721c24; margin-top: 4px;">
                                        –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤. 
                                        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ 1–° –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ.
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Manager Comments Section
            if (hasManagerComments) {
                html += `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-icon">üí¨</span>
                            <span class="section-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</span>
                            <span class="section-badge">${managerComments.length}</span>
                        </div>
                        <p style="color: #666; margin-bottom: 16px;">
                            –ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –æ–ø–ª–∞—Ç–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤. 
                            –í—ã–±–µ—Ä–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –∏–ª–∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å" –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞.
                        </p>
                `;
                
                // Separate actionable and info comments
                const actionableComments = managerComments.filter(c => c.parsed?.type === 'percent' || c.parsed?.type === 'fixed');
                const infoComments = managerComments.filter(c => c.parsed?.type === 'info');
                
                // Actionable comments (require decision)
                if (actionableComments.length > 0) {
                    html += `<h4 style="color: #6f42c1; margin-bottom: 12px;">‚ö° –¢—Ä–µ–±—É—é—Ç —Ä–µ—à–µ–Ω–∏—è (${actionableComments.length})</h4>`;
                    
                    actionableComments.forEach((item, idx) => {
                        const orderCode = extractOrderCode(item.order);
                        const key = orderCode + '_' + item.worker;
                        const parsed = item.parsed || {};
                        
                        // Initialize selection as null (not decided)
                        if (!(key in selections.manager_comments)) {
                            selections.manager_comments[key] = null;
                        }
                        
                        // Calculate what the payment would be if applied
                        let calculatedPayment = '';
                        if (parsed.type === 'percent') {
                            const newPayment = (item.revenue_services || 0) * (parsed.value / 100);
                            calculatedPayment = `${parsed.value}% –æ—Ç ${formatCurrency(item.revenue_services)} ‚ÇΩ = <strong>${formatCurrency(newPayment)} ‚ÇΩ</strong>`;
                        } else if (parsed.type === 'fixed') {
                            calculatedPayment = `–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞: <strong>${formatCurrency(parsed.value)} ‚ÇΩ</strong>`;
                        }
                        
                        html += `
                            <div class="item-card manager" id="manager-${idx}">
                                <div class="item-header">
                                    <div>
                                        <div class="item-order">${orderCode || '–ó–∞–∫–∞–∑'}</div>
                                        <div class="item-worker">üë∑ ${item.worker}</div>
                                    </div>
                                </div>
                                <div class="manager-comment-text">
                                    üí¨ "${item.comment}"
                                </div>
                                ${calculatedPayment ? `<div class="calculated-payment">üìä –†–∞—Å—á—ë—Ç: ${calculatedPayment}</div>` : ''}
                                <div class="item-details">
                                    –¢–µ–∫—É—â–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É: ${formatCurrency(item.current_service_payment)} ‚ÇΩ
                                </div>
                                <div class="item-actions">
                                    <button class="btn-action btn-apply" onclick="setManagerSelection('${key}', true, ${idx})">
                                        ‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                                    </button>
                                    <button class="btn-action btn-reject" onclick="setManagerSelection('${key}', false, ${idx})">
                                        ‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Info comments (just for display, no decision needed)
                if (infoComments.length > 0) {
                    html += `<h4 style="color: #17a2b8; margin: 24px 0 12px;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (${infoComments.length})</h4>`;
                    
                    infoComments.forEach((item) => {
                        const orderCode = extractOrderCode(item.order);
                        
                        html += `
                            <div class="item-card" style="border-left-color: #17a2b8; background: #e8f4f8;">
                                <div class="item-header">
                                    <div>
                                        <div class="item-order">${orderCode || '–ó–∞–∫–∞–∑'}</div>
                                        <div class="item-worker">üë∑ ${item.worker}</div>
                                    </div>
                                    <span style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                                </div>
                                <div style="background: #17a2b8; color: white; padding: 8px 12px; border-radius: 8px; margin-top: 8px;">
                                    üí¨ "${item.comment}"
                                </div>
                                <div class="item-details" style="margin-top: 8px; font-style: italic; color: #666;">
                                    –ó–∞–º–µ—Ç–∫–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
            }
            
            // Added Section
            if (changes.added?.length > 0) {
                html += `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-icon">‚ûï</span>
                            <span class="section-title">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</span>
                            <span class="section-badge">${changes.added.length}</span>
                        </div>
                `;
                
                changes.added.forEach((item, idx) => {
                    const key = item.order_code + '_' + item.worker;
                    html += `
                        <div class="item-card added" id="added-${idx}">
                            <div class="item-header">
                                <div>
                                    <div class="item-order">${item.order_code || '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑'}</div>
                                    <div class="item-worker">üë∑ ${item.worker}</div>
                                </div>
                            </div>
                            <div class="item-details">
                                ${item.address || ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-action btn-apply active" onclick="toggleAdded('${key}', ${idx}, false)">
                                    ‚úì –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                                <button class="btn-action btn-skip" onclick="toggleAdded('${key}', ${idx}, true)">
                                    ‚úï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Deleted Section
            if (changes.deleted?.length > 0) {
                html += `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-icon">‚ûñ</span>
                            <span class="section-title">–£–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</span>
                            <span class="section-badge">${changes.deleted.length}</span>
                        </div>
                        <p style="color: #666; margin-bottom: 16px;">
                            –≠—Ç–∏ –∑–∞–∫–∞–∑—ã –±—ã–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö
                        </p>
                `;
                
                changes.deleted.forEach((item, idx) => {
                    const key = item.order_code + '_' + item.worker;
                    html += `
                        <div class="item-card deleted" id="deleted-${idx}">
                            <div class="item-header">
                                <div>
                                    <div class="item-order">${item.order_code || '–ó–∞–∫–∞–∑'}</div>
                                    <div class="item-worker">üë∑ ${item.worker}</div>
                                </div>
                            </div>
                            <div class="item-details">
                                ${item.address || ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-action btn-reject active" onclick="toggleDeleted('${key}', ${idx}, false)">
                                    ‚úï –£–¥–∞–ª–∏—Ç—å
                                </button>
                                <button class="btn-action btn-apply" onclick="toggleDeleted('${key}', ${idx}, true)">
                                    ‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Modified Section
            if (changes.modified?.length > 0) {
                html += `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-icon">‚úèÔ∏è</span>
                            <span class="section-title">–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</span>
                            <span class="section-badge">${changes.modified.length}</span>
                        </div>
                `;
                
                changes.modified.forEach((item, idx) => {
                    const key = item.order_code + '_' + item.worker;
                    let changesText = (item.changes || []).map(c => 
                        `${c.field}: ${c.old} ‚Üí ${c.new}`
                    ).join(', ');
                    
                    html += `
                        <div class="item-card modified" id="modified-${idx}">
                            <div class="item-header">
                                <div>
                                    <div class="item-order">${item.order_code || '–ó–∞–∫–∞–∑'}</div>
                                    <div class="item-worker">üë∑ ${item.worker}</div>
                                </div>
                            </div>
                            <div class="item-details">
                                üìù ${changesText}
                            </div>
                            <div class="item-actions">
                                <button class="btn-action btn-apply active" onclick="toggleModified('${key}', ${idx}, false)">
                                    ‚úì –ü—Ä–∏–Ω—è—Ç—å –Ω–æ–≤—ã–µ
                                </button>
                                <button class="btn-action btn-skip" onclick="toggleModified('${key}', ${idx}, true)">
                                    ‚Ü© –û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // No changes message
            if (!hasChanges && !hasManagerComments) {
                html += `
                    <div class="section-card">
                        <div class="empty-section">
                            <h2>‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç</h2>
                            <p>–î–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π</p>
                        </div>
                    </div>
                `;
            }
            
            // Bottom actions
            html += `
                <div class="bottom-actions">
                    <a href="/" class="btn-secondary">‚Üê –û—Ç–º–µ–Ω–∞</a>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #28a745">${changes.added?.length || 0}</div>
                            <div class="stat-label">–î–æ–±–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #dc3545">${changes.deleted?.length || 0}</div>
                            <div class="stat-label">–£–¥–∞–ª–µ–Ω–æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #ffc107">${changes.modified?.length || 0}</div>
                            <div class="stat-label">–ò–∑–º–µ–Ω–µ–Ω–æ</div>
                        </div>
                        ${hasManagerComments ? `
                        <div class="stat-item">
                            <div class="stat-value" style="color: #6f42c1">${managerComments.length}</div>
                            <div class="stat-label">–û—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞</div>
                        </div>
                        ` : ''}
                    </div>
                    <button class="btn-primary" onclick="applyChanges()">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ‚Üí
                    </button>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        function setManagerSelection(key, apply, idx) {
            selections.manager_comments[key] = apply;
            
            // Update UI
            const card = document.getElementById(`manager-${idx}`);
            const applyBtn = card.querySelector('.btn-apply');
            const rejectBtn = card.querySelector('.btn-reject');
            
            applyBtn.classList.toggle('active', apply);
            rejectBtn.classList.toggle('active', !apply);
        }

        function toggleAdded(key, idx, skip) {
            if (skip) {
                if (!selections.added.includes(key)) {
                    selections.added.push(key);
                }
            } else {
                selections.added = selections.added.filter(k => k !== key);
            }
            
            const card = document.getElementById(`added-${idx}`);
            const addBtn = card.querySelector('.btn-apply');
            const skipBtn = card.querySelector('.btn-skip');
            
            addBtn.classList.toggle('active', !skip);
            skipBtn.classList.toggle('active', skip);
        }

        function toggleDeleted(key, idx, restore) {
            if (restore) {
                if (!selections.deleted.includes(key)) {
                    selections.deleted.push(key);
                }
            } else {
                selections.deleted = selections.deleted.filter(k => k !== key);
            }
            
            const card = document.getElementById(`deleted-${idx}`);
            const deleteBtn = card.querySelector('.btn-reject');
            const restoreBtn = card.querySelector('.btn-apply');
            
            deleteBtn.classList.toggle('active', !restore);
            restoreBtn.classList.toggle('active', restore);
        }

        function toggleModified(key, idx, revert) {
            if (revert) {
                if (!selections.modified.includes(key)) {
                    selections.modified.push(key);
                }
            } else {
                selections.modified = selections.modified.filter(k => k !== key);
            }
            
            const card = document.getElementById(`modified-${idx}`);
            const acceptBtn = card.querySelector('.btn-apply');
            const revertBtn = card.querySelector('.btn-skip');
            
            acceptBtn.classList.toggle('active', !revert);
            revertBtn.classList.toggle('active', revert);
        }

        async function applyChanges() {
            // Check if all actionable manager comments have been decided (skip info type)
            const managerComments = reviewData.manager_comments || [];
            const actionableComments = managerComments.filter(c => c.parsed?.type === 'percent' || c.parsed?.type === 'fixed');
            const undecided = actionableComments.filter(item => {
                const key = extractOrderCode(item.order) + '_' + item.worker;
                return selections.manager_comments[key] === null;
            });
            
            if (undecided.length > 0) {
                alert(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (${undecided.length} –Ω–µ —Ä–µ—à–µ–Ω–æ)`);
                return;
            }
            
            try {
                const btn = document.querySelector('.btn-primary');
                btn.disabled = true;
                btn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                
                const response = await fetch('/api/apply-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        selections: selections
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = `/period/${data.period_id}`;
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    btn.disabled = false;
                    btn.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ‚Üí';
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                const btn = document.querySelector('.btn-primary');
                btn.disabled = false;
                btn.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ‚Üí';
            }
        }
    </script>
</body>
</html>
