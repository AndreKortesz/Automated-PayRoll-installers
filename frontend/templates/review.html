<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Mos-GSM | –†–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/security.js"></script>
    <style>
        /* Additional styles for review page */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 42px;
            color: var(--black);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--gray-dark);
        }

        .info-banner {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .info-banner-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--blue) 0%, #0D47A1 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-banner-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--white);
        }

        .info-banner-content h3 {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #0D47A1;
            margin-bottom: 4px;
        }

        .info-banner-content p {
            font-size: 14px;
            color: #1565C0;
            line-height: 1.5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-soft);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.green { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
        .stat-icon.red { background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); }
        .stat-icon.orange { background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); }
        .stat-icon.blue { background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); }

        .stat-info { flex: 1; }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--black);
            line-height: 1;
        }

        .stat-label {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            color: var(--gray-dark);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .section {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-medium);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--black);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-badge {
            background: var(--gray-light);
            padding: 4px 12px;
            border-radius: 20px;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            font-weight: 700;
        }

        .section-badge.green { background: #E8F5E9; color: var(--green); }
        .section-badge.red { background: #FFEBEE; color: var(--red); }
        .section-badge.orange { background: #FFF3E0; color: var(--orange); }

        .section-actions { display: flex; gap: 8px; }

        .section-btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-btn.select-all { background: var(--green); color: var(--white); }
        .section-btn.select-none { background: var(--gray-light); color: var(--gray-dark); }
        .section-btn:hover { transform: scale(1.05); }

        .section-body { padding: 0; }

        .change-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-light);
            transition: background 0.2s;
        }

        .change-item:last-child { border-bottom: none; }
        .change-item:hover { background: var(--gray-light); }
        .change-item.selected { background: rgba(46, 125, 50, 0.05); }

        .change-checkbox { flex-shrink: 0; margin-top: 4px; }

        .change-checkbox input {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--yellow);
        }

        .change-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .change-icon.added { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
        .change-icon.deleted { background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); }
        .change-icon.modified { background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); }

        .change-content { flex: 1; min-width: 0; }

        .change-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .change-order {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 15px;
            color: var(--black);
        }

        .change-worker {
            font-size: 13px;
            color: var(--gray-dark);
            background: var(--gray-light);
            padding: 2px 10px;
            border-radius: 4px;
        }

        .change-address {
            font-size: 13px;
            color: var(--gray-dark);
            margin-bottom: 8px;
        }

        .change-details { display: flex; flex-wrap: wrap; gap: 8px; }

        .change-detail {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .change-detail.added { background: #E8F5E9; color: var(--green); }
        .change-detail.deleted { background: #FFEBEE; color: var(--red); }
        .change-detail.modified { background: #FFF3E0; color: var(--orange); }

        .change-detail .old-value { text-decoration: line-through; opacity: 0.7; }
        .change-detail .arrow { margin: 0 4px; }

        .change-action {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .change-action.restore { background: #E8F5E9; color: var(--green); }
        .change-action.skip { background: #FFEBEE; color: var(--red); }
        .change-action.keep-old { background: #FFF3E0; color: var(--orange); }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 16px 32px;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 99;
        }

        .footer-info { display: flex; gap: 24px; }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .footer-stat-icon.green { background: #E8F5E9; }
        .footer-stat-icon.red { background: #FFEBEE; }
        .footer-stat-icon.orange { background: #FFF3E0; }

        .footer-stat-text {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            color: var(--gray-dark);
        }

        .footer-stat-value { font-weight: 700; color: var(--black); }
        .footer-actions { display: flex; gap: 12px; }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .sticky-footer { flex-direction: column; gap: 12px; padding: 12px 16px; }
            .footer-info { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
        </nav>
    </header>

    <main class="main" style="padding-bottom: 100px;">
        <div class="page-header">
            <div>
                <h1 class="page-title">–†–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π</h1>
                <p class="page-subtitle" id="periodInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div>
                <a href="/" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    –û—Ç–º–µ–Ω–∞
                </a>
            </div>
        </div>

        <div class="info-banner">
            <div class="info-banner-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            </div>
            <div class="info-banner-content">
                <h3>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</h3>
                <p>–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π. 
                   –û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å.</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green">‚ûï</div>
                <div class="stat-info">
                    <div class="stat-value" id="addedCount">0</div>
                    <div class="stat-label">–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">‚ûñ</div>
                <div class="stat-info">
                    <div class="stat-value" id="deletedCount">0</div>
                    <div class="stat-label">–£–¥–∞–ª—ë–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">‚úèÔ∏è</div>
                <div class="stat-info">
                    <div class="stat-value" id="modifiedCount">0</div>
                    <div class="stat-label">–ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">‚úì</div>
                <div class="stat-info">
                    <div class="stat-value" id="selectedCount">0</div>
                    <div class="stat-label">–í—ã–±—Ä–∞–Ω–æ</div>
                </div>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</p>
            </div>
        </div>
    </main>

    <div class="sticky-footer" id="stickyFooter" style="display: none;">
        <div class="footer-info">
            <div class="footer-stat">
                <div class="footer-stat-icon green">‚ûï</div>
                <span class="footer-stat-text">–î–æ–±–∞–≤–∏—Ç—å: <span class="footer-stat-value" id="footerAdded">0</span></span>
            </div>
            <div class="footer-stat">
                <div class="footer-stat-icon red">‚ûñ</div>
                <span class="footer-stat-text">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: <span class="footer-stat-value" id="footerDeleted">0</span></span>
            </div>
            <div class="footer-stat">
                <div class="footer-stat-icon orange">‚úèÔ∏è</div>
                <span class="footer-stat-text">–û—Ç–∫–∞—Ç–∏—Ç—å: <span class="footer-stat-value" id="footerModified">0</span></span>
            </div>
        </div>
        <div class="footer-actions">
            <button class="btn btn-secondary" onclick="skipReview()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <button class="btn btn-success" id="applyBtn" onclick="applyChanges()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        
        let changesData = null;
        let selections = { added: {}, deleted: {}, modified: {} };

        document.addEventListener('DOMContentLoaded', () => {
            if (!sessionId) {
                showError('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            loadChanges();
        });

        async function loadChanges() {
            try {
                const response = await Security.fetch(`/api/review/${encodeURIComponent(sessionId)}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                changesData = data;
                
                // XSS-safe: use textContent
                Security.setText(document.getElementById('periodInfo'), 
                    `–ü–µ—Ä–∏–æ–¥: ${data.period} ‚Ä¢ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è: v${data.previous_version || 1}`);

                data.changes.added.forEach(c => selections.added[c.order_code + '_' + c.worker] = true);
                data.changes.deleted.forEach(c => selections.deleted[c.order_code + '_' + c.worker] = false);
                data.changes.modified.forEach(c => selections.modified[c.order_code + '_' + c.worker] = false);

                renderContent();
                updateStats();
                document.getElementById('stickyFooter').style.display = 'flex';

            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" style="background: #FFEBEE;">‚ùå</div>
                    <h3 class="empty-title">–û—à–∏–±–∫–∞</h3>
                    <p class="empty-text">${escapeHtml(message)}</p>
                    <a href="/" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            `;
        }

        function renderContent() {
            const { added, deleted, modified } = changesData.changes;

            if (added.length === 0 && deleted.length === 0 && modified.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon" style="background: #E8F5E9;">‚úÖ</div>
                        <h3 class="empty-title">–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p class="empty-text">–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏</p>
                        <button class="btn btn-success" onclick="skipReview()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    </div>
                `;
                document.getElementById('stickyFooter').style.display = 'none';
                return;
            }

            let html = '';

            if (added.length > 0) {
                html += renderSection('added', '–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã', added, 'green', '‚ûï');
            }

            if (deleted.length > 0) {
                html += renderSection('deleted', '–£–¥–∞–ª—ë–Ω–Ω—ã–µ / –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏', deleted, 'red', '‚ûñ');
            }

            if (modified.length > 0) {
                html += renderSection('modified', '–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', modified, 'orange', '‚úèÔ∏è');
            }

            document.getElementById('content').innerHTML = html;
        }

        function renderSection(type, title, items, colorClass, icon) {
            let itemsHtml = items.map((item, idx) => renderChangeItem(type, item, idx)).join('');
            
            return `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            ${icon} ${escapeHtml(title)}
                            <span class="section-badge ${colorClass}">${items.length}</span>
                        </h2>
                        <div class="section-actions">
                            <button class="section-btn select-all" onclick="selectAll('${type}', true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button class="section-btn select-none" onclick="selectAll('${type}', false)">–°–Ω—è—Ç—å –≤—Å–µ</button>
                        </div>
                    </div>
                    <div class="section-body">${itemsHtml}</div>
                </div>
            `;
        }

        function renderChangeItem(type, item, idx) {
            const key = item.order_code + '_' + item.worker;
            const isChecked = selections[type][key];
            const selectedClass = isChecked ? 'selected' : '';
            const isExtraRow = item.type === 'extra_row';

            let detailsHtml = '';
            let actionLabel = '';

            if (type === 'added') {
                actionLabel = isChecked ? 
                    '<span class="change-action restore">–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω</span>' : 
                    '<span class="change-action skip">–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å</span>';
                
                if (item.details) {
                    detailsHtml = Object.entries(item.details).map(([k, v]) => 
                        `<span class="change-detail added">${escapeHtml(k)}: ${escapeHtml(String(v))}</span>`
                    ).join('');
                }
            } else if (type === 'deleted') {
                actionLabel = isChecked ? 
                    '<span class="change-action restore">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>' : 
                    '<span class="change-action skip">–û—Å—Ç–∞–≤–∏—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–º</span>';
                
                if (item.details) {
                    detailsHtml = Object.entries(item.details).map(([k, v]) => 
                        `<span class="change-detail deleted">${escapeHtml(k)}: ${escapeHtml(String(v))}</span>`
                    ).join('');
                }
            } else if (type === 'modified') {
                actionLabel = isChecked ? 
                    '<span class="change-action keep-old">–û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</span>' : 
                    '<span class="change-action restore">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</span>';
                
                if (item.changes) {
                    detailsHtml = item.changes.map(c => 
                        `<span class="change-detail modified">
                            ${escapeHtml(c.field)}: 
                            <span class="old-value">${escapeHtml(String(c.old))}</span>
                            <span class="arrow">‚Üí</span>
                            ${escapeHtml(String(c.new))}
                        </span>`
                    ).join('');
                }
            }

            const displayAddress = item.address || (isExtraRow ? item.order_code : '');
            const extraBadge = isExtraRow ? '<span style="background: #E8F5E9; color: #2E7D32; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</span>' : '';

            return `
                <div class="change-item ${selectedClass}" id="item-${type}-${idx}">
                    <div class="change-checkbox">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                               onchange="toggleSelection('${type}', '${escapeAttr(key)}', ${idx})">
                    </div>
                    <div class="change-icon ${type}">${type === 'added' ? '‚ûï' : type === 'deleted' ? '‚ûñ' : '‚úèÔ∏è'}</div>
                    <div class="change-content">
                        <div class="change-header">
                            <span class="change-order">${isExtraRow ? 'üìù ' : ''}${escapeHtml(item.order_code || '')}</span>
                            <span class="change-worker">üë∑ ${escapeHtml(item.worker || '')}</span>
                            ${extraBadge}
                            ${actionLabel}
                        </div>
                        ${displayAddress && displayAddress !== item.order_code ? `<div class="change-address">üìç ${escapeHtml(displayAddress)}</div>` : ''}
                        <div class="change-details">${detailsHtml}</div>
                    </div>
                </div>
            `;
        }

        function toggleSelection(type, key, idx) {
            selections[type][key] = !selections[type][key];
            renderContent();
            updateStats();
        }

        function selectAll(type, value) {
            for (const key in selections[type]) {
                selections[type][key] = value;
            }
            renderContent();
            updateStats();
        }

        function updateStats() {
            const addedTotal = changesData.changes.added.length;
            const deletedTotal = changesData.changes.deleted.length;
            const modifiedTotal = changesData.changes.modified.length;

            const addedSelected = Object.values(selections.added).filter(v => v).length;
            const deletedSelected = Object.values(selections.deleted).filter(v => v).length;
            const modifiedSelected = Object.values(selections.modified).filter(v => v).length;

            document.getElementById('addedCount').textContent = addedTotal;
            document.getElementById('deletedCount').textContent = deletedTotal;
            document.getElementById('modifiedCount').textContent = modifiedTotal;
            document.getElementById('selectedCount').textContent = addedSelected + deletedSelected + modifiedSelected;

            document.getElementById('footerAdded').textContent = addedSelected;
            document.getElementById('footerDeleted').textContent = deletedSelected;
            document.getElementById('footerModified').textContent = modifiedSelected;
        }

        function skipReview() {
            proceedToCalculation({
                added: Object.keys(selections.added).filter(k => selections.added[k]),
                deleted: [],
                modified: []
            });
        }

        async function applyChanges() {
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.disabled = true;
            applyBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div> –û–±—Ä–∞–±–æ—Ç–∫–∞...';

            const selectedChanges = {
                added: Object.keys(selections.added).filter(k => selections.added[k]),
                deleted: Object.keys(selections.deleted).filter(k => selections.deleted[k]),
                modified: Object.keys(selections.modified).filter(k => selections.modified[k])
            };

            await proceedToCalculation(selectedChanges);
        }

        async function proceedToCalculation(selectedChanges) {
            try {
                const response = await Security.fetchJson('/api/apply-review', {
                    session_id: sessionId,
                    selections: selectedChanges
                }, 'POST');

                if (response.success && Security.isValidId(response.period_id)) {
                    Security.safeRedirect(`/period/${response.period_id}`);
                } else {
                    throw new Error(response.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.disabled = false;
                applyBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                `;
            }
        }
    </script>
</body>
</html>
