<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mos-GSM | –†–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --yellow: #F3C04D;
            --yellow-light: #f8d77e;
            --yellow-dark: #d4a63d;
            --black: #1A1A1A;
            --gray-dark: #4D4D4D;
            --gray: #D9D9D9;
            --gray-light: #F5F5F5;
            --white: #FFFFFF;
            --green: #2E7D32;
            --green-light: #4CAF50;
            --orange: #F57C00;
            --red: #D32F2F;
            --blue: #1565C0;
            --shadow-soft: 0 8px 32px rgba(26, 26, 26, 0.08);
            --shadow-medium: 0 12px 48px rgba(26, 26, 26, 0.12);
            --radius-sm: 12px;
            --radius-md: 20px;
            --radius-lg: 28px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--gray-light);
            color: var(--black);
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            background: var(--white);
            padding: 16px 32px;
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 32px;
        }

        .logo-bar {
            width: 6px;
            background: var(--yellow);
            border-radius: 3px;
            transition: height 0.3s ease;
        }

        .logo-bar:nth-child(1) { height: 8px; }
        .logo-bar:nth-child(2) { height: 14px; }
        .logo-bar:nth-child(3) { height: 20px; }
        .logo-bar:nth-child(4) { height: 26px; }
        .logo-bar:nth-child(5) { height: 32px; }

        .logo:hover .logo-bar:nth-child(1) { height: 14px; }
        .logo:hover .logo-bar:nth-child(2) { height: 20px; }
        .logo:hover .logo-bar:nth-child(3) { height: 26px; }
        .logo:hover .logo-bar:nth-child(4) { height: 20px; }
        .logo:hover .logo-bar:nth-child(5) { height: 14px; }

        .logo-text {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: var(--black);
        }

        .nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            text-decoration: none;
            color: var(--gray-dark);
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: var(--gray-light);
            color: var(--black);
        }

        /* ===== MAIN ===== */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        /* ===== PAGE HEADER ===== */
        .page-header {
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header-left {
            flex: 1;
        }

        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 42px;
            color: var(--black);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--gray-dark);
        }

        .page-actions {
            display: flex;
            gap: 12px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            color: var(--black);
            box-shadow: 0 4px 16px rgba(243, 192, 77, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(243, 192, 77, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-dark);
            border: 2px solid var(--gray);
        }

        .btn-secondary:hover {
            border-color: var(--black);
            color: var(--black);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--green) 0%, #1B5E20 100%);
            color: var(--white);
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(46, 125, 50, 0.4);
        }

        /* ===== INFO BANNER ===== */
        .info-banner {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .info-banner-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--blue) 0%, #0D47A1 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-banner-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--white);
        }

        .info-banner-content h3 {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #0D47A1;
            margin-bottom: 4px;
        }

        .info-banner-content p {
            font-size: 14px;
            color: #1565C0;
            line-height: 1.5;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-soft);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.green { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
        .stat-icon.red { background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); }
        .stat-icon.orange { background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); }
        .stat-icon.blue { background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--black);
            line-height: 1;
        }

        .stat-label {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            color: var(--gray-dark);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* ===== SECTION ===== */
        .section {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-medium);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--black);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-badge {
            background: var(--gray-light);
            padding: 4px 12px;
            border-radius: 20px;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            font-weight: 700;
        }

        .section-badge.green { background: #E8F5E9; color: var(--green); }
        .section-badge.red { background: #FFEBEE; color: var(--red); }
        .section-badge.orange { background: #FFF3E0; color: var(--orange); }

        .section-actions {
            display: flex;
            gap: 8px;
        }

        .section-btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-btn.select-all {
            background: var(--green);
            color: var(--white);
        }

        .section-btn.select-none {
            background: var(--gray-light);
            color: var(--gray-dark);
        }

        .section-btn:hover {
            transform: scale(1.05);
        }

        .section-body {
            padding: 0;
        }

        /* ===== CHANGE ITEM ===== */
        .change-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-light);
            transition: background 0.2s;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .change-item:hover {
            background: var(--gray-light);
        }

        .change-item.selected {
            background: rgba(46, 125, 50, 0.05);
        }

        .change-checkbox {
            flex-shrink: 0;
            margin-top: 4px;
        }

        .change-checkbox input {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--yellow);
        }

        .change-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .change-icon.added { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
        .change-icon.deleted { background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); }
        .change-icon.modified { background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); }

        .change-content {
            flex: 1;
            min-width: 0;
        }

        .change-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .change-order {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 15px;
            color: var(--black);
        }

        .change-worker {
            font-size: 13px;
            color: var(--gray-dark);
            background: var(--gray-light);
            padding: 2px 10px;
            border-radius: 4px;
        }

        .change-address {
            font-size: 13px;
            color: var(--gray-dark);
            margin-bottom: 8px;
        }

        .change-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .change-detail {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .change-detail.added {
            background: #E8F5E9;
            color: var(--green);
        }

        .change-detail.deleted {
            background: #FFEBEE;
            color: var(--red);
        }

        .change-detail.modified {
            background: #FFF3E0;
            color: var(--orange);
        }

        .change-detail .old-value {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .change-detail .arrow {
            margin: 0 4px;
        }

        .change-action {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .change-action.restore {
            background: #E8F5E9;
            color: var(--green);
        }

        .change-action.skip {
            background: #FFEBEE;
            color: var(--red);
        }

        .change-action.keep-old {
            background: #FFF3E0;
            color: var(--orange);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 32px;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
        }

        .empty-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--black);
            margin-bottom: 8px;
        }

        .empty-text {
            color: var(--gray-dark);
            margin-bottom: 24px;
        }

        /* ===== LOADING ===== */
        .loading {
            text-align: center;
            padding: 80px 32px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== STICKY FOOTER ===== */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 16px 32px;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-start;
            gap: 40px;
            align-items: center;
            z-index: 99;
        }

        .footer-info {
            display: flex;
            gap: 24px;
        }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .footer-stat-icon.green { background: #E8F5E9; }
        .footer-stat-icon.red { background: #FFEBEE; }
        .footer-stat-icon.orange { background: #FFF3E0; }

        .footer-stat-text {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            color: var(--gray-dark);
        }

        .footer-stat-value {
            font-weight: 700;
            color: var(--black);
        }

        .footer-actions {
            display: flex;
            gap: 12px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            main {
                padding: 20px 16px;
                padding-bottom: 100px;
            }

            .header {
                padding: 12px 16px;
            }

            .nav {
                display: none;
            }

            .page-header {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .change-item {
                flex-wrap: wrap;
            }

            .sticky-footer {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }

            .footer-info {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/" class="logo">
            <div class="logo-icon">
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
                <div class="logo-bar"></div>
            </div>
            <span class="logo-text">Mos-GSM</span>
        </a>
        <nav class="nav">
            <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/history" class="nav-link">–ò—Å—Ç–æ—Ä–∏—è</a>
            <a href="/comparison" class="nav-link">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
        </nav>
    </header>

    <main>
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">–†–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π</h1>
                <p class="page-subtitle" id="periodInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div class="page-actions">
                <a href="/" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    –û—Ç–º–µ–Ω–∞
                </a>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="info-banner">
            <div class="info-banner-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            </div>
            <div class="info-banner-content">
                <h3>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</h3>
                <p>–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π. 
                   –û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å. –ù–µ–ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã.</p>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green">‚ûï</div>
                <div class="stat-info">
                    <div class="stat-value" id="addedCount">0</div>
                    <div class="stat-label">–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">‚ûñ</div>
                <div class="stat-info">
                    <div class="stat-value" id="deletedCount">0</div>
                    <div class="stat-label">–£–¥–∞–ª—ë–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">‚úèÔ∏è</div>
                <div class="stat-info">
                    <div class="stat-value" id="modifiedCount">0</div>
                    <div class="stat-label">–ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">‚úì</div>
                <div class="stat-info">
                    <div class="stat-value" id="selectedCount">0</div>
                    <div class="stat-label">–í—ã–±—Ä–∞–Ω–æ</div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</p>
            </div>
        </div>
    </main>

    <!-- Sticky Footer -->
    <div class="sticky-footer" id="stickyFooter" style="display: none;">
        <div class="footer-info">
            <div class="footer-stat">
                <div class="footer-stat-icon green">‚ûï</div>
                <span class="footer-stat-text">–î–æ–±–∞–≤–∏—Ç—å: <span class="footer-stat-value" id="footerAdded">0</span></span>
            </div>
            <div class="footer-stat">
                <div class="footer-stat-icon red">‚ûñ</div>
                <span class="footer-stat-text">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: <span class="footer-stat-value" id="footerDeleted">0</span></span>
            </div>
            <div class="footer-stat">
                <div class="footer-stat-icon orange">‚úèÔ∏è</div>
                <span class="footer-stat-text">–û—Ç–∫–∞—Ç–∏—Ç—å: <span class="footer-stat-value" id="footerModified">0</span></span>
            </div>
        </div>
        <div class="footer-actions">
            <button class="btn btn-secondary" onclick="skipReview()">
                –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
            </button>
            <button class="btn btn-success" id="applyBtn" onclick="applyChanges()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </div>
    </div>

    <script>
        // Get session_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        
        let changesData = null;
        let selections = {
            added: {},    // order_code -> true/false (true = include new order)
            deleted: {},  // order_code -> true/false (true = restore deleted order)
            modified: {}  // order_code -> true/false (true = use old values)
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!sessionId) {
                showError('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            loadChanges();
        });

        async function loadChanges() {
            try {
                const response = await fetch(`/api/review/${sessionId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                changesData = data;
                
                // Update period info
                document.getElementById('periodInfo').textContent = 
                    `–ü–µ—Ä–∏–æ–¥: ${data.period} ‚Ä¢ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è: v${data.previous_version || 1}`;

                // Initialize selections (all unchecked by default)
                data.changes.added.forEach(c => selections.added[c.order_code + '_' + c.worker] = true);
                data.changes.deleted.forEach(c => selections.deleted[c.order_code + '_' + c.worker] = false);
                data.changes.modified.forEach(c => selections.modified[c.order_code + '_' + c.worker] = false);

                renderContent();
                updateStats();
                document.getElementById('stickyFooter').style.display = 'flex';

            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ùå</div>
                    <h3 class="empty-title">–û—à–∏–±–∫–∞</h3>
                    <p class="empty-text">${message}</p>
                    <a href="/" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            `;
        }

        function renderContent() {
            const { added, deleted, modified } = changesData.changes;

            if (added.length === 0 && deleted.length === 0 && modified.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <h3 class="empty-title">–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p class="empty-text">–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏</p>
                        <button class="btn btn-success" onclick="skipReview()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    </div>
                `;
                document.getElementById('stickyFooter').style.display = 'none';
                return;
            }

            let html = '';

            // Added section
            if (added.length > 0) {
                html += renderSection('added', '–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã', added, 'green', '‚ûï', 
                    '–≠—Ç–∏ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤–∏–ª–∏—Å—å –≤ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö. –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã.');
            }

            // Deleted section
            if (deleted.length > 0) {
                html += renderSection('deleted', '–£–¥–∞–ª—ë–Ω–Ω—ã–µ / –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏', deleted, 'red', '‚ûñ',
                    '–≠—Ç–∏ –∑–∞–∫–∞–∑—ã –∏ —Ä—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –±—ã–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö. –û—Ç–º–µ—Ç—å—Ç–µ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.');
            }

            // Modified section
            if (modified.length > 0) {
                html += renderSection('modified', '–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', modified, 'orange', '‚úèÔ∏è',
                    '–í —ç—Ç–∏—Ö –∑–∞–∫–∞–∑–∞—Ö –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∑–Ω–∞—á–µ–Ω–∏—è. –û—Ç–º–µ—Ç—å—Ç–µ —Ç–µ, –≥–¥–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.');
            }

            document.getElementById('content').innerHTML = html;
        }

        function renderSection(type, title, items, colorClass, icon, description) {
            const key = type;
            
            return `
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            ${icon} ${title}
                            <span class="section-badge ${colorClass}">${items.length}</span>
                        </h2>
                        <div class="section-actions">
                            <button class="section-btn select-all" onclick="selectAll('${key}', true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button class="section-btn select-none" onclick="selectAll('${key}', false)">–°–Ω—è—Ç—å –≤—Å–µ</button>
                        </div>
                    </div>
                    <p style="padding: 12px 24px; font-size: 13px; color: var(--gray-dark); background: var(--gray-light);">
                        ${description}
                    </p>
                    <div class="section-body">
                        ${items.map((item, idx) => renderChangeItem(type, item, idx)).join('')}
                    </div>
                </div>
            `;
        }

        function renderChangeItem(type, item, idx) {
            const key = item.order_code + '_' + item.worker;
            const isChecked = selections[type][key];
            const selectedClass = isChecked ? 'selected' : '';
            const isExtraRow = item.type === 'extra_row';

            let detailsHtml = '';
            let actionLabel = '';
            let extraBadge = isExtraRow ? '<span style="background: #E8F5E9; color: #2E7D32; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</span>' : '';

            if (type === 'added') {
                actionLabel = isChecked ? 
                    '<span class="change-action restore">–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω</span>' : 
                    '<span class="change-action skip">–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å</span>';
                
                if (item.details) {
                    detailsHtml = Object.entries(item.details).map(([k, v]) => 
                        `<span class="change-detail added">${k}: ${v}</span>`
                    ).join('');
                }
            } else if (type === 'deleted') {
                actionLabel = isChecked ? 
                    '<span class="change-action restore">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>' : 
                    '<span class="change-action skip">–û—Å—Ç–∞–≤–∏—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–º</span>';
                
                if (item.details) {
                    detailsHtml = Object.entries(item.details).map(([k, v]) => 
                        `<span class="change-detail deleted">${k}: ${v}</span>`
                    ).join('');
                }
            } else if (type === 'modified') {
                actionLabel = isChecked ? 
                    '<span class="change-action keep-old">–û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</span>' : 
                    '<span class="change-action restore">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</span>';
                
                if (item.changes) {
                    detailsHtml = item.changes.map(c => 
                        `<span class="change-detail modified">
                            ${c.field}: 
                            <span class="old-value">${c.old}</span>
                            <span class="arrow">‚Üí</span>
                            ${c.new}
                        </span>`
                    ).join('');
                }
            }

            // For extra rows, show the full order text as address if no address
            const displayAddress = item.address || (isExtraRow ? item.order_code : '');

            return `
                <div class="change-item ${selectedClass}" id="item-${type}-${idx}">
                    <div class="change-checkbox">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                               onchange="toggleSelection('${type}', '${key}', ${idx})">
                    </div>
                    <div class="change-icon ${type}">${type === 'added' ? '‚ûï' : type === 'deleted' ? '‚ûñ' : '‚úèÔ∏è'}</div>
                    <div class="change-content">
                        <div class="change-header">
                            <span class="change-order">${isExtraRow ? 'üìù ' : ''}${item.order_code}</span>
                            <span class="change-worker">üë∑ ${item.worker}</span>
                            ${extraBadge}
                            ${actionLabel}
                        </div>
                        ${displayAddress && displayAddress !== item.order_code ? `<div class="change-address">üìç ${displayAddress}</div>` : ''}
                        <div class="change-details">${detailsHtml}</div>
                    </div>
                </div>
            `;
        }

        function toggleSelection(type, key, idx) {
            selections[type][key] = !selections[type][key];
            
            const item = document.getElementById(`item-${type}-${idx}`);
            if (selections[type][key]) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            
            // Re-render action label
            renderContent();
            updateStats();
        }

        function selectAll(type, value) {
            for (const key in selections[type]) {
                selections[type][key] = value;
            }
            renderContent();
            updateStats();
        }

        function updateStats() {
            const addedTotal = changesData.changes.added.length;
            const deletedTotal = changesData.changes.deleted.length;
            const modifiedTotal = changesData.changes.modified.length;

            const addedSelected = Object.values(selections.added).filter(v => v).length;
            const deletedSelected = Object.values(selections.deleted).filter(v => v).length;
            const modifiedSelected = Object.values(selections.modified).filter(v => v).length;

            document.getElementById('addedCount').textContent = addedTotal;
            document.getElementById('deletedCount').textContent = deletedTotal;
            document.getElementById('modifiedCount').textContent = modifiedTotal;
            document.getElementById('selectedCount').textContent = addedSelected + deletedSelected + modifiedSelected;

            document.getElementById('footerAdded').textContent = addedSelected;
            document.getElementById('footerDeleted').textContent = deletedSelected;
            document.getElementById('footerModified').textContent = modifiedSelected;
        }

        function skipReview() {
            // Proceed without applying any changes to deleted/modified
            // But keep all added orders
            proceedToCalculation({
                added: Object.keys(selections.added).filter(k => selections.added[k]),
                deleted: [],
                modified: []
            });
        }

        async function applyChanges() {
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.disabled = true;
            applyBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div> –û–±—Ä–∞–±–æ—Ç–∫–∞...';

            const selectedChanges = {
                added: Object.keys(selections.added).filter(k => selections.added[k]),
                deleted: Object.keys(selections.deleted).filter(k => selections.deleted[k]),
                modified: Object.keys(selections.modified).filter(k => selections.modified[k])
            };

            await proceedToCalculation(selectedChanges);
        }

        async function proceedToCalculation(selectedChanges) {
            try {
                const response = await fetch('/api/apply-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        selections: selectedChanges
                    })
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = `/period/${data.period_id}`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.disabled = false;
                applyBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                `;
            }
        }
    </script>
</body>
</html>
