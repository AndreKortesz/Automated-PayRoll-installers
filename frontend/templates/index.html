<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        h3 {
            color: #666;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        input[type="file"],
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            align-items: start;
        }
        .settings-grid .form-group {
            display: flex;
            flex-direction: column;
        }
        .settings-grid .form-group label {
            min-height: 40px;
            display: flex;
            align-items: flex-end;
            margin-bottom: 5px;
        }
        @media (max-width: 1200px) {
            .settings-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Workers horizontal layout */
        .workers-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .worker-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            min-width: 280px;
            flex: 1;
            max-width: 400px;
        }
        .worker-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .extra-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .extra-row input {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }
        .extra-row input:first-child {
            flex: 2;
        }
        .btn-add {
            background: #28a745;
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-remove {
            background: #dc3545;
            padding: 6px 10px;
            font-size: 12px;
        }
        
        /* Days table */
        .days-table {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td.order-cell {
            max-width: 500px;
            word-wrap: break-word;
        }
        .days-input {
            width: 60px;
            padding: 6px;
            text-align: center;
        }
        
        /* Loading and success */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .success h3 {
            color: #155724;
        }
        .download-link {
            display: inline-block;
            margin-top: 15px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
        .hidden {
            display: none;
        }
        .toggle-section {
            cursor: pointer;
            user-select: none;
        }
        .toggle-section:hover {
            color: #667eea;
        }
        .collapsible {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible.collapsed {
            max-height: 0;
        }
        
        /* Alarms tabs */
        .alarms-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .alarms-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .alarm-tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }
        .alarm-tab:hover {
            transform: translateY(-2px);
        }
        .alarm-tab.active {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .alarm-tab-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .alarm-tab.high-payment {
            background: #f8d7da;
            color: #721c24;
        }
        .alarm-tab.non-standard-percent {
            background: #fff3cd;
            color: #856404;
        }
        .alarm-tab.high-specialist-fee {
            background: #d4edda;
            color: #155724;
        }
        .alarm-tab.high-fuel {
            background: #cce5ff;
            color: #004085;
        }
        .alarm-content {
            display: none;
        }
        .alarm-content.active {
            display: block;
        }
        .alarm-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }
        .alarm-item.high-payment {
            border-left-color: #dc3545;
        }
        .alarm-item.non-standard-percent {
            border-left-color: #ffc107;
        }
        .alarm-item.high-specialist-fee {
            border-left-color: #28a745;
        }
        .alarm-item.high-fuel {
            border-left-color: #007bff;
        }
        .alarm-message {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .alarm-section-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
        }
        .alarm-section-badge.main {
            background: #e3f2fd;
            color: #1976d2;
        }
        .alarm-section-badge.client {
            background: #fce4ec;
            color: #c2185b;
        }
        .alarm-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 12px;
        }
        .alarm-detail {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
        }
        .alarm-detail-label {
            font-weight: 600;
            color: #666;
        }
        .alarm-detail-value {
            color: #333;
            word-break: break-word;
        }
        /* Changes section styles */
        .changes-box {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .changes-box.no-changes {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #28a745;
        }
        .changes-box.has-changes {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 1px solid #ffc107;
        }
        .changes-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .changes-header .icon {
            font-size: 24px;
        }
        .changes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
        }
        .change-category {
            background: white;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .change-category-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            top: 0;
            background: white;
            padding: 5px 0;
        }
        .change-category-title.added { color: #28a745; }
        .change-category-title.deleted { color: #dc3545; }
        .change-category-title.modified { color: #fd7e14; }
        .change-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 13px;
        }
        .change-item.added { background: #d4edda; border-left: 3px solid #28a745; }
        .change-item.deleted { background: #f8d7da; border-left: 3px solid #dc3545; }
        .change-item.modified { background: #fff3cd; border-left: 3px solid #fd7e14; }
        .change-item-code {
            font-weight: 600;
            font-size: 14px;
        }
        .change-item-worker {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }
        .change-item-address {
            color: #495057;
            font-size: 11px;
            margin-top: 4px;
            font-style: italic;
        }
        .change-item-details {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .detail-tag {
            background: rgba(0,0,0,0.08);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
        }
        .change-item-fields {
            font-size: 12px;
            color: #856404;
            margin-top: 6px;
        }
        .field-change {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 2px;
        }
        .field-change s {
            color: #dc3545;
            text-decoration: line-through;
        }
        .field-change b {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1>üí∞ –†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</h1>
                <a href="/history" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 500;">üìä –ò—Å—Ç–æ—Ä–∏—è</a>
            </div>
            <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ 1–° –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞</p>
            
            <!-- Step 1: Upload -->
            <div class="step active" id="step1">
                <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label>üìÅ –§–∞–π–ª –æ–±—ä–µ–∫—Ç–æ–≤ –¥–æ 10 000‚ÇΩ:</label>
                        <input type="file" id="file_under_10k" accept=".xlsx,.xls" required>
                    </div>
                    <div class="form-group">
                        <label>üìÅ –§–∞–π–ª –æ–±—ä–µ–∫—Ç–æ–≤ –±–æ–ª–µ–µ 10 000‚ÇΩ:</label>
                        <input type="file" id="file_over_10k" accept=".xlsx,.xls" required>
                    </div>
                    <button type="submit" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
                </form>
            </div>
            
            <!-- Step 2: Settings & Review -->
            <div class="step" id="step2">
                <h2>–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</h2>
                
                <div class="stats" id="statsSection"></div>
                
                <!-- Changes section -->
                <div id="changesSection" class="hidden" style="margin-bottom: 20px;"></div>
                
                <!-- Settings -->
                <h3 class="toggle-section" onclick="toggleSection('settingsContent')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—á—ë—Ç–∞ ‚ñº</h3>
                <div class="collapsible" id="settingsContent">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>–ë–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å:</label>
                            <input type="text" id="base_address" value="–ú–æ—Å–∫–≤–∞, –°—Ö–æ–¥–Ω–µ–Ω—Å–∫–∏–π —Ç—É–ø–∏–∫ 16—Å4" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –±–µ–Ω–∑–∏–Ω–∞:</label>
                            <input type="number" id="fuel_coefficient" value="7" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>üöó –°—É–º–º–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö (–ù–∞ —Å–≤–æ—ë–º –∞–≤—Ç–æ):</label>
                            <input type="number" id="transport_amount" value="1000" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>üè¢ –°—É–º–º–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö (–ù–∞ –∞–≤—Ç–æ –∫–æ–º–ø–∞–Ω–∏–∏):</label>
                            <input type="number" value="0" readonly style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>üè¢ –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏ –Ω–∞ –∞–≤—Ç–æ –∫–æ–º–ø–∞–Ω–∏–∏ (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ = 0‚ÇΩ):</label>
                        <div id="companyCarWorkers" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; min-height: 40px;">
                            <span style="color: #999; font-style: italic;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</span>
                        </div>
                    </div>
                </div>
                
                <!-- Days table -->
                <h3 class="toggle-section" onclick="toggleSection('daysContent')">üìÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–∞ –æ–±—ä–µ–∫—Ç ‚ñº</h3>
                <div class="collapsible" id="daysContent">
                    <div class="days-table" id="daysTable"></div>
                </div>
                
                <!-- Extra rows - horizontal layout -->
                <h3 class="toggle-section" onclick="toggleSection('extraContent')">‚ûï –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ‚ñº</h3>
                <div class="collapsible" id="extraContent">
                    <div class="workers-horizontal" id="workersExtra"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</button>
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
            </div>
            
            <!-- Step 3: Result -->
            <div class="step" id="step3">
                <h2>–®–∞–≥ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                
                <div class="loading" id="loadingSection">
                    <div class="spinner"></div>
                    <p>–ò–¥—ë—Ç —Ä–∞—Å—á—ë—Ç... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
                </div>
                
                <div class="success hidden" id="successSection">
                    <h3>‚úÖ –†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h3>
                    <p>–§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é</p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                        <a href="#" class="download-link" id="downloadLinkFull">üì• –ü–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤ (–ù–µ —É—Ä–µ–∑–∞–Ω–Ω—ã–π)</a>
                        <a href="#" class="download-link" id="downloadLinkWorkers" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üì• –î–ª—è –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤ (–°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π)</a>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        <button class="btn btn-secondary" onclick="goToStep(1)">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã</button>
                    </div>
                </div>
                
                <!-- Alarms with tabs -->
                <div class="alarms-container hidden" id="alarmsSection">
                    <h3>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                    <div class="alarms-tabs" id="alarmsTabs"></div>
                    <div id="alarmsContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let sessionId = null;
        let workers = [];
        let orders = [];
        let extraRows = {};
        
        const alarmTypeNames = {
            'high_payment': '–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã > 20000',
            'non_standard_percent': '–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç',
            'high_specialist_fee': '–í—ã—Ä—É—á–∫–∞ (–≤—ã–µ–∑–¥) > 3500',
            'high_fuel': '–í—ã—Å–æ–∫–∞—è –æ–ø–ª–∞—Ç–∞ –±–µ–Ω–∑–∏–Ω–∞'
        };
        
        function toggleSection(id) {
            const el = document.getElementById(id);
            el.classList.toggle('collapsed');
        }
        
        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            
            // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —à–∞–≥ 2, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —à–∞–≥–µ 3
            if (step === 2) {
                document.getElementById('loadingSection').classList.remove('hidden');
                document.getElementById('successSection').classList.add('hidden');
                document.getElementById('alarmsSection').classList.add('hidden');
            }
        }
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file_under_10k', document.getElementById('file_under_10k').files[0]);
            formData.append('file_over_10k', document.getElementById('file_over_10k').files[0]);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    workers = data.workers;
                    orders = data.orders;
                    
                    // Show stats
                    document.getElementById('statsSection').innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${data.total_records}</div>
                            <div class="stat-label">–ó–∞–ø–∏—Å–µ–π</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.workers.length}</div>
                            <div class="stat-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.period}</div>
                            <div class="stat-label">–ü–µ—Ä–∏–æ–¥</div>
                        </div>
                    `;
                    
                    // Show changes if any
                    const changesSection = document.getElementById('changesSection');
                    const changes = data.changes || {};
                    
                    if (changes.has_previous) {
                        const totalChanges = (changes.added?.length || 0) + (changes.deleted?.length || 0) + (changes.modified?.length || 0);
                        
                        if (totalChanges === 0) {
                            changesSection.innerHTML = `
                                <div class="changes-box no-changes">
                                    <div class="changes-header">
                                        <span class="icon">‚úÖ</span>
                                        <span>–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç</span>
                                    </div>
                                    <p style="margin: 0; color: #155724;">–î–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–≥—Ä—É–∑–∫–æ–π (–≤–µ—Ä—Å–∏—è ${changes.previous_version})</p>
                                </div>
                            `;
                        } else {
                            let changesHtml = `
                                <div class="changes-box has-changes">
                                    <div class="changes-header">
                                        <span class="icon">üîÑ</span>
                                        <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è (${totalChanges})</span>
                                    </div>
                                    <p style="margin: 0 0 15px; color: #856404;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≤–µ—Ä—Å–∏–µ–π ${changes.previous_version}</p>
                                    <div class="changes-grid">
                            `;
                            
                            // Helper function to format details
                            const formatDetails = (details) => {
                                if (!details || Object.keys(details).length === 0) return '';
                                return Object.entries(details)
                                    .map(([key, val]) => `<span class="detail-tag">${key}: ${val}</span>`)
                                    .join(' ');
                            };
                            
                            // Added
                            if (changes.added?.length > 0) {
                                changesHtml += `
                                    <div class="change-category">
                                        <div class="change-category-title added">‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ (${changes.added.length})</div>
                                `;
                                changes.added.forEach(item => {
                                    changesHtml += `
                                        <div class="change-item added">
                                            <div class="change-item-code">${item.order_code}</div>
                                            <div class="change-item-worker">${item.worker}</div>
                                            ${item.address ? `<div class="change-item-address">üìç ${item.address}</div>` : ''}
                                            ${item.details ? `<div class="change-item-details">${formatDetails(item.details)}</div>` : ''}
                                        </div>
                                    `;
                                });
                                changesHtml += `</div>`;
                            }
                            
                            // Deleted
                            if (changes.deleted?.length > 0) {
                                changesHtml += `
                                    <div class="change-category">
                                        <div class="change-category-title deleted">‚ûñ –£–¥–∞–ª–µ–Ω–æ (${changes.deleted.length})</div>
                                `;
                                changes.deleted.forEach(item => {
                                    changesHtml += `
                                        <div class="change-item deleted">
                                            <div class="change-item-code">${item.order_code}</div>
                                            <div class="change-item-worker">${item.worker}</div>
                                            ${item.address ? `<div class="change-item-address">üìç ${item.address}</div>` : ''}
                                            ${item.details ? `<div class="change-item-details">${formatDetails(item.details)}</div>` : ''}
                                        </div>
                                    `;
                                });
                                changesHtml += `</div>`;
                            }
                            
                            // Modified
                            if (changes.modified?.length > 0) {
                                changesHtml += `
                                    <div class="change-category">
                                        <div class="change-category-title modified">‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ (${changes.modified.length})</div>
                                `;
                                changes.modified.forEach(item => {
                                    const fieldsText = item.changes.map(c => `<span class="field-change">${c.field}: <s>${c.old}</s> ‚Üí <b>${c.new}</b></span>`).join(' ');
                                    changesHtml += `
                                        <div class="change-item modified">
                                            <div class="change-item-code">${item.order_code}</div>
                                            <div class="change-item-worker">${item.worker}</div>
                                            ${item.address ? `<div class="change-item-address">üìç ${item.address}</div>` : ''}
                                            <div class="change-item-fields">${fieldsText}</div>
                                        </div>
                                    `;
                                });
                                changesHtml += `</div>`;
                            }
                            
                            changesHtml += `</div></div>`;
                            changesSection.innerHTML = changesHtml;
                        }
                        changesSection.classList.remove('hidden');
                    } else {
                        changesSection.classList.add('hidden');
                        changesSection.innerHTML = '';
                    }
                    
                    // Build company car workers checkboxes
                    let companyCarHtml = '';
                    workers.forEach(worker => {
                        companyCarHtml += `
                            <label style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: white; border-radius: 5px; cursor: pointer; border: 1px solid #ddd;">
                                <input type="checkbox" class="company-car-checkbox" value="${worker}">
                                <span>${worker}</span>
                            </label>
                        `;
                    });
                    document.getElementById('companyCarWorkers').innerHTML = companyCarHtml;
                    
                    // Build days table - sorted by worker, using short order format
                    // Filter: only orders with transport (revenue > 10k and percent < 50%)
                    const ordersWithTransport = orders.filter(o => !o.is_client_payment && o.has_transport);
                    let daysHtml = '<table><thead><tr><th>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</th><th>–ó–∞–∫–∞–∑</th><th>–î–Ω–∏</th></tr></thead><tbody>';
                    ordersWithTransport.forEach((order, idx) => {
                        daysHtml += `<tr>
                            <td>${order.worker}</td>
                            <td class="order-cell">${order.order_short}</td>
                            <td><input type="number" class="days-input" id="days_${idx}" value="1" min="1" data-order="${encodeURIComponent(order.order)}"></td>
                        </tr>`;
                    });
                    daysHtml += '</tbody></table>';
                    document.getElementById('daysTable').innerHTML = daysHtml;
                    
                    // Build extra rows section - horizontal layout
                    let extraHtml = '';
                    workers.forEach(worker => {
                        extraRows[worker] = [];
                        extraHtml += `
                            <div class="worker-card">
                                <div class="worker-name">${worker}</div>
                                <div id="extra_${worker.replace(/\s+/g, '_')}"></div>
                                <button class="btn btn-add" onclick="addExtraRow('${worker}')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        `;
                    });
                    document.getElementById('workersExtra').innerHTML = extraHtml;
                    
                    goToStep(2);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        });
        
        function addExtraRow(worker) {
            const containerId = 'extra_' + worker.replace(/\s+/g, '_');
            const container = document.getElementById(containerId);
            const idx = extraRows[worker].length;
            
            const div = document.createElement('div');
            div.className = 'extra-row';
            div.id = `extra_row_${worker.replace(/\s+/g, '_')}_${idx}`;
            div.innerHTML = `
                <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="extra_desc_${worker.replace(/\s+/g, '_')}_${idx}">
                <input type="number" placeholder="–°—É–º–º–∞" id="extra_amount_${worker.replace(/\s+/g, '_')}_${idx}">
                <button class="btn btn-remove" onclick="removeExtraRow('${worker}', ${idx})">‚úï</button>
            `;
            container.appendChild(div);
            extraRows[worker].push({idx: idx});
        }
        
        function removeExtraRow(worker, idx) {
            const rowId = `extra_row_${worker.replace(/\s+/g, '_')}_${idx}`;
            const row = document.getElementById(rowId);
            if (row) row.remove();
            extraRows[worker] = extraRows[worker].filter(r => r.idx !== idx);
        }
        
        function showAlarmTab(type) {
            document.querySelectorAll('.alarm-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.alarm-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.alarm-tab.${type}`).classList.add('active');
            document.getElementById(`alarm-content-${type}`).classList.add('active');
        }
        
        async function calculate() {
            goToStep(3);
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('alarmsSection').classList.add('hidden');
            
            // Collect company car workers (transport = 0)
            const companyCarWorkers = [];
            document.querySelectorAll('.company-car-checkbox:checked').forEach(cb => {
                companyCarWorkers.push(cb.value);
            });
            
            // Collect config
            const config = {
                base_address: document.getElementById('base_address').value,
                fuel_coefficient: parseFloat(document.getElementById('fuel_coefficient').value),
                transport_amount: parseInt(document.getElementById('transport_amount').value),
                company_car_workers: companyCarWorkers
            };
            
            // Collect days
            const days = {};
            document.querySelectorAll('.days-input').forEach(input => {
                const order = decodeURIComponent(input.dataset.order);
                days[order] = parseInt(input.value) || 1;
            });
            
            // Collect extra rows
            const extras = {};
            workers.forEach(worker => {
                extras[worker] = [];
                extraRows[worker].forEach(row => {
                    const desc = document.getElementById(`extra_desc_${worker.replace(/\s+/g, '_')}_${row.idx}`);
                    const amount = document.getElementById(`extra_amount_${worker.replace(/\s+/g, '_')}_${row.idx}`);
                    if (desc && amount && desc.value && amount.value) {
                        extras[worker].push({
                            description: desc.value,
                            amount: parseFloat(amount.value)
                        });
                    }
                });
            });
            
            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('config_json', JSON.stringify(config));
                formData.append('days_json', JSON.stringify(days));
                formData.append('extra_rows_json', JSON.stringify(extras));
                
                const response = await fetch('/calculate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                document.getElementById('loadingSection').classList.remove('active');
                
                if (data.success) {
                    document.getElementById('successSection').classList.remove('hidden');
                    document.getElementById('downloadLinkFull').href = data.download_url_full;
                    document.getElementById('downloadLinkWorkers').href = data.download_url_workers;
                    
                    // Show alarms with tabs
                    const alarms = data.alarms;
                    const hasAlarms = Object.values(alarms).some(arr => arr.length > 0);
                    
                    if (hasAlarms) {
                        document.getElementById('alarmsSection').classList.remove('hidden');
                        
                        // Build tabs
                        let tabsHtml = '';
                        let contentHtml = '';
                        let firstActive = true;
                        
                        for (const [type, items] of Object.entries(alarms)) {
                            if (items.length > 0) {
                                const activeClass = firstActive ? 'active' : '';
                                tabsHtml += `
                                    <div class="alarm-tab ${type.replace(/_/g, '-')} ${activeClass}" onclick="showAlarmTab('${type.replace(/_/g, '-')}')">
                                        ${alarmTypeNames[type]}
                                        <span class="alarm-tab-count">${items.length}</span>
                                    </div>
                                `;
                                
                                let itemsHtml = '';
                                items.forEach(alarm => {
                                    const sectionBadge = alarm.section === '–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º' 
                                        ? '<span class="alarm-section-badge client">–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º</span>'
                                        : '<span class="alarm-section-badge main">–æ—Å–Ω–æ–≤–Ω–∞—è</span>';
                                    
                                    // Only these fields should be bold
                                    const boldFields = ['–í—ã—Ä—É—á–∫–∞ –æ—Ç —É—Å–ª—É–≥', '–ò—Ç–æ–≥–æ'];
                                    
                                    let detailsHtml = '';
                                    if (alarm.row_info) {
                                        for (const [key, value] of Object.entries(alarm.row_info)) {
                                            if (key !== '–°–µ–∫—Ü–∏—è') {
                                                const isBold = boldFields.some(f => key.includes(f));
                                                const displayValue = isBold && value && !String(value).includes('%') 
                                                    ? `<strong>${value}</strong>` 
                                                    : value;
                                                detailsHtml += `
                                                    <div class="alarm-detail">
                                                        <span class="alarm-detail-label">${key}:</span>
                                                        <span class="alarm-detail-value">${displayValue}</span>
                                                    </div>
                                                `;
                                            }
                                        }
                                    }
                                    
                                    // Make the main message amount larger with "—Ä—É–±–ª–µ–π"
                                    let messageHtml = alarm.message;
                                    // Match patterns like ": 49526.7" and make larger with "—Ä—É–±–ª–µ–π"
                                    messageHtml = messageHtml.replace(/: (\d+\.?\d*)\s*$/g, ': <span style="font-size: 1.1em; font-weight: bold;">$1 —Ä—É–±–ª–µ–π</span>');
                                    
                                    itemsHtml += `
                                        <div class="alarm-item ${type.replace(/_/g, '-')}">
                                            <div class="alarm-message">${messageHtml} ${sectionBadge}</div>
                                            <div class="alarm-details">${detailsHtml}</div>
                                        </div>
                                    `;
                                });
                                
                                contentHtml += `
                                    <div class="alarm-content ${activeClass}" id="alarm-content-${type.replace(/_/g, '-')}">
                                        ${itemsHtml}
                                    </div>
                                `;
                                
                                firstActive = false;
                            }
                        }
                        
                        document.getElementById('alarmsTabs').innerHTML = tabsHtml;
                        document.getElementById('alarmsContent').innerHTML = contentHtml;
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    goToStep(2);
                }
            } catch (error) {
                document.getElementById('loadingSection').classList.remove('active');
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                goToStep(2);
            }
        }
    </script>
</body>
</html>
