<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin-bottom: 15px; font-size: 1.3em; }
        h3 { color: #666; margin-bottom: 10px; font-size: 1.1em; }
        .subtitle { color: #666; margin-bottom: 20px; }
        .step { display: none; }
        .step.active { display: block; }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #444; }
        input[type="file"], input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 14px 28px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-danger { background: #dc3545; padding: 8px 12px; font-size: 12px; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; }
        .settings-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: start;
        }
        @media (max-width: 1200px) { .settings-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .settings-grid { grid-template-columns: repeat(2, 1fr); } }
        .workers-horizontal { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .worker-card {
            background: #f8f9fa; border-radius: 8px; padding: 15px;
            min-width: 280px; flex: 1; max-width: 400px;
        }
        .worker-name { font-weight: bold; color: #333; margin-bottom: 10px; font-size: 14px; }
        .extra-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .extra-row input { flex: 1; padding: 8px; font-size: 13px; }
        .extra-row input:first-child { flex: 2; }
        .btn-add { background: #28a745; padding: 6px 12px; font-size: 12px; }
        .btn-remove { background: #dc3545; padding: 6px 10px; font-size: 12px; }
        .days-table { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        .days-input { width: 60px; padding: 6px; text-align: center; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success { background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 20px; text-align: center; }
        .success h3 { color: #155724; }
        .download-link {
            display: inline-block; margin-top: 15px; padding: 14px 28px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white; text-decoration: none; border-radius: 8px; font-weight: 600;
        }
        .hidden { display: none; }
        .toggle-section { cursor: pointer; user-select: none; }
        .toggle-section:hover { color: #667eea; }
        .collapsible { overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible.collapsed { max-height: 0; }
        
        /* Preview table */
        .preview-table-wrapper { max-height: 600px; overflow: auto; margin-bottom: 20px; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .preview-table th { 
            background: #667eea; color: white; padding: 12px 8px; 
            position: sticky; top: 0; z-index: 10; white-space: nowrap;
        }
        .preview-table td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        .preview-table tr:hover { background: #f8f9fa; }
        .preview-table .order-code { font-weight: 600; color: #667eea; }
        .preview-table .address { max-width: 300px; word-wrap: break-word; white-space: normal; line-height: 1.3; }
        .preview-table .number { text-align: right; font-family: Monaco, Consolas, monospace; }
        .preview-table .total-cell { font-weight: bold; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .badge-client { background: #ffeaa7; color: #d68910; }
        .badge-over10k { background: #dfe6e9; color: #636e72; }
        .btn-delete-row { 
            background: #dc3545; color: white; border: none; padding: 4px 8px; 
            border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        .btn-delete-row:hover { background: #c82333; }
        .row-deleted { opacity: 0.4; text-decoration: line-through; }
        .row-deleted td { background: #f8d7da !important; }
        
        /* Worker tabs in preview */
        .worker-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .worker-tab {
            padding: 8px 16px; background: #e9ecef; border-radius: 20px;
            cursor: pointer; font-size: 13px; transition: all 0.2s;
        }
        .worker-tab:hover { background: #dee2e6; }
        .worker-tab.active { background: #667eea; color: white; }
        .worker-tab .count { 
            background: rgba(0,0,0,0.1); padding: 2px 6px; 
            border-radius: 10px; margin-left: 5px; font-size: 11px;
        }
        .worker-tab.active .count { background: rgba(255,255,255,0.3); }
        
        /* Summary cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .summary-card-value { font-size: 20px; font-weight: bold; color: #667eea; }
        .summary-card-label { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* Alarms styles */
        .alarms-container { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .alarms-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .alarm-tab {
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .alarm-tab.active { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .alarm-tab-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .alarm-tab.high-payment { background: #f8d7da; color: #721c24; }
        .alarm-tab.non-standard-percent { background: #fff3cd; color: #856404; }
        .alarm-tab.high-specialist-fee { background: #d4edda; color: #155724; }
        .alarm-tab.high-fuel { background: #cce5ff; color: #004085; }
        .alarm-content { display: none; }
        .alarm-content.active { display: block; }
        .alarm-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ffc107; }
        .alarm-item.high-payment { border-left-color: #dc3545; }
        .alarm-item.non-standard-percent { border-left-color: #ffc107; }
        .alarm-item.high-specialist-fee { border-left-color: #28a745; }
        .alarm-item.high-fuel { border-left-color: #007bff; }
        .alarm-message { font-weight: bold; margin-bottom: 10px; }
        .alarm-section-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px; }
        .alarm-section-badge.main { background: #e3f2fd; color: #1976d2; }
        .alarm-section-badge.client { background: #fce4ec; color: #c2185b; }
        .alarm-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 12px; }
        .alarm-detail { background: #f8f9fa; padding: 8px 12px; border-radius: 4px; }
        .alarm-detail-label { font-weight: 600; color: #666; }
        
        /* History button */
        .history-btn {
            position: fixed; top: 20px; right: 20px;
            background: white;
            color: #667eea; padding: 12px 20px; border-radius: 25px;
            text-decoration: none; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .history-btn:hover { transform: scale(1.05); background: #f8f9fa; }
        
        /* Checkbox styles */
        .company-car-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .company-car-item { display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 8px 12px; border-radius: 6px; }
        .company-car-checkbox { width: 18px; height: 18px; }
    </style>
</head>
<body>
    <a href="/history" class="history-btn">üìä –ò—Å—Ç–æ—Ä–∏—è</a>
    
    <div class="container">
        <div class="card">
            <div class="header-row">
                <div>
                    <h1>üí∞ –†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</h1>
                    <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ 1–° –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞</p>
                </div>
            </div>
            
            <!-- Step 1: Upload -->
            <div class="step active" id="step1">
                <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label>üìÅ –§–∞–π–ª —Å –∑–∞–∫–∞–∑–∞–º–∏ –¥–æ 10 000 ‚ÇΩ</label>
                        <input type="file" id="file_under_10k" accept=".xlsx,.xls" required>
                    </div>
                    <div class="form-group">
                        <label>üìÅ –§–∞–π–ª —Å –∑–∞–∫–∞–∑–∞–º–∏ –æ—Ç 10 000 ‚ÇΩ</label>
                        <input type="file" id="file_over_10k" accept=".xlsx,.xls" required>
                    </div>
                    <button type="submit" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí</button>
                </form>
            </div>
            
            <!-- Step 2: Settings -->
            <div class="step" id="step2">
                <h2>–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</h2>
                <div class="stats" id="statsSection"></div>
                
                <h3 class="toggle-section" onclick="toggleSection('settingsContent')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—á—ë—Ç–∞ ‚ñº</h3>
                <div class="collapsible" id="settingsContent">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>–ë–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å:</label>
                            <input type="text" id="base_address" value="–ú–æ—Å–∫–≤–∞, –°—Ö–æ–¥–Ω–µ–Ω—Å–∫–∏–π —Ç—É–ø–∏–∫ 16—Å4">
                        </div>
                        <div class="form-group">
                            <label>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –±–µ–Ω–∑–∏–Ω–∞:</label>
                            <input type="number" id="fuel_coefficient" value="7" min="1">
                        </div>
                        <div class="form-group">
                            <label>üöó –°—É–º–º–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö (–ù–∞ —Å–≤–æ—ë–º –∞–≤—Ç–æ):</label>
                            <input type="number" id="transport_amount" value="1000" min="0">
                        </div>
                        <div class="form-group">
                            <label>üöê –°—É–º–º–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö (–ù–∞ –∞–≤—Ç–æ –∫–æ–º–ø–∞–Ω–∏–∏):</label>
                            <input type="number" id="transport_company" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üöê –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏ –Ω–∞ –∞–≤—Ç–æ –∫–æ–º–ø–∞–Ω–∏–∏ (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ = 0–†):</label>
                        <div class="company-car-grid" id="companyCarWorkers"></div>
                    </div>
                </div>
                
                <h3 class="toggle-section" onclick="toggleSection('daysContent')">üìÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–∞ –æ–±—ä–µ–∫—Ç ‚ñº</h3>
                <div class="collapsible" id="daysContent">
                    <div class="days-table" id="daysTable"></div>
                </div>
                
                <h3 class="toggle-section" onclick="toggleSection('extraContent')">‚ûï –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ‚ñº</h3>
                <div class="collapsible" id="extraContent">
                    <div class="workers-horizontal" id="workersExtra"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="preview()">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí</button>
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
            </div>
            
            <!-- Step 3: Preview -->
            <div class="step" id="step3">
                <h2>–®–∞–≥ 3: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                
                <div class="loading" id="previewLoading">
                    <div class="spinner"></div>
                    <p>–†–∞—Å—á—ë—Ç –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
                
                <div id="previewContent" class="hidden">
                    <div class="summary-cards" id="previewSummary"></div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–Ω—Ç–∞–∂–Ω–∏–∫—É:</strong>
                        <div class="worker-tabs" id="workerTabs">
                            <div class="worker-tab active" data-worker="all">–í—Å–µ</div>
                        </div>
                    </div>
                    
                    <div class="preview-table-wrapper">
                        <table class="preview-table" id="previewTable">
                            <thead>
                                <tr>
                                    <th>–ó–∞–∫–∞–∑</th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–û–ø–ª–∞—Ç–∞</th>
                                    <th>%</th>
                                    <th>–ë–µ–Ω–∑–∏–Ω</th>
                                    <th>–¢—Ä–∞–Ω—Å–ø.</th>
                                    <th>–ò—Ç–æ–≥–æ</th>
                                    <th>–¢–∏–ø</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="previewAlarms" class="hidden"></div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="finalize()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Result -->
            <div class="step" id="step4">
                <h2>–®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                
                <div class="loading" id="finalizeLoading">
                    <div class="spinner"></div>
                    <p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤...</p>
                </div>
                
                <div class="success hidden" id="successSection">
                    <h3>‚úÖ –†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</h3>
                    <p>–§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é</p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                        <a href="#" class="download-link" id="downloadLinkFull">üì• –ü–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤ (–ù–µ —É—Ä–µ–∑–∞–Ω–Ω—ã–π)</a>
                        <a href="#" class="download-link" id="downloadLinkWorkers" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üì• –î–ª—è –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤ (–°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π)</a>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        <button class="btn btn-secondary" onclick="goToStep(1)">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã</button>
                    </div>
                </div>
                
                <div class="alarms-container hidden" id="alarmsSection">
                    <h3>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                    <div class="alarms-tabs" id="alarmsTabs"></div>
                    <div id="alarmsContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let sessionId = null;
        let workers = [];
        let orders = [];
        let extraRows = {};
        let previewRows = [];
        let deletedRows = new Set();
        let currentWorkerFilter = 'all';
        
        const alarmTypeNames = {
            'high_payment': '–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã > 20000',
            'non_standard_percent': '–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç',
            'high_specialist_fee': '–í—ã—Ä—É—á–∫–∞ (–≤—ã–µ–∑–¥) > 3500',
            'high_fuel': '–í—ã—Å–æ–∫–∞—è –æ–ø–ª–∞—Ç–∞ –±–µ–Ω–∑–∏–Ω–∞'
        };
        
        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }
        
        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            
            if (step === 3) {
                document.getElementById('previewLoading').classList.add('active');
                document.getElementById('previewContent').classList.add('hidden');
            }
            if (step === 4) {
                document.getElementById('finalizeLoading').classList.add('active');
                document.getElementById('successSection').classList.add('hidden');
                document.getElementById('alarmsSection').classList.add('hidden');
            }
        }
        
        function formatNumber(n) {
            if (n === "" || n === null || n === undefined) return "-";
            const num = parseFloat(n);
            if (isNaN(num)) return "-";
            return Math.round(num).toLocaleString('ru-RU');
        }
        
        // Step 1: Upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file_under_10k', document.getElementById('file_under_10k').files[0]);
            formData.append('file_over_10k', document.getElementById('file_over_10k').files[0]);
            
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    workers = data.workers;
                    orders = data.orders;
                    
                    document.getElementById('statsSection').innerHTML = `
                        <div class="stat-item"><div class="stat-value">${data.total_records}</div><div class="stat-label">–ó–∞–ø–∏—Å–µ–π</div></div>
                        <div class="stat-item"><div class="stat-value">${data.workers.length}</div><div class="stat-label">–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤</div></div>
                        <div class="stat-item"><div class="stat-value">${data.period}</div><div class="stat-label">–ü–µ—Ä–∏–æ–¥</div></div>
                    `;
                    
                    // Company car checkboxes
                    let companyCarHtml = '';
                    workers.forEach(worker => {
                        companyCarHtml += `
                            <label class="company-car-item">
                                <input type="checkbox" class="company-car-checkbox" value="${worker}">
                                ${worker}
                            </label>
                        `;
                    });
                    document.getElementById('companyCarWorkers').innerHTML = companyCarHtml;
                    
                    // Days table
                    const ordersWithTransport = orders.filter(o => !o.is_client_payment && o.has_transport);
                    let daysHtml = '<table><thead><tr><th>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</th><th>–ó–∞–∫–∞–∑</th><th>–î–Ω–∏</th></tr></thead><tbody>';
                    ordersWithTransport.forEach((order, idx) => {
                        daysHtml += `<tr>
                            <td>${order.worker}</td>
                            <td>${order.order_short}</td>
                            <td><input type="number" class="days-input" id="days_${idx}" value="1" min="1" data-order="${encodeURIComponent(order.order)}"></td>
                        </tr>`;
                    });
                    daysHtml += '</tbody></table>';
                    document.getElementById('daysTable').innerHTML = daysHtml;
                    
                    // Extra rows section
                    let extraHtml = '';
                    workers.forEach(worker => {
                        extraRows[worker] = [];
                        extraHtml += `
                            <div class="worker-card">
                                <div class="worker-name">${worker}</div>
                                <div id="extra_${worker.replace(/\s+/g, '_')}"></div>
                                <button class="btn btn-add" onclick="addExtraRow('${worker}')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        `;
                    });
                    document.getElementById('workersExtra').innerHTML = extraHtml;
                    
                    goToStep(2);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        });
        
        function addExtraRow(worker) {
            const containerId = 'extra_' + worker.replace(/\s+/g, '_');
            const container = document.getElementById(containerId);
            const idx = extraRows[worker].length;
            
            const div = document.createElement('div');
            div.className = 'extra-row';
            div.id = `extra_row_${worker.replace(/\s+/g, '_')}_${idx}`;
            div.innerHTML = `
                <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="extra_desc_${worker.replace(/\s+/g, '_')}_${idx}">
                <input type="number" placeholder="–°—É–º–º–∞" id="extra_amount_${worker.replace(/\s+/g, '_')}_${idx}">
                <button class="btn btn-remove" onclick="removeExtraRow('${worker}', ${idx})">‚úï</button>
            `;
            container.appendChild(div);
            extraRows[worker].push({idx: idx});
        }
        
        function removeExtraRow(worker, idx) {
            const row = document.getElementById(`extra_row_${worker.replace(/\s+/g, '_')}_${idx}`);
            if (row) row.remove();
            extraRows[worker] = extraRows[worker].filter(r => r.idx !== idx);
        }
        
        function getConfig() {
            const companyCarWorkers = [];
            document.querySelectorAll('.company-car-checkbox:checked').forEach(cb => companyCarWorkers.push(cb.value));
            
            return {
                base_address: document.getElementById('base_address').value,
                fuel_coefficient: parseFloat(document.getElementById('fuel_coefficient').value),
                transport_amount: parseInt(document.getElementById('transport_amount').value),
                company_car_workers: companyCarWorkers
            };
        }
        
        function getDays() {
            const days = {};
            document.querySelectorAll('.days-input').forEach(input => {
                days[decodeURIComponent(input.dataset.order)] = parseInt(input.value) || 1;
            });
            return days;
        }
        
        function getExtras() {
            const extras = {};
            workers.forEach(worker => {
                extras[worker] = [];
                extraRows[worker].forEach(row => {
                    const desc = document.getElementById(`extra_desc_${worker.replace(/\s+/g, '_')}_${row.idx}`);
                    const amount = document.getElementById(`extra_amount_${worker.replace(/\s+/g, '_')}_${row.idx}`);
                    if (desc && amount && desc.value && amount.value) {
                        extras[worker].push({ description: desc.value, amount: parseFloat(amount.value) });
                    }
                });
            });
            return extras;
        }
        
        // Step 2 -> Step 3: Preview
        async function preview() {
            goToStep(3);
            deletedRows = new Set();
            
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('config_json', JSON.stringify(getConfig()));
            formData.append('days_json', JSON.stringify(getDays()));
            formData.append('extra_rows_json', JSON.stringify(getExtras()));
            
            try {
                const response = await fetch('/preview', { method: 'POST', body: formData });
                const data = await response.json();
                
                document.getElementById('previewLoading').classList.remove('active');
                
                if (data.success) {
                    previewRows = data.rows;
                    renderPreview(data);
                    document.getElementById('previewContent').classList.remove('hidden');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    goToStep(2);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                goToStep(2);
            }
        }
        
        function renderPreview(data) {
            // Summary
            const summary = data.workers_summary;
            let totalSum = 0, totalFuel = 0, totalTransport = 0, totalOrders = 0;
            for (const [w, s] of Object.entries(summary)) {
                totalSum += s.total; totalFuel += s.fuel; totalTransport += s.transport; totalOrders += s.count;
            }
            
            document.getElementById('previewSummary').innerHTML = `
                <div class="summary-card"><div class="summary-card-value">${formatNumber(totalSum)} ‚ÇΩ</div><div class="summary-card-label">–û–±—â–∞—è —Å—É–º–º–∞</div></div>
                <div class="summary-card"><div class="summary-card-value">${totalOrders}</div><div class="summary-card-label">–ó–∞–∫–∞–∑–æ–≤</div></div>
                <div class="summary-card"><div class="summary-card-value">${formatNumber(totalFuel)} ‚ÇΩ</div><div class="summary-card-label">–ë–µ–Ω–∑–∏–Ω</div></div>
                <div class="summary-card"><div class="summary-card-value">${formatNumber(totalTransport)} ‚ÇΩ</div><div class="summary-card-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ</div></div>
                <div class="summary-card"><div class="summary-card-value">${data.period}</div><div class="summary-card-label">–ü–µ—Ä–∏–æ–¥</div></div>
            `;
            
            // Worker tabs
            const workersList = [...new Set(previewRows.map(r => r.worker))].sort();
            let tabsHtml = `<div class="worker-tab active" data-worker="all" onclick="filterByWorker('all')">–í—Å–µ <span class="count">${previewRows.length}</span></div>`;
            workersList.forEach(w => {
                const count = previewRows.filter(r => r.worker === w).length;
                tabsHtml += `<div class="worker-tab" data-worker="${w}" onclick="filterByWorker('${w}')">${w.split(' ')[0]} <span class="count">${count}</span></div>`;
            });
            document.getElementById('workerTabs').innerHTML = tabsHtml;
            
            renderPreviewTable();
        }
        
        function filterByWorker(worker) {
            currentWorkerFilter = worker;
            document.querySelectorAll('.worker-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.worker-tab[data-worker="${worker}"]`).classList.add('active');
            renderPreviewTable();
        }
        
        function renderPreviewTable() {
            let rows = previewRows;
            if (currentWorkerFilter !== 'all') {
                rows = previewRows.filter(r => r.worker === currentWorkerFilter);
            }
            
            let html = '';
            rows.forEach(row => {
                const isDeleted = deletedRows.has(row.id);
                const rowClass = isDeleted ? 'row-deleted' : '';
                
                let badges = '';
                if (row.is_client_payment) badges += '<span class="badge badge-client">–û–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º</span> ';
                if (row.is_over_10k) badges += '<span class="badge badge-over10k">>10k</span>';
                
                html += `
                    <tr class="${rowClass}" id="preview-row-${row.id}">
                        <td class="order-code">${row.order_code || '-'}</td>
                        <td class="address" title="${row.address}">${row.address}</td>
                        <td class="number">${formatNumber(row.revenue_total)}</td>
                        <td class="number">${formatNumber(row.service_payment)}</td>
                        <td class="number">${row.percent || '-'}</td>
                        <td class="number">${formatNumber(row.fuel_payment)}</td>
                        <td class="number">${formatNumber(row.transport)}</td>
                        <td class="number total-cell">${formatNumber(row.total)}</td>
                        <td>${badges}</td>
                        <td>
                            ${isDeleted 
                                ? `<button class="btn-delete-row" onclick="restoreRow(${row.id})" style="background:#28a745;">‚Ü©</button>`
                                : `<button class="btn-delete-row" onclick="deleteRow(${row.id})">‚úï</button>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('previewTableBody').innerHTML = html;
        }
        
        function deleteRow(id) {
            deletedRows.add(id);
            renderPreviewTable();
            updatePreviewSummary();
        }
        
        function restoreRow(id) {
            deletedRows.delete(id);
            renderPreviewTable();
            updatePreviewSummary();
        }
        
        function updatePreviewSummary() {
            let totalSum = 0, totalFuel = 0, totalTransport = 0, totalOrders = 0;
            previewRows.forEach(row => {
                if (!deletedRows.has(row.id)) {
                    totalSum += parseFloat(row.total) || 0;
                    totalFuel += parseFloat(row.fuel_payment) || 0;
                    totalTransport += parseFloat(row.transport) || 0;
                    totalOrders++;
                }
            });
            
            const cards = document.getElementById('previewSummary').querySelectorAll('.summary-card-value');
            cards[0].textContent = formatNumber(totalSum) + ' ‚ÇΩ';
            cards[1].textContent = totalOrders;
            cards[2].textContent = formatNumber(totalFuel) + ' ‚ÇΩ';
            cards[3].textContent = formatNumber(totalTransport) + ' ‚ÇΩ';
        }
        
        // Step 3 -> Step 4: Finalize
        async function finalize() {
            goToStep(4);
            
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('config_json', JSON.stringify(getConfig()));
            formData.append('days_json', JSON.stringify(getDays()));
            formData.append('extra_rows_json', JSON.stringify(getExtras()));
            formData.append('deleted_rows_json', JSON.stringify([...deletedRows]));
            
            try {
                const response = await fetch('/calculate', { method: 'POST', body: formData });
                const data = await response.json();
                
                document.getElementById('finalizeLoading').classList.remove('active');
                
                if (data.success) {
                    document.getElementById('successSection').classList.remove('hidden');
                    document.getElementById('downloadLinkFull').href = data.download_url_full;
                    document.getElementById('downloadLinkWorkers').href = data.download_url_workers;
                    
                    // Show alarms
                    const alarms = data.alarms;
                    const hasAlarms = Object.values(alarms).some(arr => arr.length > 0);
                    
                    if (hasAlarms) {
                        document.getElementById('alarmsSection').classList.remove('hidden');
                        renderAlarms(alarms);
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    goToStep(3);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                goToStep(3);
            }
        }
        
        function renderAlarms(alarms) {
            let tabsHtml = '', contentHtml = '', firstActive = true;
            
            for (const [type, items] of Object.entries(alarms)) {
                if (items.length > 0) {
                    const activeClass = firstActive ? 'active' : '';
                    const typeClass = type.replace(/_/g, '-');
                    tabsHtml += `<div class="alarm-tab ${typeClass} ${activeClass}" onclick="showAlarmTab('${typeClass}')">${alarmTypeNames[type]} <span class="alarm-tab-count">${items.length}</span></div>`;
                    
                    let itemsHtml = '';
                    items.forEach(alarm => {
                        const sectionBadge = alarm.section === '–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º' 
                            ? '<span class="alarm-section-badge client">–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º</span>'
                            : '<span class="alarm-section-badge main">–æ—Å–Ω–æ–≤–Ω–∞—è</span>';
                        
                        let detailsHtml = '';
                        if (alarm.row_info) {
                            for (const [key, value] of Object.entries(alarm.row_info)) {
                                if (key !== '–°–µ–∫—Ü–∏—è') {
                                    detailsHtml += `<div class="alarm-detail"><span class="alarm-detail-label">${key}:</span> <span>${value}</span></div>`;
                                }
                            }
                        }
                        
                        itemsHtml += `<div class="alarm-item ${typeClass}"><div class="alarm-message">${alarm.message} ${sectionBadge}</div><div class="alarm-details">${detailsHtml}</div></div>`;
                    });
                    
                    contentHtml += `<div class="alarm-content ${activeClass}" id="alarm-content-${typeClass}">${itemsHtml}</div>`;
                    firstActive = false;
                }
            }
            
            document.getElementById('alarmsTabs').innerHTML = tabsHtml;
            document.getElementById('alarmsContent').innerHTML = contentHtml;
        }
        
        function showAlarmTab(type) {
            document.querySelectorAll('.alarm-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.alarm-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.alarm-tab.${type}`).classList.add('active');
            document.getElementById(`alarm-content-${type}`).classList.add('active');
        }
    </script>
</body>
</html>
