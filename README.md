# Salary Service — Автоматизированный расчёт зарплат монтажников

## Оглавление

1. [Обзор системы](#обзор-системы)
2. [Архитектура](#архитектура)
3. [Основные сущности](#основные-сущности)
4. [Бизнес-логика](#бизнес-логика)
5. [API Endpoints](#api-endpoints)
6. [База данных](#база-данных)
7. [Развёртывание](#развёртывание)

---

## Обзор системы

**Salary Service** — веб-приложение для автоматического расчёта зарплат монтажников компании Mos-GSM на основе данных из 1С.

### Основные возможности

- Загрузка Excel-файлов из 1С (выручка + диагностика)
- Автоматический расчёт оплаты услуг, бензина, транспортных
- Сравнение версий и отслеживание изменений
- Генерация Excel-отчётов для бухгалтерии и монтажников
- Ручные корректировки и доплаты
- Интеграция с Yandex Geocoder для расчёта бензина
- Интеграция с Яндекс Заправки для вычетов
- OAuth2 авторизация через Bitrix24
- Ролевая модель доступа (admin, manager, viewer)
- Workflow статусов периодов (DRAFT → SENT → PAID)

### Технологии

- **Backend**: Python 3.11, FastAPI, SQLAlchemy
- **Database**: PostgreSQL
- **Frontend**: HTML/CSS/JavaScript (vanilla)
- **Hosting**: Railway
- **Auth**: Bitrix24 OAuth2

---

## Архитектура

```
├── backend/
│   ├── app.py                 # Главный файл приложения (endpoints)
│   ├── database.py            # Модели БД и запросы
│   ├── auth.py                # OAuth2 Bitrix24
│   ├── permissions.py         # Ролевая модель
│   ├── config.py              # Конфигурация
│   ├── csrf_middleware.py     # CSRF защита
│   ├── api_status.py          # API статусов периодов
│   └── services/
│       ├── excel_parser.py    # Парсинг файлов 1С
│       ├── excel_report.py    # Генерация Excel-отчётов
│       ├── calculation.py     # Расчёт зарплат
│       ├── geocoding.py       # Yandex Geocoder
│       └── yandex_fuel_parser.py  # Парсинг Яндекс Заправки
│   └── utils/
│       ├── helpers.py         # Вспомогательные функции
│       └── workers.py         # Работа с именами монтажников
├── frontend/
│   └── templates/
│       ├── index.html         # Главная страница (загрузка)
│       ├── period.html        # Страница периода
│       └── upload.html        # (legacy)
├── Dockerfile
├── requirements.txt
└── docs/
    ├── README.md              # Этот файл
    ├── BUSINESS_LOGIC.md      # Бизнес-логика расчётов
    ├── DATABASE_SCHEMA.md     # Схема базы данных
    ├── API_REFERENCE.md       # Справочник API
    ├── WORKFLOW.md            # Воркфлоу и статусы
    └── DEPLOYMENT.md          # Инструкция по развёртыванию
```

---

## Основные сущности

### Период (Period)
Временной интервал для расчёта зарплаты. Формат: `DD-DD.MM.YY` (например, `16-30.11.25`).

- **Первая половина месяца**: 01-15
- **Вторая половина месяца**: 16-30/31 (или 16-28/29 для февраля)

### Загрузка (Upload)
Версия данных для периода. Каждая загрузка файлов создаёт новую версию.

### Заказ (Order)
Одна строка из файла 1С — выполненная работа монтажником.

### Расчёт (Calculation)
Результат расчёта для заказа: бензин, транспортные, итого.

### Монтажник (Worker)
Сотрудник, выполняющий заказы. Имена нормализуются для единообразия.

---

## Бизнес-логика

Подробное описание в файле [BUSINESS_LOGIC.md](./BUSINESS_LOGIC.md).

### Краткая формула расчёта

```
Итого = Оплата_услуг + Бензин + Транспортные - Яндекс_заправки

где:
- Оплата_услуг = Выручка_от_услуг × Процент
- Бензин = f(расстояние от офиса до адреса)
- Транспортные = 1000₽ (при выручке > 10000₽ и проценте 20-40%)
- Яндекс_заправки = Сумма × 0.9 (только для периодов 16-30/31)
```

---

## API Endpoints

Подробное описание в файле [API_REFERENCE.md](./API_REFERENCE.md).

### Основные endpoints

| Метод | URL | Описание |
|-------|-----|----------|
| POST | `/upload` | Загрузка файлов |
| GET | `/review` | Страница сравнения |
| POST | `/api/apply-review` | Применить изменения |
| POST | `/calculate` | Финальный расчёт |
| GET | `/api/periods` | Список периодов |
| GET | `/api/period/{id}` | Детали периода |
| GET | `/api/period/{id}/download/{type}` | Скачать архив |

---

## База данных

Подробное описание в файле [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md).

### Основные таблицы

- `periods` — периоды
- `uploads` — загрузки (версии)
- `orders` — заказы
- `calculations` — расчёты
- `worker_totals` — итоги по монтажникам
- `users` — пользователи
- `manual_edits` — ручные правки

---

## Развёртывание

Подробное описание в файле [DEPLOYMENT.md](./DEPLOYMENT.md).

### Переменные окружения

```env
DATABASE_URL=postgresql://...
BITRIX_CLIENT_ID=...
BITRIX_CLIENT_SECRET=...
BITRIX_DOMAIN=svyaz.bitrix24.ru
YANDEX_GEOCODER_API_KEY=...
```

### Команда запуска

```bash
uvicorn backend.app:app --host 0.0.0.0 --port 8000
```
