# Workflow и статусы

## Оглавление

1. [Статусы периодов](#статусы-периодов)
2. [Переходы между статусами](#переходы-между-статусами)
3. [Права доступа](#права-доступа)
4. [Уведомления](#уведомления)
5. [Flow загрузки файлов](#flow-загрузки-файлов)
6. [Flow сравнения версий](#flow-сравнения-версий)

---

## Статусы периодов

### DRAFT (Черновик)

**Описание**: Начальный статус. Период доступен для редактирования.

**Что можно делать**:
- ✅ Загружать новые файлы
- ✅ Редактировать данные
- ✅ Добавлять ручные корректировки
- ✅ Удалять заказы
- ✅ Пересчитывать

**Кто может изменить**: admin, manager

### SENT (Отправлено)

**Описание**: Данные отправлены на согласование/оплату.

**Что можно делать**:
- ⛔ Загружать новые файлы
- ⛔ Редактировать данные
- ✅ Просматривать
- ✅ Скачивать отчёты

**Кто может изменить**: admin

### PAID (Оплачено)

**Описание**: Финальный статус. Зарплаты выплачены.

**Что можно делать**:
- ⛔ Любые изменения
- ✅ Просматривать
- ✅ Скачивать отчёты

**Кто может изменить**: только admin (откат в SENT)

---

## Переходы между статусами

```
                    ┌─────────┐
                    │  DRAFT  │ ← Начальный статус
                    └────┬────┘
                         │
            [admin/manager: "Отправить"]
                         │
                         v
                    ┌─────────┐
                    │  SENT   │
                    └────┬────┘
                         │
               [admin: "Оплачено"]
                         │
                         v
                    ┌─────────┐
                    │  PAID   │ ← Финальный статус
                    └─────────┘
```

### Возможные переходы

| Из | В | Кто может | Условия |
|----|---|-----------|---------|
| DRAFT | SENT | admin, manager | Есть загрузки |
| SENT | DRAFT | admin | — |
| SENT | PAID | admin | — |
| PAID | SENT | admin | — |

### API для изменения статуса

```http
POST /api/period/{period_id}/status
Content-Type: application/json

{
    "status": "SENT"
}
```

---

## Права доступа

### Роли

| Роль | Описание |
|------|----------|
| admin | Полный доступ |
| manager | Загрузка и редактирование черновиков |
| viewer | Только просмотр |

### Матрица доступа

| Действие | admin | manager | viewer |
|----------|-------|---------|--------|
| Просмотр периодов | ✅ | ✅ | ✅ |
| Загрузка файлов | ✅ | ✅ (DRAFT) | ⛔ |
| Редактирование | ✅ | ✅ (DRAFT) | ⛔ |
| Смена статуса на SENT | ✅ | ✅ | ⛔ |
| Смена статуса на PAID | ✅ | ⛔ | ⛔ |
| Откат статуса | ✅ | ⛔ | ⛔ |
| Скачивание отчётов | ✅ | ✅ | ✅ |

### Определение роли

Роль определяется при первом входе через Bitrix24:

```python
def determine_role(bitrix_user):
    """Определяет роль пользователя по должности в Bitrix"""
    position = bitrix_user.get("WORK_POSITION", "").lower()
    
    if "директор" in position or "руководитель" in position:
        return "admin"
    elif "менеджер" in position or "бухгалтер" in position:
        return "manager"
    else:
        return "viewer"
```

---

## Уведомления

### Уведомления в Bitrix24

При смене статуса отправляются уведомления:

#### DRAFT → SENT

```
Кому: Бухгалтерия (группа в Bitrix)
Тема: Зарплаты за период {period} готовы к проверке
Текст: Пользователь {user} отправил зарплаты на согласование.
       Сумма: {total}₽
       Монтажников: {count}
```

#### SENT → PAID

```
Кому: Все монтажники
Тема: Зарплата за период {period} выплачена
Текст: Ваша зарплата за период {period} выплачена.
       Сумма: {worker_total}₽
```

### Реализация

```python
async def send_bitrix_notification(user_ids: list, message: str):
    """Отправляет уведомление через Bitrix24 REST API"""
    # POST https://{domain}/rest/im.notify
    pass
```

---

## Flow загрузки файлов

### Диаграмма

```
┌──────────────┐
│ Пользователь │
│загружает файлы│
└──────┬───────┘
       │
       v
┌──────────────┐     ┌──────────────┐
│ POST /upload │────>│ Парсинг      │
└──────────────┘     │ Excel файлов │
                     └──────┬───────┘
                            │
                            v
                     ┌──────────────┐
                     │ Определение  │
                     │ периода      │
                     └──────┬───────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              v                           v
       ┌──────────────┐           ┌──────────────┐
       │ Есть версия  │           │ Первая       │
       │ в БД?        │           │ загрузка     │
       └──────┬───────┘           └──────┬───────┘
              │ Да                       │
              v                          v
       ┌──────────────┐           ┌──────────────┐
       │ Сравнение    │           │ Расчёт и     │
       │ версий       │           │ сохранение   │
       └──────┬───────┘           └──────┬───────┘
              │                          │
              v                          v
       ┌──────────────┐           ┌──────────────┐
       │ Redirect на  │           │ Redirect на  │
       │ /review      │           │ /period/{id} │
       └──────────────┘           └──────────────┘
```

### Шаги

1. **Валидация файлов**
   - Проверка формата (xlsx)
   - Определение типа (выручка/диагностика/Яндекс Заправки)
   - Проверка обязательных колонок

2. **Парсинг**
   - Извлечение данных из Excel
   - Нормализация имён монтажников
   - Объединение выручки и диагностики

3. **Определение периода**
   - Извлечение из имени файла или данных
   - Формат: DD-DD.MM.YY

4. **Проверка существующих версий**
   - Поиск периода в БД
   - Если есть — переход к сравнению
   - Если нет — прямой расчёт

5. **Сохранение сессии**
   - Данные сохраняются в `session_data[session_id]`
   - TTL: 30 минут

---

## Flow сравнения версий

### Диаграмма

```
┌──────────────┐
│ /review      │
│ страница     │
└──────┬───────┘
       │
       v
┌──────────────────────────────────────────┐
│              Сравнение                   │
├──────────────┬───────────────┬───────────┤
│ + Новые      │ - Удалённые   │ ~ Изменённые│
│ заказы       │ заказы        │ заказы      │
│              │ + extra_rows  │             │
└──────┬───────┴───────┬───────┴──────┬─────┘
       │               │              │
       v               v              v
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ ☑ Добавить   │ │ ☑ Восстановить│ │ ☑ Применить  │
│ ☐ Пропустить │ │ ☐ Удалить    │ │ ☐ Откатить  │
└──────────────┘ └──────────────┘ └──────────────┘
       │               │              │
       └───────────────┼──────────────┘
                       │
                       v
              ┌──────────────┐
              │ POST         │
              │/api/apply-   │
              │ review       │
              └──────┬───────┘
                     │
                     v
              ┌──────────────┐
              │ Применение   │
              │ выбранных    │
              │ изменений    │
              └──────┬───────┘
                     │
                     v
              ┌──────────────┐
              │ Расчёт и     │
              │ сохранение   │
              │ в БД         │
              └──────┬───────┘
                     │
                     v
              ┌──────────────┐
              │ Redirect на  │
              │ /period/{id} │
              └──────────────┘
```

### Алгоритм сравнения

```python
def compare_versions(old_orders, new_orders, extra_rows):
    changes = {
        "added": [],      # Новые заказы
        "deleted": [],    # Удалённые заказы + extra_rows
        "modified": []    # Изменённые заказы
    }
    
    # Построение карт для сравнения
    old_map = {(o.order_code, o.worker): o for o in old_orders if not o.is_extra_row}
    new_map = {(n.order_code, n.worker): n for n in new_orders}
    
    # Новые = есть в new_map, нет в old_map
    for key, order in new_map.items():
        if key not in old_map:
            changes["added"].append(order)
    
    # Удалённые = есть в old_map, нет в new_map
    for key, order in old_map.items():
        if key not in new_map:
            changes["deleted"].append(order)
    
    # Extra rows всегда в "удалённых" (их нет в новых файлах)
    for extra in extra_rows:
        changes["deleted"].append(extra)
    
    # Изменённые = есть в обоих, но данные отличаются
    for key in old_map:
        if key in new_map:
            if has_changes(old_map[key], new_map[key]):
                changes["modified"].append({
                    "old": old_map[key],
                    "new": new_map[key]
                })
    
    return changes
```

### Действия пользователя

| Секция | Действие | Результат |
|--------|----------|-----------|
| Новые | Добавить | Заказ включается в новую версию |
| Новые | Пропустить | Заказ игнорируется |
| Удалённые | Восстановить | Заказ переносится из старой версии |
| Удалённые | Удалить | Заказ удаляется из новой версии |
| Изменённые | Применить новые | Используются данные из файла |
| Изменённые | Откатить | Используются данные из БД |
