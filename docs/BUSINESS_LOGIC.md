# Бизнес-логика расчёта зарплат

## Оглавление

1. [Входные данные](#входные-данные)
2. [Алгоритм расчёта](#алгоритм-расчёта)
3. [Расчёт оплаты услуг](#расчёт-оплаты-услуг)
4. [Расчёт бензина](#расчёт-бензина)
5. [Расчёт транспортных](#расчёт-транспортных)
6. [Яндекс Заправки](#яндекс-заправки)
7. [Диагностика -50%](#диагностика--50)
8. [Заказы с оплатой клиентом](#заказы-с-оплатой-клиентом)
9. [Ручные корректировки](#ручные-корректировки)
10. [Сравнение версий](#сравнение-версий)

---

## Входные данные

### Файлы из 1С

Система принимает **два Excel-файла**:

#### 1. Файл выручки
Содержит заказы с финансовыми данными:
- Монтажник (ФИО)
- Номер заказа (КАУТ-XXXXXX, ИБУТ-XXXXXX, ТДУТ-XXXXXX)
- Адрес
- Выручка итого
- Выручка от услуг
- Оплата диагностики
- Выезд специалиста
- Доп. расходы
- Оплата услуг
- Процент

#### 2. Файл диагностики
Содержит диагностические работы:
- Те же поля что и файл выручки
- Используется для расчёта "Диагностика -50%"

### Файл Яндекс Заправки (опционально)
**Обязателен для периодов 16-30/31** (вторая половина месяца).

Содержит:
- ФИО сотрудника
- Сумма заправок за месяц

---

## Алгоритм расчёта

### Общая формула

```
Итого_заказа = Оплата_услуг + Бензин + Транспортные

Итого_монтажника = Σ(Итого_заказов) - Диагностика_50% - Яндекс_заправки
```

### Последовательность обработки

1. **Парсинг файлов** → объединение выручки и диагностики
2. **Нормализация имён** → приведение к единому формату
3. **Расчёт для каждого заказа**:
   - Определение процента
   - Расчёт оплаты услуг
   - Расчёт бензина (через Yandex Geocoder)
   - Расчёт транспортных
   - Подсчёт итого
4. **Группировка по монтажникам**
5. **Вычет Яндекс Заправок** (для периодов 16-30)
6. **Генерация отчётов**

---

## Расчёт оплаты услуг

### Формула

```
Оплата_услуг = Выручка_от_услуг × (Процент / 100)
```

### Определение процента

Процент берётся из файла 1С. Типичные значения:
- **30%** — стандартный
- **20%** — пониженный (крупные заказы)
- **40%** — повышенный (сложные работы)
- **100%** — полная оплата (особые случаи)

### Особые случаи

1. **Выезд специалиста > 0**: Оплата услуг = 0 (монтажник получает только выезд)
2. **Процент = 0%**: Обычно означает ошибку в данных

---

## Расчёт бензина

### Условия начисления

Бензин начисляется если:
- `Выезд_специалиста = 0` (монтажник ехал сам)
- Адрес указан и валиден

### Алгоритм

1. Получить координаты адреса через Yandex Geocoder
2. Рассчитать расстояние от офиса (Сходненский тупик 16с4)
3. Применить тарифную сетку

### Тарифная сетка

```python
FUEL_TARIFFS = [
    (10, 100),    # до 10 км → 100₽
    (20, 200),    # до 20 км → 200₽
    (30, 300),    # до 30 км → 300₽
    (40, 400),    # до 40 км → 400₽
    (50, 500),    # до 50 км → 500₽
    (60, 600),    # до 60 км → 600₽
    (80, 900),    # до 80 км → 900₽
    (100, 1200),  # до 100 км → 1200₽
    (150, 1700),  # до 150 км → 1700₽
    (200, 2200),  # до 200 км → 2200₽
    (999, 3000),  # более 200 км → 3000₽
]
```

### Координаты офиса

```python
OFFICE_COORDS = (55.8309, 37.4294)  # Сходненский тупик 16с4, Москва
```

### Кэширование

Результаты геокодирования кэшируются в памяти для ускорения повторных запросов.

---

## Расчёт транспортных

### Условия начисления

Транспортные (1000₽) начисляются если:
- `Выручка_от_услуг > 10000₽`
- `20% ≤ Процент ≤ 40%`
- Монтажник **НЕ** на служебном авто

### Служебное авто

Список монтажников на служебном авто задаётся в конфигурации:

```python
COMPANY_CAR_WORKERS = [
    "Иванов Иван Иванович",
    # ...
]
```

Монтажники на служебном авто **не получают** транспортные.

### Конфигурация

```python
DEFAULT_CONFIG = {
    "transport_min_revenue": 10000,  # Минимальная выручка
    "transport_percent_min": 20,      # Минимальный процент
    "transport_percent_max": 40,      # Максимальный процент
    "transport_amount": 1000,         # Сумма транспортных
}
```

---

## Яндекс Заправки

### Описание

Компания оплачивает топливо сотрудникам через сервис Яндекс Заправки. Раз в месяц сумма заправок вычитается из зарплаты со скидкой 10%.

### Условия применения

- **Только для периодов 16-30/31** (вторая половина месяца)
- Файл Яндекс Заправки **обязателен** для таких периодов
- Для периодов 01-15 файл не требуется

### Формула вычета

```
Вычет = Сумма_заправок × 0.9
```

Пример: заправился на 10000₽ → вычет 9000₽ (экономия 1000₽)

### Определение периода

```python
def is_second_half_period(period: str) -> bool:
    """Проверяет, является ли период второй половиной месяца"""
    # period = "16-30.11.25" или "01-15.11.25"
    start_day = int(period.split("-")[0])
    return start_day >= 16
```

### Поддержка февраля

- Обычный год: 16-28.02.XX
- Високосный год: 16-29.02.XX

---

## Диагностика -50%

### Описание

Для заказов с **оплатой клиентом** диагностика оплачивается по ставке 50%.

### Формула

```
Диагностика_50% = Диагностика × 0.5
```

### Отображение в отчёте

- Показывается в отдельном столбце "Диагностика -50%"
- Вычитается из итого монтажника

---

## Заказы с оплатой клиентом

### Определение

Заказ считается "с оплатой клиентом" если:
- В названии монтажника есть "(оплата клиентом)"
- Или поле `is_client_payment = True`

### Особенности расчёта

1. **Бензин**: не начисляется
2. **Транспортные**: не начисляются
3. **Диагностика**: -50%

### Отображение в отчёте

- Группируются отдельно под основными заказами монтажника
- Заголовок: "Монтажник (оплата клиентом)"

---

## Ручные корректировки

### Типы корректировок

1. **Доплаты** — добавление суммы (положительная)
2. **Вычеты** — удержание суммы (отрицательная)

### Поля корректировки

```python
{
    "worker": "Иванов Иван Иванович",
    "description": "Отпускные",  # или "Ремонт авто (Кардан)"
    "amount": 39493,             # или -15362
    "is_extra_row": True
}
```

### Сохранение

- Корректировки сохраняются в БД с флагом `is_extra_row = True`
- При новой загрузке файлов система предлагает восстановить корректировки

### Восстановление при перезагрузке

Когда загружаются новые файлы 1С:
1. Система находит корректировки из предыдущей версии
2. Показывает их в секции "Удалённые / Ручные корректировки"
3. Пользователь может выбрать какие восстановить
4. Выбранные переносятся в новую версию

---

## Сравнение версий

### Алгоритм

При загрузке новых файлов система сравнивает с последней версией в БД:

1. **Новые заказы** — есть в файлах, нет в БД
2. **Удалённые заказы** — есть в БД, нет в файлах
3. **Изменённые заказы** — есть в обоих, но данные отличаются
4. **Ручные корректировки** — `is_extra_row = True` в БД, нет в файлах

### Ключ сравнения

```python
key = (order_code, worker_normalized)
# Пример: ("КАУТ-001405", "Фадин Сергей")
```

### Сравниваемые поля

- `revenue_total` — Выручка итого
- `revenue_services` — Выручка от услуг
- `diagnostic` — Диагностика
- `specialist_fee` — Выезд специалиста
- `additional_expenses` — Доп. расходы
- `service_payment` — Оплата услуг
- `percent` — Процент

### Порог изменения

- Числовые поля: разница > 0.01
- Бензин: разница > 250₽ (флуктуации Geocoder)
- Транспортные: любое изменение

### Обнаружение ручных правок

Система обнаруживает если итого в БД отличается от рассчитанного:

```python
expected_total = service_payment + fuel + transport
if abs(db_total - expected_total) > 0.01:
    # Была ручная правка
```
