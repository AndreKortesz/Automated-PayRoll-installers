# –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [Review –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è](#review-–Ω–µ-–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç-–≤—Å–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è)
2. [–ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ Excel](#–ø—É—Å—Ç—ã–µ-—è—á–µ–π–∫–∏-–≤-excel)
3. [–Ø–Ω–¥–µ–∫—Å –ó–∞–ø—Ä–∞–≤–∫–∏ –Ω–µ –≤—ã—á–∏—Ç–∞—é—Ç—Å—è](#—è–Ω–¥–µ–∫—Å-–∑–∞–ø—Ä–∞–≤–∫–∏-–Ω–µ-–≤—ã—á–∏—Ç–∞—é—Ç—Å—è)
4. [–ë–µ–Ω–∑–∏–Ω –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è](#–±–µ–Ω–∑–∏–Ω-–Ω–µ-—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
5. [OAuth –æ—à–∏–±–∫–∏](#oauth-–æ—à–∏–±–∫–∏)

---

## Review –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –°–∏–º–ø—Ç–æ–º—ã

- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å
- –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ (extra_rows) –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ "–£–¥–∞–ª—ë–Ω–Ω—ã—Ö"

### –ü—Ä–∏—á–∏–Ω—ã

1. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–µ–π, –∞ –Ω–µ —Å —Ç–æ–π —á—Ç–æ –æ–∂–∏–¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

2. **extra_rows –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ deleted** ‚Äî –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
üìä Found version X with Y orders     ‚Äî –° –∫–∞–∫–æ–π –≤–µ—Ä—Å–∏–µ–π —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è
üìã Total extra_rows found: X         ‚Äî –°–∫–æ–ª—å–∫–æ extra_rows –Ω–∞–π–¥–µ–Ω–æ
üìã DEBUG: extra_rows_from_prev has X ‚Äî –°–∫–æ–ª—å–∫–æ –¥–æ—à–ª–æ –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
üìã FINAL: changes_summary has X added, Y deleted (including Z extra_rows)
```

### –†–µ—à–µ–Ω–∏–µ

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–æ–¥ –≤ `app.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:

```python
# –ü–æ—Å–ª–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º extra_rows –≤ deleted
for extra in extra_rows_from_prev:
    changes_summary["deleted"].append({
        "order_code": extra.get("order_code") or extra.get("order_full", "")[:50],
        "worker": extra.get("worker", ""),
        "type": "extra_row",
        ...
    })
```

---

## –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ Excel

### –°–∏–º–ø—Ç–æ–º—ã

- –í –∫–æ–ª–æ–Ω–∫–µ "–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫" –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- –ê–¥—Ä–µ—Å –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

### –ü—Ä–∏—á–∏–Ω–∞

–ü–æ–ª–µ `order` –≤ app.py –Ω–µ –º–∞–ø–ø–∏—Ç—Å—è –Ω–∞ `order_full` –≤ database.py.

### –†–µ—à–µ–Ω–∏–µ

–í `database.py` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `save_order()`:

```python
async def save_order(upload_id: int, order_data: dict) -> int:
    # Map 'order' to 'order_full' (different names in app vs DB)
    if 'order' in order_data and 'order_full' not in order_data:
        order_data['order_full'] = order_data.pop('order')
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

### –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω–æ **–ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–∏–æ–¥** ‚Äî —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å –ø—É—Å—Ç—ã–º `order_full`.

---

## –Ø–Ω–¥–µ–∫—Å –ó–∞–ø—Ä–∞–≤–∫–∏ –Ω–µ –≤—ã—á–∏—Ç–∞—é—Ç—Å—è

### –°–∏–º–ø—Ç–æ–º—ã

- –ö–æ–ª–æ–Ω–∫–∞ "–Ø–Ω–¥–µ–∫—Å –∑–∞–ø—Ä–∞–≤–∫–∏" –≤ Excel –ø—É—Å—Ç–∞—è
- –ò—Ç–æ–≥–æ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –Ω–∞ —Å—É–º–º—É –∑–∞–ø—Ä–∞–≤–æ–∫

### –ü—Ä–∏—á–∏–Ω—ã

1. **–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ config_json** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ upload
2. **–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ config_json** –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
‚õΩ –Ø–Ω–¥–µ–∫—Å –ó–∞–ø—Ä–∞–≤–∫–∏: –ò–º—è -> –ò–º—è: X —Ä—É–±, –≤—ã—á–µ—Ç: Y —Ä—É–±
‚õΩ –Ø–Ω–¥–µ–∫—Å –ó–∞–ø—Ä–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: X –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–æ–≤
```

### –†–µ—à–µ–Ω–∏–µ

1. –í `apply_review_changes()` –¥–æ–±–∞–≤–∏—Ç—å yandex_fuel –≤ config:
```python
config = DEFAULT_CONFIG.copy()
yandex_fuel = session.get("yandex_fuel", {})
config["yandex_fuel"] = yandex_fuel
```

2. –ü—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å config –∏–∑ –ë–î:
```python
saved_config = latest_upload.get("config_json", {}) or {}
report_config = {**DEFAULT_CONFIG, **saved_config}
```

---

## –ë–µ–Ω–∑–∏–Ω –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

### –°–∏–º–ø—Ç–æ–º—ã

- –ö–æ–ª–æ–Ω–∫–∞ "–û–ø–ª–∞—Ç–∞ –±–µ–Ω–∑–∏–Ω–∞" –ø—É—Å—Ç–∞—è –∏–ª–∏ 0
- –ù–µ—Ç –ª–æ–≥–æ–≤ Yandex Geocoder

### –ü—Ä–∏—á–∏–Ω—ã

1. **–ù–µ—Ç API –∫–ª—é—á–∞ Yandex**
2. **–ê–¥—Ä–µ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è**
3. **–í—ã–µ–∑–¥ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ > 0** (–±–µ–Ω–∑–∏–Ω –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è)

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
üîç Yandex –∑–∞–ø—Ä–æ—Å: –∞–¥—Ä–µ—Å...
üîç Yandex –æ—Ç–≤–µ—Ç: HTTP 200
üìç Yandex OK: –∞–¥—Ä–µ—Å -> (lat, lon)
‚õΩ –ë–µ–Ω–∑–∏–Ω: –∞–¥—Ä–µ—Å -> X –∫–º -> Y —Ä—É–±
```

–ï—Å–ª–∏ –Ω–µ—Ç –ª–æ–≥–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `YANDEX_GEOCODER_API_KEY`.

### –†–µ—à–µ–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–ª—é—á –≤–∞–ª–∏–¥–µ–Ω (–Ω–µ –∏—Å—Ç—ë–∫ –ª–∏–º–∏—Ç)
3. –î–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å "–í—ã–µ–∑–¥ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞" > 0 –±–µ–Ω–∑–∏–Ω –ù–ï –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è (—ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)

---

## OAuth –æ—à–∏–±–∫–∏

### "Token exchange failed"

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–µ BITRIX_CLIENT_ID –∏–ª–∏ BITRIX_CLIENT_SECRET

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Bitrix24

### "Invalid redirect_uri"

**–ü—Ä–∏—á–∏–Ω–∞**: Callback URL –≤ Bitrix24 –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º

**–†–µ—à–µ–Ω–∏–µ**: –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Bitrix24 —É–∫–∞–∂–∏—Ç–µ:
```
https://automated-payroll-installers-production.up.railway.app/auth/callback
```

### "User not found"

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ

**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ. –ï—Å–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –ë–î.

---

## –û–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –æ—Ç–ª–∞–¥–∫–µ

### 1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏

Railway ‚Üí Your Service ‚Üí View Logs

### 2. –ò—â–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã

```
‚úÖ ‚Äî —É—Å–ø–µ—à–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
‚ö†Ô∏è ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
‚ùå ‚Äî –æ—à–∏–±–∫–∞
üìä ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
üìã ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏
‚õΩ ‚Äî —Ä–∞—Å—á—ë—Ç –±–µ–Ω–∑–∏–Ω–∞/—Ç–æ–ø–ª–∏–≤–∞
üîê ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```

### 3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–µ—Ä—Å–∏–∏

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ GitHub —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Railway –∑–∞–¥–µ–ø–ª–æ–∏–ª –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ Docker ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏ Redeploy

### 4. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–∏–æ–¥—ã

–ú–Ω–æ–≥–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:
1. –£–¥–∞–ª–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å)
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∑–∞–Ω–æ–≤–æ
3. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
