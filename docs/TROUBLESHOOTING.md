# Troubleshooting Guide - Salary Service

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: worker_totals –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—É–º–º—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–µ—Ä–∏–æ–¥–∞ company_amount = 0
- client_amount –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—É–º–º—É
- –ò—Ç–æ–≥–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π –∑–∞–∫–∞–∑–æ–≤

**–ü—Ä–∏—á–∏–Ω–∞:**
–ü–µ—Ä–µ—Å—á—ë—Ç worker_totals –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—Ñ—Ñ–∏–∫—Å–∞ "(–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º)" –≤ –∏–º–µ–Ω–∏ –≤–º–µ—Å—Ç–æ –ø–æ–ª—è `orders.is_client_payment`.

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–µ—Ä–∏–æ–¥–∞:
fetch('/api/upload/23/recalculate', {method: 'POST'})
  .then(r => r.json())
  .then(data => {
    console.log('–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ:', data);
    location.reload();
  })
```

–ò–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–µ –ø–æ–ª–µ —É –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî —ç—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –ø–µ—Ä–µ—Å—á—ë—Ç.

---

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ (foreign key)

**–°–∏–º–ø—Ç–æ–º—ã:**
```
asyncpg.exceptions.ForeignKeyViolationError: 
update or delete on table "calculations" violates foreign key constraint 
"manual_edits_calculation_id_fkey"
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–¢–∞–±–ª–∏—Ü–∞ `manual_edits` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `calculations.id`. –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å calculation –ø–æ–∫–∞ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ manual_edits.

**–†–µ—à–µ–Ω–∏–µ:**
–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚Äî —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
1. DELETE FROM manual_edits WHERE calculation_id = ?
2. DELETE FROM manual_edits WHERE order_id = ?
3. DELETE FROM calculations WHERE order_id = ?
4. DELETE FROM orders WHERE id = ?

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ Excel (–ë–∏—Ç—Ä–∏–∫—Å, Google Sheets)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í Excel –Ω–∞ Windows: —è—á–µ–π–∫–∏ –ø—É—Å—Ç—ã–µ –¥–æ –Ω–∞–∂–∞—Ç–∏—è "–†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
- –í –ë–∏—Ç—Ä–∏–∫—Å24: —è—á–µ–π–∫–∏ —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏ –ø—É—Å—Ç—ã–µ
- –í Google Sheets: #REF! –∏–ª–∏ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:**
openpyxl –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—ã (=SUM(...)), –Ω–æ –Ω–µ –≤—ã—á–∏—Å–ª—è–µ—Ç –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è. –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∏ –Ω–µ —É–º–µ—é—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã Excel.

**–†–µ—à–µ–Ω–∏–µ:**
–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚Äî —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ñ–æ—Ä–º—É–ª.

---

## üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–æ —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–∏–¥–Ω—ã
- –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–µ—Ä–∏–æ–¥–∞ ‚Äî —Å—Ç–∞—Ä—ã–µ —Å—É–º–º—ã

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π `focus` –∏ `pageshow` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç ‚Äî Ctrl+Shift+R (–∂—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞).

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–µ–Ω–∑–∏–Ω = 0 –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
- –í –ª–æ–≥–∞—Ö: "–ì–µ–æ–∫–æ–¥–∏–Ω–≥ FAILED"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Yandex API –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω
2. Nominatim rate limiting
3. –ê–¥—Ä–µ—Å –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á Yandex
- –ü–æ–¥–æ–∂–¥–∞—Ç—å (–ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∞–¥—Ä–µ—Å–∞ –≤ –∑–∞–∫–∞–∑–∞—Ö

---

### –ü—Ä–æ–±–ª–µ–º–∞: –†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –†–∞–±–æ—Ç–Ω–∏–∫ –µ—Å—Ç—å –≤ Excel, –Ω–æ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ

**–ü—Ä–∏—á–∏–Ω–∞:**
–ò–º—è –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é `is_valid_worker_name()`.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. –ú–∏–Ω–∏–º—É–º 2 —Å–ª–æ–≤–∞ (–§–∞–º–∏–ª–∏—è –ò–º—è)
2. –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã
3. –ù–µ –≤ —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–î–æ—Å—Ç–∞–≤–∫–∞, –ü–æ–º–æ—â–Ω–∏–∫, –ò—Ç–æ–≥–æ...)

---

## üü¢ –ú–µ–ª–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—ä–µ—Ö–∞–ª–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- –î–∞–Ω–Ω—ã–µ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö
- –ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–≥–ª—è–¥—è—Ç —Å–º–µ—â—ë–Ω–Ω—ã–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
–ñ—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞: Ctrl+Shift+R (–∏–ª–∏ Cmd+Shift+R –Ω–∞ Mac)

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–º–µ–Ω–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" –∏ "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" –∫–∞–∫ —Ä–∞–∑–Ω—ã–µ –ª—é–¥–∏

**–ü—Ä–∏—á–∏–Ω–∞:**
–í —Ä–∞–∑–Ω—ã—Ö Excel —Ñ–∞–π–ª–∞—Ö —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ. –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã.

---

## üõ†Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î (—á–µ—Ä–µ–∑ API)

```javascript
// –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
fetch('/api/upload/23/worker/–í–µ—Ç—Ä–µ–Ω–∫–æ%20–î–º–∏—Ç—Ä–∏–π')
  .then(r => r.json())
  .then(console.log)

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ worker_totals –ø–µ—Ä–∏–æ–¥–∞
fetch('/api/period/4')
  .then(r => r.json())
  .then(data => console.table(data.uploads[0].workers))
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Railway

–í Railway Dashboard ‚Üí Deployments ‚Üí View Logs

–ò—Å–∫–∞—Ç—å:
- `‚úÖ Updated calculation` ‚Äî —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `üóëÔ∏è Deleted order` ‚Äî —É—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- `üîÑ Recalculated` ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç worker_totals
- `‚ùå` –∏–ª–∏ `Traceback` ‚Äî –æ—à–∏–±–∫–∏

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

1. [ ] –ñ—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Ctrl+Shift+R)
2. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console)
3. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Railway
4. [ ] –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å `/api/upload/{id}/recalculate`
5. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
6. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è app.py

---

## üîÑ –ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ –∂–µ Excel —Ñ–∞–π–ª—ã –∑–∞–Ω–æ–≤–æ ‚Äî —Å–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å —á–∏—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ UI –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ –ë–î (–∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π)
–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –Ω–∞–ø—Ä—è–º—É—é.
